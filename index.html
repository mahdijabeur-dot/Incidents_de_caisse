<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formulaire de DÃ©claration de DiffÃ©rence de Caisse â€”  v3</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=IBM+Plex+Mono:wght@400;500&display=swap');

  :root {
    --navy:        #1F3864;
    --blue:        #2E75B6;
    --blue-light:  #EBF3FB;
    --blue-mid:    #D0E4F5;
    --red:         #C62828;
    --red-light:   #FFF5F5;
    --red-mid:     #FFCDD2;
    --green:       #1B5E20;
    --green-light: #F1F8E9;
    --green-mid:   #C8E6C9;
    --orange:      #E65100;
    --orange-light:#FFF8F0;
    --orange-mid:  #FFE0B2;
    --yellow:      #F57F17;
    --yellow-light:#FFFDE7;
    --gray-900:    #1A1A2E;
    --gray-700:    #374151;
    --gray-500:    #6B7280;
    --gray-300:    #D1D5DB;
    --gray-100:    #F9FAFB;
    --gray-50:     #FCFDFE;
    --white:       #FFFFFF;
    --font: 'IBM Plex Sans', sans-serif;
    --mono: 'IBM Plex Mono', monospace;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font);
    background: #F0F4F8;
    color: var(--gray-700);
    min-height: 100vh;
    padding: 20px;
    print-color-adjust: exact;
    -webkit-print-color-adjust: exact;
  }

  .page-wrapper { max-width: 900px; margin: 0 auto; }

  /* â”€â”€â”€ EN-TÃŠTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .form-header {
    background: var(--navy);
    border-radius: 12px 12px 0 0;
    padding: 0;
    overflow: hidden;
    position: relative;
  }
  .form-header::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 6px; height: 100%;
    background: linear-gradient(180deg, #4FC3F7 0%, #2E75B6 50%, #1A3A6B 100%);
  }
  .header-inner {
    padding: 24px 28px 20px 36px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
  }
  .form-title {
    font-size: 22px; font-weight: 700;
    color: var(--white); letter-spacing: -0.3px; line-height: 1.1;
  }
  .form-subtitle {
    font-size: 13px; font-weight: 400;
    color: #90CAF9; margin-top: 5px; letter-spacing: 0.2px;
  }
  .form-meta { font-size: 11px; color: #78909C; margin-top: 8px; }
  .header-right {
    display: flex; flex-direction: column;
    align-items: flex-end; gap: 8px; flex-shrink: 0;
  }
  .form-ref {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 6px; padding: 6px 14px; text-align: center;
  }
  .form-ref-label {
    font-size: 9px; color: #90CAF9; text-transform: uppercase;
    letter-spacing: 1px; display: block;
  }
  .form-ref-code {
    font-family: var(--mono); font-size: 13px;
    font-weight: 500; color: var(--white); display: block;
  }
  .logo-badge {
    width: 48px; height: 48px; background: var(--blue);
    border-radius: 50%; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    border: 2px solid rgba(255,255,255,0.2);
  }
  .logo-badge span:first-child { font-size: 14px; font-weight: 700; color: var(--white); line-height: 1; }
  .logo-badge span:last-child  { font-size: 7px; color: #90CAF9; letter-spacing: 1.5px; }
  .header-stripe {
    height: 4px;
    background: linear-gradient(90deg, var(--blue) 0%, #4FC3F7 60%, var(--blue) 100%);
  }

  /* â”€â”€â”€ BANDE NÂ° DÃ‰CLARATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .ref-bar {
    background: #EBF3FB;
    border-bottom: 1px solid var(--blue-mid);
    padding: 8px 24px;
    display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
  }
  .ref-bar-label { font-size: 10px; font-weight: 700; color: var(--blue); text-transform: uppercase; letter-spacing: 0.5px; }
  .ref-bar-value { font-family: var(--mono); font-size: 13px; font-weight: 600; color: var(--navy); }

  /* â”€â”€â”€ BANDE ALERTE NIVEAU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .alert-band {
    background: var(--blue-light);
    border-left: 4px solid var(--blue);
    border-right: 1px solid var(--blue-mid);
    padding: 14px 20px;
  }
  .alert-band-header {
    display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 8px; margin-bottom: 10px;
  }
  .alert-band-title {
    font-size: 10px; font-weight: 700; color: var(--blue);
    text-transform: uppercase; letter-spacing: 1px;
  }
  /* Barre de statut niveau */
  .niveau-status-bar {
    display: flex; align-items: center; gap: 7px;
    font-family: var(--mono); font-size: 10px; color: var(--gray-500);
  }
  .niveau-status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--gray-300); flex-shrink: 0;
    transition: background 0.3s;
  }
  .niveau-status-dot.auto   { background: var(--green-mid); }
  .niveau-status-dot.manual { background: var(--orange); }
  .niveau-status-dot.locked { background: var(--red); }
  .niveau-status-dot.empty  { background: var(--gray-300); }
  .niveau-status-text { font-size: 10px; }
  .niveau-calculated-badge {
    font-family: var(--mono); font-size: 9px; font-weight: 700;
    padding: 2px 7px; border-radius: 10px;
    background: rgba(0,0,0,0.08); color: var(--gray-600);
  }
  /* Grille niveau */
  .levels-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
  .level-card {
    border-radius: 8px; padding: 10px 12px;
    display: flex; align-items: flex-start; gap: 9px;
    border: 1.5px solid transparent; cursor: pointer;
    transition: all 0.15s ease; position: relative;
  }
  .level-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .level-card.lv1 { background: var(--green-light); border-color: var(--green-mid); }
  .level-card.lv2 { background: var(--yellow-light); border-color: #FFE082; }
  .level-card.lv3 { background: var(--orange-light); border-color: var(--orange-mid); }
  .level-card.lv4 { background: var(--red-light); border-color: var(--red-mid); }
  /* Ã‰tat actif (sÃ©lectionnÃ©) */
  .level-card.lv1.active { box-shadow: 0 0 0 2px var(--green); transform: translateY(-2px); }
  .level-card.lv2.active { box-shadow: 0 0 0 2px var(--yellow); transform: translateY(-2px); }
  .level-card.lv3.active { box-shadow: 0 0 0 2px var(--orange); transform: translateY(-2px); }
  .level-card.lv4.active { box-shadow: 0 0 0 2px var(--red); transform: translateY(-2px); }
  /* Niveau verrouillÃ© (rÃ©cidive) */
  .level-card.locked { opacity: 0.45; pointer-events: none; cursor: not-allowed; }
  .level-card.lv4.locked-active { box-shadow: 0 0 0 3px var(--red); transform: translateY(-2px); opacity: 1; pointer-events: none; }
  .level-card input[type="radio"] { display: none; }
  .level-check {
    width: 16px; height: 16px; border-radius: 50%; border: 2px solid;
    flex-shrink: 0; margin-top: 2px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; cursor: pointer;
  }
  .lv1 .level-check { border-color: var(--green); }
  .lv2 .level-check { border-color: var(--yellow); }
  .lv3 .level-check { border-color: var(--orange); }
  .lv4 .level-check { border-color: var(--red); }
  .level-card input[type="radio"]:checked + .level-check::after {
    content: ''; width: 8px; height: 8px; border-radius: 50%; display: block;
  }
  .lv1 input[type="radio"]:checked + .level-check::after { background: var(--green); }
  .lv2 input[type="radio"]:checked + .level-check::after { background: var(--yellow); }
  .lv3 input[type="radio"]:checked + .level-check::after { background: var(--orange); }
  .lv4 input[type="radio"]:checked + .level-check::after { background: var(--red); }
  .level-name { font-size: 11px; font-weight: 700; line-height: 1.2; }
  .lv1 .level-name { color: var(--green); }
  .lv2 .level-name { color: var(--yellow); }
  .lv3 .level-name { color: var(--orange); }
  .lv4 .level-name { color: var(--red); }
  .level-seuil { font-size: 10px; margin-top: 2px; color: var(--gray-500); font-family: var(--mono); }
  .level-desc  { font-size: 10px; color: var(--gray-500); margin-top: 2px; line-height: 1.3; }
  /* Tag AUTO sur la carte calculÃ©e */
  .level-auto-tag {
    position: absolute; top: 5px; right: 6px;
    font-family: var(--mono); font-size: 8px; font-weight: 700;
    background: rgba(0,0,0,0.12); color: rgba(0,0,0,0.5);
    padding: 1px 5px; border-radius: 4px; letter-spacing: 0.5px;
  }
  .level-lock-icon {
    position: absolute; top: 5px; right: 6px; font-size: 12px; cursor: default;
  }
  /* Alerte sous-classification â€” BLOQUANT */
  .niveau-downgrade-alert {
    display: flex; align-items: center; gap: 10px;
    margin-top: 10px; padding: 10px 14px;
    background: var(--red-light); border: 1.5px solid var(--red);
    border-radius: 8px; font-size: 12px;
    animation: alertShake 0.35s ease;
  }
  @keyframes alertShake {
    0%,100%{transform:translateX(0)}
    20%{transform:translateX(-4px)}
    40%{transform:translateX(4px)}
    60%{transform:translateX(-3px)}
    80%{transform:translateX(3px)}
  }
  .ndga-icon { font-size: 18px; flex-shrink: 0; }
  .ndga-body { flex: 1; color: var(--red); line-height: 1.4; }
  .ndga-body strong { display: block; font-size: 12px; font-weight: 700; }
  .ndga-body span { font-size: 11px; color: #7f1d1d; }
  .ndga-btn-restore {
    background: var(--red); color: var(--white); border: none;
    border-radius: 6px; padding: 6px 12px; cursor: pointer;
    font-family: var(--font); font-size: 11px; font-weight: 700;
    white-space: nowrap; flex-shrink: 0; transition: background 0.15s;
  }
  .ndga-btn-restore:hover { background: #b71c1c; }
  /* Avertissement sur-classification */
  .niveau-upgrade-warn {
    display: flex; align-items: flex-start; gap: 10px;
    margin-top: 10px; padding: 10px 14px;
    background: var(--orange-light); border: 1.5px solid var(--orange);
    border-radius: 8px; font-size: 12px;
  }
  .nugw-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
  .nugw-body { color: var(--orange); line-height: 1.5; }
  .nugw-body strong { display: block; font-size: 12px; font-weight: 700; }
  .nugw-body span { font-size: 11px; color: #6d2a00; }

  /* â”€â”€â”€ CORPS DU FORMULAIRE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .form-body { background: var(--white); padding: 0 0 28px; }

  /* â”€â”€â”€ SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section { margin: 0 24px; padding-top: 24px; }
  .section + .section { border-top: 1px solid var(--gray-100); }
  .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 18px; }
  .section-num {
    width: 26px; height: 26px; background: var(--navy);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; color: var(--white); flex-shrink: 0;
  }
  .section-title {
    font-size: 12px; font-weight: 700; color: var(--navy);
    text-transform: uppercase; letter-spacing: 0.8px;
  }

  /* â”€â”€â”€ GRID / CHAMPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .row { display: flex; gap: 14px; margin-bottom: 14px; flex-wrap: wrap; }
  .field { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 0; }
  .field.fixed-sm { flex: 0 0 90px; }
  .field.fixed-md { flex: 0 0 160px; }
  .field.fixed-lg { flex: 0 0 220px; }
  .field.full { flex: 0 0 100%; }
  .field.f2 { flex: 2; }
  .field.f3 { flex: 3; }

  .field-label {
    font-size: 10.5px; font-weight: 600; color: var(--gray-500);
    text-transform: uppercase; letter-spacing: 0.5px;
    display: flex; align-items: center; gap: 4px;
  }
  .required { color: var(--red); font-weight: 700; font-size: 12px; }
  .field-hint { font-size: 10px; color: var(--gray-300); font-style: italic; font-weight: 400; text-transform: none; letter-spacing: 0; }

  .field-input {
    height: 38px;
    border: 1.5px solid var(--gray-300);
    border-radius: 7px;
    padding: 0 12px;
    font-family: var(--font);
    font-size: 13px;
    color: var(--gray-900);
    background: var(--gray-50);
    outline: none;
    transition: all 0.15s ease;
    width: 100%;
  }
  .field-input:focus {
    border-color: var(--blue);
    background: var(--blue-light);
    box-shadow: 0 0 0 3px rgba(46,117,182,0.12);
  }
  .field-input.error { border-color: var(--red) !important; background: var(--red-light) !important; }
  .field-input::placeholder { color: var(--gray-300); font-size: 12px; }
  .field-input.mono { font-family: var(--mono); letter-spacing: 0.5px; }
  textarea.field-input { height: auto; min-height: 72px; padding: 10px 12px; resize: vertical; line-height: 1.6; }

  /* â”€â”€â”€ DATE PICKER CUSTOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .date-row  { display: flex; gap: 6px; align-items: center; }
  .date-part { display: flex; flex-direction: column; align-items: center; gap: 3px; }
  .date-part input {
    width: 54px; height: 38px; text-align: center;
    border: 1.5px solid var(--gray-300); border-radius: 7px;
    font-family: var(--mono); font-size: 14px; font-weight: 500;
    color: var(--gray-900); background: var(--gray-50); outline: none;
  }
  .date-part input:focus { border-color: var(--blue); background: var(--blue-light); }
  .date-part input.year { width: 72px; }
  .date-sep { font-size: 18px; font-weight: 300; color: var(--gray-300); margin-top: -14px; }
  .date-sublabel { font-size: 9px; color: var(--gray-300); text-transform: uppercase; letter-spacing: 0.5px; }
  .time-row { display: flex; gap: 6px; align-items: center; }
  .time-sep { font-size: 20px; font-weight: 700; color: var(--gray-500); margin-top: -16px; }

  /* â”€â”€â”€ MONTANT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .montant-block {
    background: var(--blue-light); border: 2px solid var(--blue);
    border-radius: 10px; padding: 14px 16px;
  }
  .montant-block .field-label { color: var(--blue); }
  .montant-row { display: flex; gap: 10px; align-items: flex-end; margin-top: 8px; }
  .montant-input-wrap { position: relative; flex: 1; }
  .montant-input-wrap input {
    height: 46px; font-family: var(--mono); font-size: 20px; font-weight: 700;
    letter-spacing: 1px; color: var(--navy); background: var(--white);
    border: 2px solid var(--blue); border-radius: 8px;
    padding: 0 50px 0 14px; width: 100%; outline: none;
  }
  .montant-input-wrap input:focus { box-shadow: 0 0 0 3px rgba(46,117,182,0.2); }
  .montant-currency {
    position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
    font-size: 13px; font-weight: 700; color: var(--blue);
  }
  .montant-millimes { display: flex; flex-direction: column; gap: 3px; flex-shrink: 0; }
  .montant-millimes input {
    width: 80px; height: 46px; text-align: center; font-family: var(--mono);
    font-size: 16px; font-weight: 600; color: var(--gray-700);
    border: 1.5px solid var(--gray-300); border-radius: 8px;
    background: var(--white); outline: none; padding: 0 8px;
  }
  .montant-millimes input:focus { border-color: var(--blue); background: var(--blue-light); }
  .montant-lettres-row { margin-top: 10px; }
  .montant-lettres-label {
    font-size: 9.5px; color: var(--blue); font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px;
    margin-bottom: 3px; display: block;
  }
  #montant-lettres {
    font-style: italic; color: var(--navy); font-weight: 500;
    height: 36px; width: 100%;
    border: 1.5px solid var(--blue-mid); border-radius: 7px;
    padding: 0 12px; font-family: var(--font); font-size: 12px;
    background: #f0f4ff; outline: none; cursor: default;
  }
  #montant-lettres::placeholder { font-style: italic; color: var(--gray-300); font-weight: 400; }
  #montant-lettres:focus { border-color: var(--blue); background: var(--blue-light); }

  /* â”€â”€â”€ NATURE Ã‰CART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .nature-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .nature-card {
    border-radius: 10px; padding: 14px 16px;
    display: flex; align-items: center; gap: 12px;
    border: 2px solid transparent; cursor: pointer;
    transition: all 0.15s ease;
  }
  .nature-card.manquant { background: var(--red-light); border-color: var(--red-mid); }
  .nature-card.excedent { background: var(--green-light); border-color: var(--green-mid); }
  .nature-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
  .nature-card input { display: none; }
  .nature-radio {
    width: 20px; height: 20px; border-radius: 50%; border: 2px solid;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.15s;
  }
  .nature-card.manquant .nature-radio { border-color: var(--red); }
  .nature-card.excedent .nature-radio { border-color: var(--green); }
  .nature-card input:checked + .nature-radio::after {
    content: ''; width: 10px; height: 10px; border-radius: 50%; display: block;
  }
  .nature-card.manquant input:checked + .nature-radio::after { background: var(--red); }
  .nature-card.excedent input:checked + .nature-radio::after { background: var(--green); }
  .nature-main { font-size: 13px; font-weight: 700; }
  .nature-card.manquant .nature-main { color: var(--red); }
  .nature-card.excedent .nature-main { color: var(--green); }
  .nature-sub { font-size: 11px; color: var(--gray-500); margin-top: 2px; }

  /* â”€â”€â”€ CHECKBOXES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .check-group { display: flex; flex-wrap: wrap; gap: 8px 16px; }
  .check-item {
    display: flex; align-items: center; gap: 7px; cursor: pointer;
    padding: 6px 10px; border-radius: 6px;
    border: 1.5px solid var(--gray-100); background: var(--gray-50);
    transition: all 0.12s; user-select: none;
  }
  .check-item:hover { border-color: var(--blue); background: var(--blue-light); }
  .check-item input { display: none; }
  .check-box {
    width: 16px; height: 16px; border-radius: 4px; border: 2px solid var(--gray-300);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.12s;
  }
  .check-item input:checked ~ .check-label { color: var(--navy); font-weight: 600; }
  .check-item input:checked + .check-box { background: var(--navy); border-color: var(--navy); }
  .check-item input:checked + .check-box::after {
    content: ''; width: 8px; height: 5px;
    border: 2px solid var(--white); border-top: none; border-right: none;
    transform: rotate(-45deg) translateY(-1px); display: block;
  }
  .check-label { font-size: 12px; color: var(--gray-700); }

  /* â”€â”€â”€ CAUSES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cause-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .cause-item {
    display: flex; align-items: center; gap: 7px; cursor: pointer;
    padding: 9px 11px; border-radius: 7px; border: 1.5px solid var(--gray-100);
    background: var(--gray-50); transition: all 0.12s; user-select: none;
  }
  .cause-item:hover { border-color: var(--blue); background: var(--blue-light); }
  .cause-item input { display: none; }
  .cause-item input:checked ~ .cause-text { color: var(--navy); font-weight: 600; }
  .cause-item input:checked + .check-box { background: var(--navy); border-color: var(--navy); }
  .cause-text { font-size: 11.5px; color: var(--gray-700); line-height: 1.3; }

  /* â”€â”€â”€ MESURES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .mesures-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

  /* â”€â”€â”€ RÃ‰CIDIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .recidive-block {
    background: var(--red-light);
    border: 1.5px solid var(--red-mid);
    border-left: 4px solid var(--red);
    border-radius: 8px; padding: 16px 18px; margin: 0 24px;
  }
  .recidive-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
  .recidive-num {
    width: 24px; height: 24px; background: var(--red);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: var(--white);
  }
  .recidive-title { font-size: 11px; font-weight: 700; color: var(--red); text-transform: uppercase; letter-spacing: 0.8px; }
  .recidive-content { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
  .recidive-question { font-size: 13px; color: var(--gray-700); flex: 1; }
  .radio-group { display: flex; gap: 12px; }
  .radio-item {
    display: flex; align-items: center; gap: 6px; cursor: pointer;
    padding: 7px 14px; border-radius: 6px; border: 1.5px solid var(--gray-300);
    background: var(--white); transition: all 0.12s; user-select: none;
  }
  .radio-item:hover { border-color: var(--red); }
  .radio-item input { display: none; }
  .radio-dot {
    width: 14px; height: 14px; border-radius: 50%;
    border: 2px solid var(--gray-300);
    display: flex; align-items: center; justify-content: center;
  }
  .radio-item input:checked + .radio-dot { border-color: var(--red); }
  .radio-item input:checked + .radio-dot::after {
    content: ''; width: 6px; height: 6px; border-radius: 50%; background: var(--red); display: block;
  }
  .radio-item input:checked ~ .radio-label { color: var(--red); font-weight: 600; }
  .radio-label { font-size: 13px; color: var(--gray-700); }
  .recidive-count { display: flex; align-items: center; gap: 8px; }
  .recidive-count label { font-size: 12px; color: var(--gray-500); white-space: nowrap; }
  .recidive-count input {
    width: 60px; height: 34px; text-align: center;
    border: 1.5px solid var(--gray-300); border-radius: 7px;
    font-family: var(--mono); font-size: 14px; font-weight: 600;
    background: var(--white); outline: none;
  }
  .recidive-count input:focus { border-color: var(--red); background: var(--red-light); }
  /* Masquer le compteur rÃ©cidive par dÃ©faut */
  #recidive-count-block { display: none; }
  #recidive-count-block.visible { display: flex; }

  /* â”€â”€â”€ SIGNATURES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .signatures-section { margin: 0 24px; padding-top: 24px; border-top: 1px solid var(--gray-100); }
  .sig-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 14px; }
  .sig-card { border: 1.5px solid var(--gray-300); border-radius: 10px; overflow: hidden; }
  .sig-header { background: var(--navy); padding: 10px 14px; text-align: center; }
  .sig-header.green-bg { background: #1B5E20; }
  .sig-title { font-size: 10px; font-weight: 700; color: var(--white); text-transform: uppercase; letter-spacing: 0.5px; }
  .sig-subtitle { font-size: 9px; color: #90CAF9; margin-top: 2px; }
  .sig-body { padding: 12px 14px; background: var(--gray-50); }
  .sig-field { margin-bottom: 10px; }
  .sig-field label { font-size: 10px; color: var(--gray-500); text-transform: uppercase; font-weight: 600; letter-spacing: 0.4px; display: block; margin-bottom: 4px; }
  .sig-field input {
    width: 100%; height: 32px; border: 1px solid var(--gray-300); border-radius: 6px;
    padding: 0 9px; font-family: var(--font); font-size: 12px;
    background: var(--white); outline: none; color: var(--gray-900);
  }
  .sig-field input:focus { border-color: var(--blue); background: var(--blue-light); }
  .sig-zone {
    border-top: 1px dashed var(--gray-300); margin-top: 6px; padding-top: 10px;
    min-height: 52px; display: flex; align-items: flex-end;
  }
  .sig-zone-label { font-size: 9px; color: var(--gray-300); text-transform: uppercase; letter-spacing: 0.5px; }

  /* â”€â”€â”€ BLOC CP CENTRAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cp-block {
    background: var(--blue-light); border: 1.5px solid var(--blue-mid);
    border-left: 4px solid var(--blue); border-radius: 8px;
    padding: 14px 18px; margin: 0 24px; margin-top: 14px;
  }
  .cp-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
  .cp-badge {
    background: var(--blue); color: var(--white); font-size: 9px; font-weight: 700;
    padding: 3px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .cp-title { font-size: 11px; font-weight: 600; color: var(--blue); }
  .cp-grid { display: flex; gap: 12px; flex-wrap: wrap; }
  .cp-field { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 100px; }
  .cp-field label { font-size: 10px; color: var(--blue); font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px; }
  .cp-field input {
    height: 32px; border: 1px solid var(--blue-mid); border-radius: 6px;
    padding: 0 9px; font-family: var(--font); font-size: 12px;
    background: var(--white); outline: none;
  }
  .cp-field input:focus { border-color: var(--blue); }

  /* â”€â”€â”€ PIED DE PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .form-footer {
    background: var(--gray-900); border-radius: 0 0 12px 12px;
    padding: 14px 28px; display: flex; justify-content: space-between;
    align-items: center; gap: 20px; flex-wrap: wrap;
  }
  .footer-ref { font-size: 11px; color: #90CAF9; font-family: var(--mono); margin-bottom: 4px; }
  .footer-note { font-size: 10.5px; color: #78909C; line-height: 1.5; }
  .footer-right { text-align: right; }
  .footer-required { display: flex; align-items: center; gap: 5px; justify-content: flex-end; margin-bottom: 5px; }
  .footer-required .required { font-size: 14px; }
  .footer-required span { font-size: 11px; color: #90CAF9; }
  .footer-urgence { font-size: 10.5px; color: #78909C; }

  /* â”€â”€â”€ BOUTONS D'ACTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .action-bar { display: flex; justify-content: flex-end; gap: 10px; padding: 16px 0 0; }
  .btn {
    padding: 10px 22px; border-radius: 8px; border: none;
    font-family: var(--font); font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
  }
  .btn-secondary { background: var(--gray-100); color: var(--gray-700); border: 1.5px solid var(--gray-300); }
  .btn-secondary:hover { background: var(--gray-300); }
  .btn-primary { background: var(--navy); color: var(--white); box-shadow: 0 2px 8px rgba(31,56,100,0.3); }
  .btn-primary:hover { background: var(--blue); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(31,56,100,0.35); }
  .btn-print { background: transparent; color: var(--navy); border: 1.5px solid var(--navy); }
  .btn-print:hover { background: var(--blue-light); }

  /* â”€â”€â”€ MODAL ENVOI MAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 1000;
    background: rgba(10,20,50,0.55); backdrop-filter: blur(3px);
    align-items: center; justify-content: center;
  }
  .modal-overlay.visible { display: flex; }
  .modal-box {
    background: var(--white); border-radius: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    width: 100%; max-width: 500px; overflow: hidden;
    animation: modalIn 0.25s ease;
  }
  @keyframes modalIn { from { opacity:0; transform: scale(0.93) translateY(10px); } to { opacity:1; transform: none; } }
  .modal-header {
    background: var(--navy); padding: 18px 22px;
    display: flex; align-items: center; gap: 12px;
  }
  .modal-icon {
    width: 38px; height: 38px; background: var(--blue); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
  }
  .modal-header-text {}
  .modal-title { font-size: 15px; font-weight: 700; color: var(--white); }
  .modal-subtitle { font-size: 11px; color: #90CAF9; margin-top: 2px; }
  .modal-body { padding: 22px 24px; }
  .modal-saved-badge {
    background: var(--green-light); border: 1px solid var(--green-mid);
    border-radius: 8px; padding: 10px 14px; margin-bottom: 18px;
    font-size: 12px; color: var(--green); font-weight: 600;
    display: flex; align-items: center; gap: 8px;
  }
  .modal-ref-line {
    background: var(--blue-light); border: 1px solid var(--blue-mid);
    border-radius: 8px; padding: 10px 14px; margin-bottom: 18px;
    font-size: 11px; color: var(--gray-700);
    display: flex; flex-wrap: wrap; gap: 14px;
  }
  .modal-ref-line span { color: var(--gray-500); }
  .modal-ref-line strong { font-family: var(--mono); color: var(--navy); font-size: 13px; }
  .modal-field { margin-bottom: 14px; }
  .modal-field label {
    display: block; font-size: 10.5px; font-weight: 700; color: var(--gray-500);
    text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;
  }
  .modal-field input, .modal-field textarea {
    width: 100%; border: 1.5px solid var(--gray-300); border-radius: 7px;
    padding: 0 12px; height: 38px; font-family: var(--font); font-size: 13px;
    color: var(--gray-900); background: var(--gray-50); outline: none; transition: all 0.15s;
  }
  .modal-field textarea { height: 70px; padding: 9px 12px; resize: vertical; line-height: 1.5; }
  .modal-field input:focus, .modal-field textarea:focus {
    border-color: var(--blue); background: var(--blue-light);
    box-shadow: 0 0 0 3px rgba(46,117,182,0.12);
  }
  .modal-field input.auto-filled { background: #EBF3FB; color: var(--navy); font-style: italic; }
  .cc-list { display: flex; flex-direction: column; gap: 6px; }
  .cc-row { display: flex; gap: 6px; }
  .cc-row input { flex: 1; }
  .btn-del-cc {
    width: 38px; height: 38px; border-radius: 7px;
    border: 1.5px solid var(--red-mid); background: var(--red-light);
    color: var(--red); font-size: 18px; cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; transition: all 0.12s;
  }
  .btn-del-cc:hover { background: var(--red-mid); }
  .btn-add-cc {
    margin-top: 5px; padding: 6px 14px; border-radius: 6px;
    border: 1.5px dashed var(--blue-mid); background: transparent;
    color: var(--blue); font-size: 11px; font-weight: 600;
    cursor: pointer; font-family: var(--font); transition: all 0.12s;
  }
  .btn-add-cc:hover { background: var(--blue-light); }
  .modal-send-status {
    padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: 600;
    margin-top: 12px; display: none; line-height: 1.5;
  }
  .modal-send-status.sending { background: var(--blue-light); color: var(--blue); border: 1px solid var(--blue-mid); display: flex; align-items: center; gap: 8px; }
  .modal-send-status.sent    { background: var(--green-light); color: var(--green); border: 1px solid var(--green-mid); display: flex; align-items: center; gap: 8px; }
  .modal-send-status.failed  { background: var(--red-light); color: var(--red); border: 1px solid var(--red-mid); display: flex; align-items: center; gap: 8px; }
  .spinner {
    width: 16px; height: 16px; border: 2.5px solid currentColor; border-top-color: transparent;
    border-radius: 50%; animation: spin 0.7s linear infinite; flex-shrink: 0;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .modal-footer {
    border-top: 1px solid var(--gray-100); padding: 14px 24px;
    display: flex; justify-content: flex-end; gap: 10px;
  }

  /* â”€â”€â”€ TOAST VALIDATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast {
    display: none; position: fixed; bottom: 30px; right: 30px; z-index: 9999;
    background: var(--red); color: var(--white); border-radius: 10px;
    padding: 14px 20px; font-size: 13px; font-weight: 500;
    box-shadow: 0 6px 24px rgba(0,0,0,0.2); max-width: 360px; line-height: 1.5;
  }
  .toast.success { background: var(--green); }
  .toast.visible { display: block; animation: slideIn 0.3s ease; }
  @keyframes slideIn { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

  /* â”€â”€â”€ SEPARATEUR SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-divider { height: 1px; background: var(--gray-100); margin: 0 24px; }

  /* â”€â”€â”€ BARRE DE PROGRESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .progress-bar-wrap {
    background: var(--gray-100); height: 5px; position: sticky; top: 0; z-index: 100;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }
  .progress-bar-fill {
    height: 100%; background: linear-gradient(90deg, var(--blue) 0%, #4FC3F7 100%);
    transition: width 0.4s ease; width: 0%;
  }
  .progress-label {
    position: absolute; right: 10px; top: -18px;
    font-size: 10px; font-weight: 700; color: var(--blue);
    font-family: var(--mono); opacity: 0.8;
  }

  /* â”€â”€â”€ AUTOSAVE INDICATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .autosave-dot {
    display: inline-block; width: 7px; height: 7px; border-radius: 50%;
    background: var(--gray-300); margin-left: 8px; vertical-align: middle;
    transition: background 0.3s;
  }
  .autosave-dot.saving { background: var(--yellow); animation: pulse 0.6s ease infinite alternate; }
  .autosave-dot.saved  { background: var(--green); }
  @keyframes pulse { from { opacity:1; } to { opacity:0.4; } }

  /* â”€â”€â”€ VALIDATION TEMPS RÃ‰EL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .field-input.valid { border-color: var(--green) !important; }
  .field-error-msg { font-size: 10px; color: var(--red); margin-top: 3px; display: none; }
  .field-input.error ~ .field-error-msg { display: block; }

  /* â”€â”€â”€ AGENCE BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .select-wrap { position: relative; }
  .select-wrap .select-arrow {
    position: absolute; right: 11px; top: 50%; transform: translateY(-50%);
    color: var(--blue); font-size: 11px; pointer-events: none;
  }
  .field-select {
    appearance: none; -webkit-appearance: none;
    cursor: pointer; padding-right: 30px;
    background: var(--gray-50); color: var(--gray-900);
  }
  .field-select:focus { border-color: var(--blue); background: var(--blue-light); box-shadow: 0 0 0 3px rgba(46,117,182,0.12); }
  .field-select option { font-family: var(--font); font-size: 13px; }
  .agence-badge {
    display: inline-flex; align-items: center; gap: 7px;
    background: var(--navy); color: white;
    padding: 4px 12px 4px 8px; border-radius: 20px;
    font-size: 11px; font-weight: 600; margin: 6px 0 0 0;
    opacity: 0; transition: all 0.25s; transform: translateY(5px);
  }
  .agence-badge.visible { opacity: 1; transform: translateY(0); }
  .agence-badge .badge-code { font-family: var(--mono); background: rgba(255,255,255,0.2); padding: 1px 7px; border-radius: 10px; margin-right: 2px; }

  /* â”€â”€â”€ PRINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media print {
    body { background: white; padding: 0; }
    .page-wrapper { max-width: 100%; }
    .action-bar, .toast { display: none; }
    .form-header, .form-footer { border-radius: 0; }
  }
</style>
</head>
<body>

<div class="page-wrapper">

  <!-- EN-TÃŠTE -->
  <div class="form-header">
    <div class="header-inner">
      <div class="header-left">
        <div class="form-title">FORMULAIRE DE DÃ‰CLARATION</div>
        <div class="form-subtitle">DiffÃ©rence de Caisse â€” RÃ©seau Agences</div>
        <div class="form-meta">Direction du ContrÃ´le Permanent &nbsp;|&nbsp; Usage Interne â€” Confidentiel</div>
      </div>
      <div class="header-right">
        <div class="logo-badge">
          <span></span>
          <span></span>
        </div>
        <div class="form-ref">
          <span class="form-ref-label">STB BANK</span>
          <span class="form-ref-code"></span>
        </div>
      </div>
    </div>
    <div class="header-stripe"></div>
  </div>

  <!-- BARRE DE PROGRESSION -->
  <div class="progress-bar-wrap" title="ComplÃ©tion du formulaire">
    <div class="progress-bar-fill" id="progress-fill"></div>
    <span class="progress-label" id="progress-label">0 %</span>
  </div>

  <!-- BARRE NÂ° DÃ‰CLARATION AUTO-GÃ‰NÃ‰RÃ‰ -->
  <div class="ref-bar">
    <span class="ref-bar-label">NÂ° DÃ©claration</span>
    <span class="ref-bar-value" id="ref-declaration">â€” en attente â€”</span>
    <span class="ref-bar-label" style="margin-left:24px;">Date de crÃ©ation</span>
    <span class="ref-bar-value" id="ref-date">â€”</span>
    <span class="autosave-dot" id="autosave-dot" title="Sauvegarde automatique"></span>
    <span style="font-size:10px; color:var(--gray-500); margin-left:2px;" id="autosave-label">Brouillon non sauvegardÃ©</span>
  </div>

  <!-- BANDE NIVEAU D'ALERTE -->
  <div class="alert-band" id="alert-band-wrap">
    <div class="alert-band-header">
      <div class="alert-band-title">âš  Niveau d'alerte BCT</div>
      <div class="niveau-status-bar">
        <span class="niveau-status-dot" id="niveau-status-dot"></span>
        <span class="niveau-status-text" id="niveau-status-text">Saisir le montant pour calcul automatique</span>
        <span class="niveau-calculated-badge" id="niveau-calc-badge" style="display:none"></span>
      </div>
    </div>

    <div class="levels-grid">
      <label class="level-card lv1" id="lv-card-1">
        <input type="radio" name="niveau" value="1" id="niveau1">
        <div class="level-check"></div>
        <div class="level-info">
          <div class="level-name">NIVEAU 1</div>
          <div class="level-seuil">&lt; 20 DT</div>
          <div class="level-desc">DÃ©claration interne agence</div>
        </div>
        <div class="level-auto-tag" id="lv-auto-1" style="display:none">AUTO</div>
      </label>
      <label class="level-card lv2" id="lv-card-2">
        <input type="radio" name="niveau" value="2" id="niveau2">
        <div class="level-check"></div>
        <div class="level-info">
          <div class="level-name">NIVEAU 2</div>
          <div class="level-seuil">20 â€” 200 DT</div>
          <div class="level-desc">Transmission CP Central</div>
        </div>
        <div class="level-auto-tag" id="lv-auto-2" style="display:none">AUTO</div>
      </label>
      <label class="level-card lv3" id="lv-card-3">
        <input type="radio" name="niveau" value="3" id="niveau3">
        <div class="level-check"></div>
        <div class="level-info">
          <div class="level-name">NIVEAU 3</div>
          <div class="level-seuil">200 â€” 1 000 DT</div>
          <div class="level-desc">Alerte CP â€” EnquÃªte systÃ©matique</div>
        </div>
        <div class="level-auto-tag" id="lv-auto-3" style="display:none">AUTO</div>
      </label>
      <label class="level-card lv4" id="lv-card-4">
        <input type="radio" name="niveau" value="4" id="niveau4">
        <div class="level-check"></div>
        <div class="level-info">
          <div class="level-name">NIVEAU 4</div>
          <div class="level-seuil">&gt; 1 000 DT / RÃ©cidive</div>
          <div class="level-desc">Alerte DG â€” Inspection</div>
        </div>
        <div class="level-auto-tag" id="lv-auto-4" style="display:none">AUTO</div>
        <div class="level-lock-icon" id="lv-lock-4" style="display:none" title="VerrouillÃ© â€” RÃ©cidive dÃ©tectÃ©e">ðŸ”’</div>
      </label>
    </div>

    <!-- Alerte de sous-classification (niveau manuel < niveau calculÃ©) -->
    <div class="niveau-downgrade-alert" id="niveau-downgrade-alert" style="display:none">
      <span class="ndga-icon">ðŸš«</span>
      <div class="ndga-body">
        <strong>Niveau infÃ©rieur au montant dÃ©clarÃ©</strong>
        <span id="niveau-downgrade-msg"></span>
      </div>
      <button type="button" class="ndga-btn-restore" onclick="restoreCalculatedNiveau()">Restaurer le niveau calculÃ©</button>
    </div>

    <!-- Avertissement de sur-classification (niveau manuel > niveau calculÃ©) -->
    <div class="niveau-upgrade-warn" id="niveau-upgrade-warn" style="display:none">
      <span class="nugw-icon">âš </span>
      <div class="nugw-body">
        <strong id="niveau-upgrade-title">Niveau supÃ©rieur au montant</strong>
        <span id="niveau-upgrade-msg"></span>
      </div>
    </div>

    <!-- Champ de justification (obligatoire si niveau â‰  niveau calculÃ©) -->
    <div id="niveau-justif-block" style="display:none;margin-top:10px;">
      <label class="field-label" for="niveau-justification">
        Justification de la modification du niveau
        <span class="required">*</span>
        <span class="field-hint">Obligatoire si le niveau sÃ©lectionnÃ© diffÃ¨re du niveau calculÃ© selon le montant</span>
      </label>
      <textarea id="niveau-justification" class="field-input"
        style="height:60px;resize:vertical;padding-top:8px;font-size:12px;"
        placeholder="Expliquer la raison de cette modification de niveau (ex : montant exact non encore connu, accord superviseurâ€¦)"></textarea>
    </div>
  </div>

  <div class="form-body">

    <!-- SECTION 1 : IDENTIFICATION AGENCE -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">1</div>
        <div class="section-title">Identification de l'Agence</div>
      </div>
      <div class="row">
        <div class="field fixed-md">
          <label class="field-label">Code Agence <span class="required">*</span></label>
          <div class="select-wrap">
            <select class="field-input field-select mono" id="sel-code" onchange="syncAgence('code')">
              <option value="">â€” Code â€”</option>
            </select>
            <span class="select-arrow">&#9660;</span>
          </div>
        </div>
        <div class="field f3">
          <label class="field-label">DÃ©signation de l'Agence <span class="required">*</span></label>
          <div class="select-wrap">
            <select class="field-input field-select" id="sel-nom" onchange="syncAgence('nom')">
              <option value="">â€” SÃ©lectionner l'agence â€”</option>
            </select>
            <span class="select-arrow">&#9660;</span>
          </div>
        </div>
        <div class="field f2">
          <label class="field-label">RÃ©gion / Direction RÃ©seau</label>
          <input class="field-input" id="region-input" type="text" placeholder="Ex : Grand Tunis, Sfax...">
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- SECTION 2 : IDENTIFICATION CAISSIER -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">2</div>
        <div class="section-title">Identification du Caissier DÃ©clarant</div>
      </div>
      <div class="row">
        <div class="field fixed-md">
          <label class="field-label">Matricule <span class="required">*</span></label>
          <input class="field-input mono" id="caissier-matricule" type="text" placeholder="MAT-0000" maxlength="12">
        </div>
        <div class="field f3">
          <label class="field-label">Nom et PrÃ©nom complets <span class="required">*</span></label>
          <input class="field-input" id="caissier-nom" type="text" placeholder="Nom de famille, PrÃ©nom(s)">
        </div>
        <div class="field f2">
          <label class="field-label">CatÃ©gorie / Grade</label>
          <input class="field-input" id="caissier-grade" type="text" placeholder="Ex : RÃ©dacteur, Cadre...">
        </div>
      </div>
      <div class="row">
        <div class="field full">
          <label class="field-label">Fonction exercÃ©e <span class="required">*</span></label>
          <div class="check-group">
            <label class="check-item">
              <input type="radio" name="fonction" value="Caissier Principal"><div class="check-box"></div>
              <span class="check-label">Caissier Principal</span>
            </label>
            <label class="check-item">
              <input type="radio" name="fonction" value="Caissier Adjoint"><div class="check-box"></div>
              <span class="check-label">Caissier Adjoint</span>
            </label>
            <label class="check-item">
              <input type="radio" name="fonction" value="Stagiaire Caissier"><div class="check-box"></div>
              <span class="check-label">Stagiaire Caissier</span>
            </label>
            <label class="check-item">
              <input type="radio" name="fonction" value="Autre"><div class="check-box"></div>
              <span class="check-label">Autre (prÃ©ciser)</span>
            </label>
            <input class="field-input" id="fonction-autre" style="flex:1; min-width:160px; height:36px;" type="text" placeholder="PrÃ©ciser si Autre...">
          </div>
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- SECTION 3 : DÃ‰TAILS DE L'Ã‰CART -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">3</div>
        <div class="section-title">DÃ©tails de l'Ã‰cart ConstatÃ©</div>
      </div>

      <!-- Date / Heures -->
      <div class="row">
        <div class="field">
          <label class="field-label">Date du Constat <span class="required">*</span></label>
          <div class="date-row">
            <div class="date-part">
              <input type="text" id="date-jour" placeholder="JJ" maxlength="2">
              <span class="date-sublabel">Jour</span>
            </div>
            <span class="date-sep">/</span>
            <div class="date-part">
              <input type="text" id="date-mois" placeholder="MM" maxlength="2">
              <span class="date-sublabel">Mois</span>
            </div>
            <span class="date-sep">/</span>
            <div class="date-part">
              <input type="text" id="date-annee" class="year" placeholder="AAAA" maxlength="4">
              <span class="date-sublabel">AnnÃ©e</span>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="field-label">Heure du Constat <span class="required">*</span></label>
          <div class="time-row">
            <div class="date-part">
              <input type="text" id="heure-hh" placeholder="HH" maxlength="2">
              <span class="date-sublabel">Heures</span>
            </div>
            <span class="time-sep">:</span>
            <div class="date-part">
              <input type="text" id="heure-mm" placeholder="MM" maxlength="2">
              <span class="date-sublabel">Minutes</span>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="field-label">Heure ArrÃªtÃ© de Caisse</label>
          <div class="time-row">
            <div class="date-part">
              <input type="text" id="arrete-hh" placeholder="HH" maxlength="2">
              <span class="date-sublabel">Heures</span>
            </div>
            <span class="time-sep">:</span>
            <div class="date-part">
              <input type="text" id="arrete-mm" placeholder="MM" maxlength="2">
              <span class="date-sublabel">Minutes</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Montant + Nature -->
      <div class="row" style="align-items: flex-start;">
        <div class="field f2">
          <div class="montant-block">
            <label class="field-label">Montant de l'Ã‰cart <span class="required">*</span></label>
            <div class="montant-row">
              <div class="montant-input-wrap">
                <input type="text" class="mono" placeholder="0" id="montant-chiffres">
                <span class="montant-currency">DT</span>
              </div>
              <div class="montant-millimes">
                <input type="text" class="mono" placeholder="000" maxlength="3" id="montant-millimes" title="Millimes">
                <span class="date-sublabel" style="text-align:center">Millimes</span>
              </div>
            </div>
            <div class="montant-lettres-row">
              <span class="montant-lettres-label">En toutes lettres</span>
              <input type="text" id="montant-lettres" placeholder="Montant en toutes lettres (dinars tunisiens)..." readonly>
            </div>
          </div>
        </div>
        <div class="field f2">
          <label class="field-label">Nature de l'Ã‰cart <span class="required">*</span></label>
          <div class="nature-grid">
            <label class="nature-card manquant">
              <input type="radio" name="nature" value="MANQUANT">
              <div class="nature-radio"></div>
              <div class="nature-label">
                <div class="nature-main">â–¼ MANQUANT</div>
                <div class="nature-sub">DÃ©ficit â€” Solde physique infÃ©rieur</div>
              </div>
            </label>
            <label class="nature-card excedent">
              <input type="radio" name="nature" value="EXCÃ‰DENT">
              <div class="nature-radio"></div>
              <div class="nature-label">
                <div class="nature-main">â–² EXCÃ‰DENT</div>
                <div class="nature-sub">Surplus â€” Solde physique supÃ©rieur</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Type de caisse -->
      <div class="row">
        <div class="field full">
          <label class="field-label">Type de Caisse ConcernÃ©e <span class="required">*</span></label>
          <div class="check-group">
            <label class="check-item">
              <input type="radio" name="type_caisse" value="Caisse DT Principale"><div class="check-box"></div>
              <span class="check-label">Caisse DT Principale</span>
            </label>
            <label class="check-item">
              <input type="radio" name="type_caisse" value="Caisse Devises"><div class="check-box"></div>
              <span class="check-label">Caisse Devises</span>
            </label>
            <label class="check-item">
              <input type="radio" name="type_caisse" value="Caisse GAB/DAB"><div class="check-box"></div>
              <span class="check-label">Caisse GAB / DAB</span>
            </label>
            <label class="check-item">
              <input type="radio" name="type_caisse" value="Caisse Secondaire"><div class="check-box"></div>
              <span class="check-label">Caisse Secondaire</span>
            </label>
            <label class="check-item">
              <input type="radio" name="type_caisse" value="Autre"><div class="check-box"></div>
              <span class="check-label">Autre</span>
            </label>
            <input class="field-input" id="caisse-autre" style="flex:1; min-width:160px; height:36px;" type="text" placeholder="PrÃ©ciser le type si Autre...">
          </div>
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- SECTION 4 : CIRCONSTANCES -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">4</div>
        <div class="section-title">Circonstances et Explications</div>
      </div>
      <div class="row">
        <div class="field full">
          <label class="field-label">A. DÃ©claration du Caissier <span class="required">*</span> <span class="field-hint">â€” Description circonstanciÃ©e des faits</span></label>
          <textarea class="field-input" id="declaration-caissier" rows="4" placeholder="DÃ©crire avec prÃ©cision les circonstances ayant pu causer l'Ã©cart : opÃ©rations effectuÃ©es, incidents survenus, observations particuliÃ¨res sur le dÃ©roulement de la journÃ©e..."></textarea>
        </div>
      </div>
      <div class="row">
        <div class="field full">
          <label class="field-label">B. Observations du Superviseur de Caisse <span class="required">*</span></label>
          <textarea class="field-input" id="observations-superviseur" rows="3" placeholder="Observations et commentaires du superviseur : rÃ©sultat du contre-comptage, cohÃ©rence des explications du caissier, anomalies constatÃ©es..."></textarea>
        </div>
      </div>
      <div class="row">
        <div class="field full">
          <label class="field-label">Cause Probable Retenue <span class="required">*</span></label>
          <div class="cause-grid">
            <label class="cause-item">
              <input type="checkbox" name="cause" value="Erreur de comptage"><div class="check-box"></div>
              <span class="cause-text">Erreur de comptage</span>
            </label>
            <label class="cause-item">
              <input type="checkbox" name="cause" value="Erreur de rendu monnaie"><div class="check-box"></div>
              <span class="cause-text">Erreur de rendu monnaie</span>
            </label>
            <label class="cause-item">
              <input type="checkbox" name="cause" value="Oubli d'encaissement"><div class="check-box"></div>
              <span class="cause-text">Oubli d'encaissement</span>
            </label>
            <label class="cause-item">
              <input type="checkbox" name="cause" value="DÃ©faillance systÃ¨me"><div class="check-box"></div>
              <span class="cause-text">DÃ©faillance systÃ¨me / informatique</span>
            </label>
            <label class="cause-item">
              <input type="checkbox" name="cause" value="Suspicion de fraude interne"><div class="check-box"></div>
              <span class="cause-text">Suspicion de fraude interne</span>
            </label>
            <label class="cause-item">
              <input type="checkbox" name="cause" value="Autre / Cause indÃ©terminÃ©e"><div class="check-box"></div>
              <span class="cause-text">Autre / Cause indÃ©terminÃ©e</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- SECTION 5 : MESURES IMMÃ‰DIATES -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">5</div>
        <div class="section-title">Mesures ImmÃ©diates Prises</div>
      </div>
      <div class="row">
        <div class="field full">
          <label class="field-label">Actions conservatoires engagÃ©es aprÃ¨s constat</label>
          <div class="mesures-grid">
            <label class="check-item">
              <input type="checkbox" name="mesure" value="Contre-comptage effectuÃ©"><div class="check-box"></div>
              <span class="check-label">Contre-comptage effectuÃ©</span>
            </label>
            <label class="check-item">
              <input type="checkbox" name="mesure" value="Isolement de la caisse"><div class="check-box"></div>
              <span class="check-label">Isolement de la caisse</span>
            </label>
            <label class="check-item">
              <input type="checkbox" name="mesure" value="Visionnage des camÃ©ras"><div class="check-box"></div>
              <span class="check-label">Visionnage des camÃ©ras</span>
            </label>
            <label class="check-item">
              <input type="checkbox" name="mesure" value="Entretien avec le caissier"><div class="check-box"></div>
              <span class="check-label">Entretien avec le caissier</span>
            </label>
            <label class="check-item">
              <input type="checkbox" name="mesure" value="Mise en suspens comptable"><div class="check-box"></div>
              <span class="check-label">Mise en suspens comptable</span>
            </label>
            <label class="check-item">
              <input type="checkbox" name="mesure" value="Information ContrÃ´le Permanent"><div class="check-box"></div>
              <span class="check-label">Information ContrÃ´le Permanent</span>
            </label>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="field full">
          <label class="field-label">Autres mesures / PrÃ©cisions complÃ©mentaires</label>
          <input class="field-input" id="autres-mesures" type="text" placeholder="DÃ©crire toute autre mesure prise...">
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- SECTION 6 : RÃ‰CIDIVE (intÃ©grÃ©e dans form-body) -->
    <div class="section" style="padding-bottom: 24px;">
      <div class="recidive-block">
        <div class="recidive-header">
          <div class="recidive-num">6</div>
          <div class="recidive-title">AntÃ©cÃ©dents et RÃ©cidive</div>
        </div>
        <div class="recidive-content">
          <div class="recidive-question">Ce caissier a-t-il fait l'objet d'Ã©carts dÃ©clarÃ©s au cours des <strong>30 derniers jours</strong> ?</div>
          <div class="radio-group">
            <label class="radio-item">
              <input type="radio" name="recidive" value="OUI" id="recidive-oui"><div class="radio-dot"></div>
              <span class="radio-label">OUI</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="recidive" value="NON" id="recidive-non"><div class="radio-dot"></div>
              <span class="radio-label">NON</span>
            </label>
          </div>
          <div class="recidive-count" id="recidive-count-block">
            <label for="nb-ecarts">Si OUI, nombre d'Ã©carts :</label>
            <input type="number" id="nb-ecarts" min="1" max="99" placeholder="â€”">
          </div>
        </div>
      </div>
    </div>

  </div><!-- fin form-body -->

  <!-- SECTION 7 : SIGNATURES -->
  <div class="signatures-section" style="background: var(--white);">
    <div class="section-header">
      <div class="section-num">7</div>
      <div class="section-title">Signatures et Validations Obligatoires</div>
    </div>
    <div class="sig-grid">
      <div class="sig-card">
        <div class="sig-header">
          <div class="sig-title">Caissier DÃ©clarant</div>
          <div class="sig-subtitle">Signature obligatoire</div>
        </div>
        <div class="sig-body">
          <div class="sig-field">
            <label>Nom & PrÃ©nom <span style="font-size:9px;color:#90CAF9;font-weight:400;text-transform:none;">(repris Â§2)</span></label>
            <input type="text" id="sig-caissier-nom" placeholder="Automatique â€” saisir Â§2">
          </div>
          <div class="sig-field">
            <label>Matricule <span style="font-size:9px;color:#90CAF9;font-weight:400;text-transform:none;">(repris Â§2)</span></label>
            <input type="text" id="sig-caissier-mat" placeholder="Automatique â€” saisir Â§2">
          </div>
          <div class="sig-field">
            <label>Date</label>
            <input type="text" id="sig-caissier-date" placeholder="JJ / MM / AAAA">
          </div>
          <div class="sig-zone">
            <span class="sig-zone-label">Signature</span>
          </div>
        </div>
      </div>
      <div class="sig-card">
        <div class="sig-header">
          <div class="sig-title">Superviseur de Caisse</div>
          <div class="sig-subtitle">Validation hiÃ©rarchique N+1</div>
        </div>
        <div class="sig-body">
          <div class="sig-field">
            <label>Nom & PrÃ©nom</label>
            <input type="text" id="sig-sup-nom" placeholder="Nom PrÃ©nom">
          </div>
          <div class="sig-field">
            <label>Matricule</label>
            <input type="text" id="sig-sup-mat" placeholder="MAT-0000" style="font-family: var(--mono);">
          </div>
          <div class="sig-field">
            <label>Date</label>
            <input type="text" id="sig-sup-date" placeholder="JJ / MM / AAAA">
          </div>
          <div class="sig-zone">
            <span class="sig-zone-label">Signature</span>
          </div>
        </div>
      </div>
      <div class="sig-card">
        <div class="sig-header green-bg">
          <div class="sig-title">Directeur d'Agence</div>
          <div class="sig-subtitle">Validation finale + Cachet</div>
        </div>
        <div class="sig-body">
          <div class="sig-field">
            <label>Nom & PrÃ©nom</label>
            <input type="text" id="sig-dir-nom" placeholder="Nom PrÃ©nom">
          </div>
          <div class="sig-field">
            <label>Date & Heure de rÃ©ception</label>
            <input type="text" id="sig-dir-date" placeholder="JJ/MM/AAAA â€” HH:MM">
          </div>
          <div class="sig-field">
            <label>DÃ©lai de transmission respectÃ© ?</label>
            <div class="radio-group" style="margin-top:2px;">
              <label class="radio-item" style="padding: 5px 10px;">
                <input type="radio" name="delai" value="Oui"><div class="radio-dot"></div>
                <span class="radio-label" style="font-size:11px;">Oui (&lt;1h)</span>
              </label>
              <label class="radio-item" style="padding: 5px 10px;">
                <input type="radio" name="delai" value="Non"><div class="radio-dot"></div>
                <span class="radio-label" style="font-size:11px;">Non (motif)</span>
              </label>
            </div>
          </div>
          <div class="sig-zone">
            <span class="sig-zone-label">Signature & Cachet</span>
          </div>
        </div>
      </div>
    </div>

    <!-- CP CENTRAL -->
    <div class="cp-block">
      <div class="cp-header">
        <span class="cp-badge">RÃ©servÃ© CP</span>
        <span class="cp-title">ContrÃ´le Permanent Central â€” RÃ©ception et Traitement</span>
      </div>
      <div class="cp-grid">
        <div class="cp-field">
          <label for="cp-recu-le">ReÃ§u le</label>
          <input type="text" id="cp-recu-le" placeholder="JJ/MM/AAAA â€” HH:MM">
        </div>
        <div class="cp-field" style="flex:2;">
          <label for="cp-traite-par">TraitÃ© par</label>
          <input type="text" id="cp-traite-par" placeholder="Nom du responsable CP">
        </div>
        <div class="cp-field">
          <label for="cp-ndossier">NÂ° Dossier CP</label>
          <input type="text" id="cp-ndossier" placeholder="CP-2025-000" style="font-family: var(--mono);">
        </div>
        <div class="cp-field">
          <label for="cp-statut">Statut</label>
          <input type="text" id="cp-statut" placeholder="En cours / ClÃ´turÃ©">
        </div>
      </div>
    </div>

    <!-- ACTION BAR -->
    <div class="action-bar">
      <button class="btn btn-secondary" id="btn-reset">â†º RÃ©initialiser</button>
      <button class="btn btn-print" onclick="window.print()">ðŸ–¨ Imprimer</button>
      <button class="btn btn-primary" id="btn-valider">âœ“ Valider et Transmettre</button>
    </div>
  </div>

  <!-- PIED DE PAGE -->
  <div class="form-footer">
    <div class="footer-left">
      <div class="footer-ref">  IdÃ©e et conception de Mahdi Ben Jabeur  </div>
      <div class="footer-note">
        3 exemplaires obligatoires : Agence (1)  Â·  ContrÃ´le Permanent (1)  Â·  Caissier (1)<br>
        Conservation rÃ©glementaire : 10 ans  |  Direction du ContrÃ´le Permanent
      </div>
    </div>
    <div class="footer-right">
      <div class="footer-required">
        <span class="required">*</span>
        <span>Champs obligatoires</span>
      </div>
      <div class="footer-urgence">Transmission au Directeur d'Agence dans l'heure</div>
    </div>
  </div>

</div><!-- fin page-wrapper -->

<!-- MODAL ENREGISTREMENT + ENVOI MAIL -->
<div class="modal-overlay" id="modal-envoi">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-icon">ðŸ“§</div>
      <div class="modal-header-text">
        <div class="modal-title">Enregistrement &amp; Transmission</div>
        <div class="modal-subtitle">DÃ©claration de DiffÃ©rence de Caisse â€” ContrÃ´le Permanent</div>
      </div>
    </div>
    <div class="modal-body">
      <!-- Confirmation enregistrement -->
      <div class="modal-saved-badge" id="modal-save-status">
        <span>âœ“</span> DÃ©claration enregistrÃ©e localement â€” RÃ©fÃ©rence : <strong id="modal-ref-num" style="font-family:var(--mono); margin-left:4px;"></strong>
      </div>
      <!-- RÃ©capitulatif -->
      <div class="modal-ref-line" id="modal-recap">
        <div><span>Agence :</span> <strong id="modal-agence">â€”</strong></div>
        <div><span>Montant :</span> <strong id="modal-montant">â€”</strong></div>
        <div><span>Nature :</span> <strong id="modal-nature">â€”</strong></div>
        <div><span>Niveau :</span> <strong id="modal-niveau">â€”</strong></div>
      </div>
      <!-- Destinataires -->
      <div class="modal-field">
        <label>Destinataire principal <span style="color:var(--red);">*</span> â€” ContrÃ´le Permanent</label>
        <input type="email" id="mail-to" placeholder="cp.central@banque.tn" class="auto-filled">
      </div>
      <div class="modal-field">
        <label>Copie Ã  (CC) <span style="font-weight:400; text-transform:none; color:var(--gray-300);">â€” Directeur d'agence, superviseurâ€¦</span></label>
        <div class="cc-list" id="cc-list">
          <div class="cc-row">
            <input type="email" placeholder="directeur.agence@banque.tn">
          </div>
        </div>
        <button class="btn-add-cc" id="btn-add-cc" type="button">+ Ajouter un destinataire CC</button>
      </div>
      <!-- Objet auto -->
      <div class="modal-field">
        <label>Objet du mail</label>
        <input type="text" id="mail-objet" class="auto-filled" readonly>
      </div>
      <!-- Message complÃ©mentaire -->
      <div class="modal-field">
        <label>Message complÃ©mentaire <span style="font-weight:400; text-transform:none; color:var(--gray-300);">â€” optionnel</span></label>
        <textarea id="mail-message" placeholder="Observations complÃ©mentaires Ã  joindre au mail..."></textarea>
      </div>
      <!-- Statut envoi -->
      <div class="modal-send-status" id="modal-send-status"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="btn-modal-fermer">Fermer</button>
      <button class="btn btn-print" onclick="window.print()" type="button">ðŸ–¨ Imprimer</button>
      <button class="btn btn-primary" id="btn-envoyer-mail">âœ‰ Envoyer par mail</button>
    </div>
  </div>
</div>

<!-- TOAST NOTIFICATION -->
<div class="toast" id="toast"></div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITAIRES COMMUNS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** Pad un nombre sur 2 chiffres â€” fonction centralisÃ©e (une seule dÃ©finition) */
const pad = n => String(n).padStart(2, '0');

/** AccÃ¨s sÃ©curisÃ© Ã  un Ã©lÃ©ment par ID */
const $id = id => document.getElementById(id);

/** AccÃ¨s sÃ©curisÃ© Ã  la valeur d'un Ã©lÃ©ment */
const $val = id => { const el = $id(id); return el ? el.value.trim() : ''; };

/** RÃ©cupÃ©rer la valeur d'un groupe radio */
const $radio = name => { const el = document.querySelector('input[name="' + name + '"]:checked'); return el ? el.value : ''; };

/** RÃ©cupÃ©rer les valeurs de checkboxes cochÃ©es */
const $checks = name => Array.from(document.querySelectorAll('input[name="' + name + '"]:checked')).map(el => el.value);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONVERSION MONTANT EN LETTRES â€” DINARS TUNISIENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const UNITES  = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf',
  'dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
const DIZAINES = ['', '', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante',
  'soixante', 'quatre-vingt', 'quatre-vingt'];

function dizerUnites(n) {
  if (n < 20) return UNITES[n];
  const d = Math.floor(n / 10), u = n % 10;
  if (d === 7) return u === 1 ? 'soixante et onze' : 'soixante-' + UNITES[10 + u];
  if (d === 9) return 'quatre-vingt-' + UNITES[10 + u];
  if (d === 8) return u === 0 ? 'quatre-vingts' : 'quatre-vingt-' + UNITES[u];
  if (u === 0) return DIZAINES[d];
  if (u === 1 && d !== 8) return DIZAINES[d] + ' et un';
  return DIZAINES[d] + '-' + UNITES[u];
}

function centaines(n) {
  if (n === 0) return '';
  const c = Math.floor(n / 100), r = n % 100;
  let s = '';
  if (c === 1) { s = 'cent'; }
  else if (c > 1) { s = UNITES[c] + ' cent'; if (r === 0) s += 's'; }
  if (r > 0) { if (c > 0) s += ' '; s += dizerUnites(r); }
  return s;
}

function nombreEnLettres(n) {
  if (n === 0) return 'zÃ©ro';
  if (n < 0)  return 'moins ' + nombreEnLettres(-n);
  let res = '';
  const milliards = Math.floor(n / 1e9); n %= 1e9;
  if (milliards > 0) res += centaines(milliards) + ' milliard' + (milliards > 1 ? 's' : '') + ' ';
  const millions = Math.floor(n / 1e6); n %= 1e6;
  if (millions > 0) res += centaines(millions) + ' million' + (millions > 1 ? 's' : '') + ' ';
  const milliers = Math.floor(n / 1000); n %= 1000;
  if (milliers > 0) res += (milliers === 1 ? 'mille' : centaines(milliers) + ' mille') + ' ';
  if (n > 0) res += centaines(n);
  return res.trim();
}

function updateLettres() {
  const chiffresInput = $id('montant-chiffres');
  const millimesInput = $id('montant-millimes');
  const lettresInput  = $id('montant-lettres');
  if (!lettresInput) return;

  const rawDT = chiffresInput ? chiffresInput.value.replace(/[^0-9]/g, '') : '';
  const rawMM = millimesInput ? millimesInput.value.replace(/[^0-9]/g, '').padEnd(3,'0').slice(0,3) : '';
  const dt = parseInt(rawDT) || 0;
  const mm = parseInt(rawMM) || 0;

  if (dt === 0 && mm === 0) { lettresInput.value = ''; return; }

  let lettres = '';
  if (dt > 0) lettres += nombreEnLettres(dt) + ' dinar' + (dt > 1 ? 's' : '');
  if (mm > 0) {
    if (dt > 0) lettres += ' et ';
    lettres += nombreEnLettres(mm) + ' millime' + (mm > 1 ? 's' : '');
  }
  lettresInput.value = lettres.charAt(0).toUpperCase() + lettres.slice(1);

  // Auto-sÃ©lection niveau d'alerte selon montant DT
  autoSelectNiveau(dt);
  updateProgressBar();
}

// â”€â”€â”€ FIX : millimes â€” suppression de l'inline handler â”€â”€â”€â”€
function onMillimesInput(el) {
  el.value = el.value.replace(/[^0-9]/g, '').slice(0, 3);
  updateLettres();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTRÃ”LE DU NIVEAU D'ALERTE â€” Logique complÃ¨te
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// niveauCalcule  : niveau dÃ©duit du montant (source de vÃ©ritÃ©)
// niveauManuel   : niveau cliquÃ© par l'utilisateur
// niveauVerrouille : true si rÃ©cidive OUI â†’ forcÃ© N4
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let niveauCalcule   = 0;   // 0 = pas encore calculÃ© (montant vide)
let niveauVerrouille = false;  // true = rÃ©cidive OUI

const NIVEAU_LABELS = {
  1: 'Niveau 1 â€” < 20 DT',
  2: 'Niveau 2 â€” 20 Ã  200 DT',
  3: 'Niveau 3 â€” 200 Ã  1 000 DT',
  4: 'Niveau 4 â€” > 1 000 DT',
};

// â”€â”€ Calculer le niveau selon le montant DT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcNiveauDepuisMontant(montantDT) {
  if (montantDT <= 0)           return 0;
  if (montantDT < 20)           return 1;
  if (montantDT < 200)          return 2;
  if (montantDT <= 1000)        return 3;
  return 4;
}

// â”€â”€ SÃ©lection automatique (depuis updateLettres) â”€â”€â”€â”€â”€â”€â”€â”€â”€
function autoSelectNiveau(montantDT) {
  niveauCalcule = calcNiveauDepuisMontant(montantDT);

  // Afficher l'indicateur de niveau calculÃ©
  for (let i = 1; i <= 4; i++) {
    const tag = $id('lv-auto-' + i);
    if (tag) tag.style.display = (i === niveauCalcule) ? '' : 'none';
  }

  // Si verrouillÃ© par rÃ©cidive, ne pas toucher Ã  la sÃ©lection
  if (niveauVerrouille) {
    updateNiveauStatusBar();
    return;
  }

  // SÃ©lectionner automatiquement si le montant est connu
  if (niveauCalcule > 0) {
    const radio = $id('niveau' + niveauCalcule);
    if (radio) {
      radio.checked = true;
      updateLevelCards();
    }
  }

  updateNiveauStatusBar();
  checkNiveauCoherence();
}

// â”€â”€ AppelÃ©e quand l'utilisateur clique manuellement â”€â”€â”€â”€â”€â”€
function onNiveauManualChange(selectedVal) {
  if (niveauVerrouille) return; // ignorÃ© si verrouillÃ©

  updateLevelCards();
  updateNiveauStatusBar();
  checkNiveauCoherence();
  updateProgressBar();
  autoSaveBrouillon();
}

// â”€â”€ VÃ©rification de cohÃ©rence niveau vs montant â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkNiveauCoherence() {
  const downAlert   = $id('niveau-downgrade-alert');
  const upWarn      = $id('niveau-upgrade-warn');
  const justifBlock = $id('niveau-justif-block');
  if (!downAlert || !upWarn || !justifBlock) return;

  const checkedRadio = document.querySelector('input[name="niveau"]:checked');
  const niveauSelectionne = checkedRadio ? parseInt(checkedRadio.value) : 0;

  // Pas de contrÃ´le si montant pas encore saisi ou verrouillÃ©
  if (niveauCalcule === 0 || niveauVerrouille) {
    downAlert.style.display   = 'none';
    upWarn.style.display      = 'none';
    justifBlock.style.display = 'none';
    return;
  }

  if (niveauSelectionne === niveauCalcule) {
    // âœ… CohÃ©rent â€” tout masquer
    downAlert.style.display   = 'none';
    upWarn.style.display      = 'none';
    justifBlock.style.display = 'none';
    return;
  }

  if (niveauSelectionne < niveauCalcule) {
    // ðŸš« SOUS-CLASSIFICATION â€” Bloquant
    downAlert.style.display = '';
    upWarn.style.display    = 'none';
    // RÃ©initialiser l'animation
    downAlert.style.animation = 'none';
    void downAlert.offsetWidth; // Reflow
    downAlert.style.animation = 'alertShake 0.35s ease';

    $id('niveau-downgrade-msg').textContent =
      ` Le montant de ${$val('montant-chiffres') || 'â€”'} DT impose le ${NIVEAU_LABELS[niveauCalcule]}. ` +
      `Vous avez sÃ©lectionnÃ© ${NIVEAU_LABELS[niveauSelectionne]} â€” cette classification n'est pas autorisÃ©e.`;

    // Justification obligatoire (pour trace d'audit)
    justifBlock.style.display = '';
    $id('niveau-justification').setAttribute('required', 'required');

  } else if (niveauSelectionne > niveauCalcule) {
    // âš  SUR-CLASSIFICATION â€” AutorisÃ© avec avertissement
    downAlert.style.display = 'none';
    upWarn.style.display    = '';

    $id('niveau-upgrade-title').textContent =
      `${NIVEAU_LABELS[niveauSelectionne]} â€” Niveau supÃ©rieur au montant`;
    $id('niveau-upgrade-msg').textContent =
      `Le montant de ${$val('montant-chiffres') || 'â€”'} DT correspond au ${NIVEAU_LABELS[niveauCalcule]}. ` +
      `Vous choisissez un niveau plus Ã©levÃ© â€” une justification est requise.`;

    // Justification obligatoire
    justifBlock.style.display = '';
    $id('niveau-justification').setAttribute('required', 'required');
  }
}

// â”€â”€ Mise Ã  jour de la barre de statut â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateNiveauStatusBar() {
  const dot    = $id('niveau-status-dot');
  const text   = $id('niveau-status-text');
  const badge  = $id('niveau-calc-badge');
  if (!dot || !text) return;

  const checkedRadio      = document.querySelector('input[name="niveau"]:checked');
  const niveauSelectionne = checkedRadio ? parseInt(checkedRadio.value) : 0;

  if (niveauVerrouille) {
    dot.className   = 'niveau-status-dot locked';
    text.textContent = 'ðŸ”’ Niveau 4 verrouillÃ© â€” RÃ©cidive dÃ©tectÃ©e';
    badge.style.display = 'none';
  } else if (niveauCalcule === 0) {
    dot.className   = 'niveau-status-dot empty';
    text.textContent = 'Saisir le montant pour calcul automatique';
    badge.style.display = 'none';
  } else if (niveauSelectionne === niveauCalcule) {
    dot.className   = 'niveau-status-dot auto';
    text.textContent = 'Niveau calculÃ© automatiquement selon le montant';
    badge.style.display = '';
    badge.textContent   = NIVEAU_LABELS[niveauCalcule];
  } else if (niveauSelectionne !== niveauCalcule) {
    dot.className   = 'niveau-status-dot manual';
    text.textContent = `Niveau modifiÃ© manuellement`;
    badge.style.display = '';
    badge.textContent   = `CalculÃ© : ${NIVEAU_LABELS[niveauCalcule]} â†’ SÃ©lectionnÃ© : N${niveauSelectionne}`;
  }
}

// â”€â”€ Restaurer le niveau calculÃ© (bouton "Restaurer") â”€â”€â”€â”€â”€
function restoreCalculatedNiveau() {
  if (niveauCalcule > 0) {
    const radio = $id('niveau' + niveauCalcule);
    if (radio) { radio.checked = true; }
    updateLevelCards();
    updateNiveauStatusBar();
    checkNiveauCoherence();
    const justifTA = $id('niveau-justification');
    if (justifTA) justifTA.value = '';
    updateProgressBar();
  }
}

// â”€â”€ updateLevelCards (conservÃ©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateLevelCards() {
  for (let i = 1; i <= 4; i++) {
    const card  = $id('lv-card-' + i);
    const radio = $id('niveau' + i);
    if (!card || !radio) continue;
    card.classList.remove('active', 'locked', 'locked-active');
    if (niveauVerrouille) {
      if (i === 4) card.classList.add('locked-active');
      else         card.classList.add('locked');
    } else {
      if (radio.checked) card.classList.add('active');
    }
  }
}

// â”€â”€ Verrouillage N4 rÃ©cidive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function verrouillerNiveau4Recidive(actif) {
  niveauVerrouille = actif;
  const lockIcon = $id('lv-lock-4');
  if (lockIcon) lockIcon.style.display = actif ? '' : 'none';

  for (let i = 1; i <= 4; i++) {
    const radio = $id('niveau' + i);
    if (radio) radio.disabled = actif && i !== 4;
  }

  if (actif) {
    const r4 = $id('niveau4');
    if (r4) { r4.checked = true; r4.disabled = false; }
    // Masquer tag AUTO des autres niveaux
    for (let i = 1; i <= 4; i++) {
      const tag = $id('lv-auto-' + i);
      if (tag) tag.style.display = 'none';
    }
    // Masquer alertes de cohÃ©rence (N4 est obligatoire)
    const downAlert   = $id('niveau-downgrade-alert');
    const upWarn      = $id('niveau-upgrade-warn');
    const justifBlock = $id('niveau-justif-block');
    if (downAlert)   downAlert.style.display   = 'none';
    if (upWarn)      upWarn.style.display      = 'none';
    if (justifBlock) justifBlock.style.display = 'none';
  } else {
    // RÃ©activer et recalculer
    for (let i = 1; i <= 4; i++) {
      const radio = $id('niveau' + i);
      if (radio) radio.disabled = false;
    }
    autoSelectNiveau(parseInt($val('montant-chiffres').replace(/[^0-9]/g,'')) || 0);
  }
  updateLevelCards();
  updateNiveauStatusBar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LISTE DES AGENCES (donnÃ©es de rÃ©fÃ©rence)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AGENCES = [
  { code: "000", nom: "AV.H.THAMEUR TUNIS" },
  { code: "001", nom: "R.AL JAZIRA TUNIS" },
  { code: "002", nom: "SOUSSE" },
  { code: "003", nom: "MAHDIA" },
  { code: "004", nom: "AV.H.CHAKER SFAX" },
  { code: "005", nom: "TUNIS PORT" },
  { code: "006", nom: "DAR CHAABANE ELFEHRI" },
  { code: "007", nom: "GABES" },
  { code: "008", nom: "BEJA" },
  { code: "009", nom: "KAIROUAN" },
  { code: "010", nom: "LE KEF" },
  { code: "011", nom: "BIZERTE" },
  { code: "012", nom: "TEBOURBA" },
  { code: "013", nom: "GROMBALIA" },
  { code: "014", nom: "RADES" },
  { code: "015", nom: "MENZEL BOURGUIBA" },
  { code: "016", nom: "JENDOUBA" },
  { code: "017", nom: "MONASTIR" },
  { code: "018", nom: "MOKNINE" },
  { code: "019", nom: "KSAR HELLAL" },
  { code: "020", nom: "ZARZIS" },
  { code: "021", nom: "GAFSA" },
  { code: "022", nom: "MANAR III" },
  { code: "023", nom: "KASSERINE" },
  { code: "025", nom: "JERBA" },
  { code: "026", nom: "HAJEB EL AYOUN" },
  { code: "027", nom: "EL OUARDANINE" },
  { code: "028", nom: "MEDENINE" },
  { code: "029", nom: "HAMMAMET" },
  { code: "030", nom: "BEN GARDANE" },
  { code: "031", nom: "NABEUL" },
  { code: "032", nom: "KORBA" },
  { code: "033", nom: "KELIBIA" },
  { code: "034", nom: "BAB SOUIKA" },
  { code: "035", nom: "R.K.PACHA TUNIS" },
  { code: "036", nom: "MEDINA TUNIS" },
  { code: "037", nom: "CITE MAHRAJ.MENZAH" },
  { code: "038", nom: "SFAX ZITOUNA" },
  { code: "039", nom: "SFAX HACHED" },
  { code: "040", nom: "M SAKEN" },
  { code: "041", nom: "EL-JEM" },
  { code: "042", nom: "JEMMAL" },
  { code: "043", nom: "PL.VICTOIRE TUNIS" },
  { code: "044", nom: "SIDI BOUZID" },
  { code: "045", nom: "AV.DE FRANCE TUNIS" },
  { code: "046", nom: "LE KEF II" },
  { code: "047", nom: "SFAX MENZEL CHAKER" },
  { code: "048", nom: "TATAOUINE" },
  { code: "049", nom: "MENZEL TEMIME" },
  { code: "050", nom: "METLAOUI" },
  { code: "051", nom: "KALAA KEBIRA" },
  { code: "052", nom: "CITE EZZOUHOUR" },
  { code: "053", nom: "CHEBBA" },
  { code: "054", nom: "ZAGHOUAN" },
  { code: "055", nom: "EL FAHS" },
  { code: "056", nom: "ARIANA" },
  { code: "057", nom: "CITE OLYMPIQUE" },
  { code: "058", nom: "HOUMET SOUK JERBA" },
  { code: "059", nom: "AV.J.JAURES TUNIS" },
  { code: "060", nom: "GARE TUNIS" },
  { code: "061", nom: "SILIANA" },
  { code: "062", nom: "R.PALESTINE TUNIS" },
  { code: "063", nom: "JEBENIANA" },
  { code: "064", nom: "SOUSSE EL KANTAOUI" },
  { code: "065", nom: "SOLIMAN" },
  { code: "066", nom: "KHAZNADAR" },
  { code: "067", nom: "AIN-DRAHAM" },
  { code: "068", nom: "SKHIRA" },
  { code: "069", nom: "SEDJENANE" },
  { code: "070", nom: "RAS JEBEL" },
  { code: "071", nom: "TABARKA" },
  { code: "072", nom: "BIZERTE MEDINA" },
  { code: "073", nom: "FERIANA" },
  { code: "074", nom: "MATEUR" },
  { code: "075", nom: "SAKIET SIDI YOUSSEF" },
  { code: "076", nom: "KALAAT SENANE" },
  { code: "077", nom: "EL MANAR" },
  { code: "078", nom: "MONASTIR II" },
  { code: "079", nom: "TROCADERO (SOUSSE NR)" },
  { code: "080", nom: "ENFIDHA" },
  { code: "081", nom: "CITE ETTADHAMEN" },
  { code: "082", nom: "FOUCHANA" },
  { code: "083", nom: "JELMA" },
  { code: "084", nom: "BOUSALEM" },
  { code: "085", nom: "HAOUARIA" },
  { code: "086", nom: "KSIBET EL MEDIOUNI" },
  { code: "087", nom: "BEN AROUS" },
  { code: "088", nom: "SFAX MOULINVILLE" },
  { code: "089", nom: "SOUSSE REPUBLIQUE" },
  { code: "100", nom: "AGENCE CENTRALE A. MATHARI" },
  { code: "101", nom: "KEBILI" },
  { code: "102", nom: "JERBA MIDOUN" },
  { code: "103", nom: "MARETH" },
  { code: "104", nom: "SFAX PORT" },
  { code: "105", nom: "NABEUL II" },
  { code: "106", nom: "AKOUDA" },
  { code: "107", nom: "LA CHARGUIA" },
  { code: "108", nom: "LE BELVEDERE" },
  { code: "109", nom: "BENI KHALLED" },
  { code: "110", nom: "AEROPORT TUNIS-CARTH" },
  { code: "112", nom: "HAMMAM SOUSSE" },
  { code: "113", nom: "HAMMAMET ETTAHRIR" },
  { code: "114", nom: "SFAX JEDIDA" },
  { code: "115", nom: "GABES-CENTER" },
  { code: "116", nom: "AFRICA" },
  { code: "118", nom: "EL MOUANSA ZARZIS" },
  { code: "119", nom: "EL MOUROUJ" },
  { code: "120", nom: "DOUZ" },
  { code: "121", nom: "OUED ELLIL" },
  { code: "122", nom: "NEFZA" },
  { code: "123", nom: "MSAKEN II" },
  { code: "124", nom: "CITE DES SCIENCES" },
  { code: "125", nom: "AV. MOHAMED V" },
  { code: "126", nom: "EL HRAIRIA" },
  { code: "127", nom: "HAMMAMET SUD" },
  { code: "128", nom: "MENZEL KAMEL MOUNAS" },
  { code: "129", nom: "LA MARSA" },
  { code: "130", nom: "KERKENNAH" },
  { code: "131", nom: "LAOUINA" },
  { code: "132", nom: "SIDI ALOUENE" },
  { code: "133", nom: "AGENCE SOUSSE INES" },
  { code: "134", nom: "AGENCE MOKTHAR ATTIA" },
  { code: "135", nom: "AGENCE LAC II" },
  { code: "136", nom: "HAMMAMET MEDINA" },
  { code: "137", nom: "SFAX TYNA" },
  { code: "138", nom: "SFAX CHIHIA" },
  { code: "139", nom: "EZZAHRA" },
  { code: "140", nom: "GAFSA II" },
  { code: "141", nom: "SOUKRA" },
  { code: "142", nom: "ENNASR" },
  { code: "143", nom: "SFAX EL AFRAN" },
  { code: "144", nom: "CHENINI GABES" },
  { code: "145", nom: "BENI KHEDACHE" },
  { code: "146", nom: "REDAYEF" },
  { code: "147", nom: "BIZERTE CORNICHE" },
  { code: "148", nom: "JERBA EL MAY" },
  { code: "149", nom: "MREZGUA" },
  { code: "150", nom: "JENDOUBA NORD" },
  { code: "151", nom: "TEBOULBA" },
  { code: "152", nom: "SOUSSE ERRIADH" },
  { code: "153", nom: "RIADH EL ANDALOUS" },
  { code: "154", nom: "AGENCE KALAA EL KEBIRA" },
  { code: "155", nom: "SAKIET EDDAIER" },
  { code: "156", nom: "SBEITLA" },
  { code: "157", nom: "TESTOUR" },
  { code: "158", nom: "MANOUBA" },
  { code: "159", nom: "MGHIRA" },
  { code: "160", nom: "JERBA HOUMET SOUK 2" },
  { code: "161", nom: "SFAX POUDRIERE" },
  { code: "162", nom: "EL HAMMA" },
  { code: "163", nom: "MNIHLA" },
  { code: "164", nom: "JARDINS DE CARTHAGE" },
];

// â”€â”€â”€ RÃ‰GIONS (doublons corrigÃ©s â€” chaque agence dans une seule rÃ©gion) â”€â”€â”€â”€â”€
const REGIONS = {
  "Grand Tunis":        ["000","001","005","034","035","036","037","043","045","052","056","057","059","060","062","066","077","081","082","087","107","108","110","116","119","121","124","125","126","129","131","135","139","141","142","153","158","159","163","164"],
  "Nabeul / Cap Bon":   ["006","013","029","031","032","033","049","065","085","105","109","113","127","136","149"],
  "Sousse":             ["002","017","018","019","040","051","053","064","079","086","089","106","112","123","133","152","154"],
  "Sfax":               ["004","038","039","047","063","088","104","114","130","137","138","143","155","161"],
  "GabÃ¨s":              ["007","068","103","115","144","162"],
  "Mahdia":             ["003","041","151"],
  "Monastir":           ["027","042","078","128"],
  "Bizerte":            ["011","015","069","070","071","072","074","084","122","147"],
  "Kairouan":           ["009","026","083"],
  "Gafsa":              ["021","050","073","140","146"],
  "Kasserine / Le Kef": ["010","023","044","046","076","156"],
  "MÃ©denine / Jerba":   ["020","025","028","030","048","058","101","102","118","120","145","148","160"],
  "Jendouba / BÃ©ja":    ["008","016","067","075","150","157"],
  "Siliana / Zaghouan": ["054","055","061"],
};

// Index inversÃ© pour lookup O(1)
const AGENCE_REGION_MAP = {};
Object.entries(REGIONS).forEach(([region, codes]) => {
  codes.forEach(code => { AGENCE_REGION_MAP[code] = region; });
});

function getRegionForCode(code) {
  return AGENCE_REGION_MAP[code] || '';
}

// â”€â”€â”€ POPULATION DES SELECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateSelects() {
  const selCode = $id('sel-code');
  const selNom  = $id('sel-nom');
  if (!selCode || !selNom) return;

  const sortedByCode = [...AGENCES].sort((a, b) => a.code.localeCompare(b.code));
  const sortedByNom  = [...AGENCES].sort((a, b) => a.nom.localeCompare(b.nom, 'fr'));

  const fragCode = document.createDocumentFragment();
  sortedByCode.forEach(ag => {
    const opt = document.createElement('option');
    opt.value = ag.code;
    opt.textContent = ag.code + ' \u2014 ' + ag.nom;
    fragCode.appendChild(opt);
  });
  selCode.appendChild(fragCode);

  const fragNom = document.createDocumentFragment();
  sortedByNom.forEach(ag => {
    const opt = document.createElement('option');
    opt.value = ag.code;
    opt.textContent = ag.nom;
    fragNom.appendChild(opt);
  });
  selNom.appendChild(fragNom);
}

function syncAgence(source) {
  const selCode = $id('sel-code');
  const selNom  = $id('sel-nom');
  if (!selCode || !selNom) return;
  const val = source === 'code' ? selCode.value : selNom.value;

  if (!val) {
    selCode.value = '';
    selNom.value  = '';
    updateBadge(null);
    return;
  }
  const ag = AGENCES.find(a => a.code === val);
  if (!ag) return;

  selCode.value = ag.code;
  selNom.value  = ag.code;
  updateBadge(ag);

  // Auto-remplir rÃ©gion
  const regionInput = $id('region-input');
  if (regionInput) regionInput.value = getRegionForCode(ag.code);

  // Enrichir le NÂ° dÃ©claration avec le code agence
  updateRefWithAgence(ag.code);
  updateProgressBar();
}

function updateBadge(ag) {
  let badge = $id('agence-badge');
  if (!badge) {
    badge = document.createElement('div');
    badge.id = 'agence-badge';
    badge.className = 'agence-badge';
    $id('sel-nom').closest('.row').insertAdjacentElement('afterend', badge);
  }
  if (!ag) { badge.classList.remove('visible'); return; }
  badge.innerHTML = '<span class="badge-code">' + ag.code + '</span> ' + ag.nom +
    ' <span style="opacity:0.5;margin-left:6px;font-weight:400;">&#10003; SÃ©lectionnÃ©e</span>';
  badge.classList.add('visible');
}

// Enrichir le NÂ° dÃ©claration avec le code agence pour garantir l'unicitÃ©
function updateRefWithAgence(codeAgence) {
  const refEl = $id('ref-declaration');
  if (!refEl) return;
  const current = refEl.textContent;
  if (!current || current.includes('en attente')) return;
  const parts = current.split('-AG');
  refEl.textContent = parts[0] + '-AG' + codeAgence;
}

// â”€â”€â”€ TOAST NOTIFICATION â€” FIX: innerHTML pour les sauts de ligne â”€â”€
function showToast(msg, type = 'error') {
  const toast = $id('toast');
  if (!toast) return;
  // Convertir \n en <br> pour l'affichage HTML
  toast.innerHTML = msg.replace(/\n/g, '<br>');
  toast.className = 'toast ' + (type === 'success' ? 'success' : '') + ' visible';
  clearTimeout(toast._hideTimer);
  toast._hideTimer = setTimeout(() => { toast.classList.remove('visible'); }, 5000);
}

// â”€â”€â”€ VALIDATION COMPLÃˆTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function validerFormulaire() {
  const erreurs = [];

  // Enlever les styles d'erreur prÃ©cÃ©dents
  document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

  // â”€â”€ Niveau d'alerte â€” validation renforcÃ©e â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const niveauCheck = document.querySelector('input[name="niveau"]:checked');
  if (!niveauCheck) {
    erreurs.push('Niveau d\'alerte non sÃ©lectionnÃ©.');
  } else {
    const niveauSel = parseInt(niveauCheck.value);

    // Bloquer la sous-classification (niveau < niveau calculÃ©)
    if (!niveauVerrouille && niveauCalcule > 0 && niveauSel < niveauCalcule) {
      erreurs.push(
        `Niveau d'alerte incorrect : le montant dÃ©clarÃ© impose le ${NIVEAU_LABELS[niveauCalcule]}. ` +
        `Vous avez sÃ©lectionnÃ© N${niveauSel} â€” impossible de soumettre avec un niveau infÃ©rieur au montant.`
      );
      // Mettre en Ã©vidence la carte incorrecte
      const badCard = $id('lv-card-' + niveauSel);
      if (badCard) badCard.style.outline = '2px solid var(--red)';
    }

    // Justification obligatoire si niveau â‰  calculÃ© (et montant connu)
    if (!niveauVerrouille && niveauCalcule > 0 && niveauSel !== niveauCalcule) {
      const justif = $id('niveau-justification');
      if (!justif || !justif.value.trim()) {
        erreurs.push('Justification de la modification du niveau d\'alerte obligatoire.');
        if (justif) justif.classList.add('error');
      }
    }
  }

  // Section 1 : Agence
  const selCode = $id('sel-code');
  if (!selCode || !selCode.value) {
    erreurs.push('Code Agence obligatoire (Section 1).');
    if (selCode) selCode.classList.add('error');
  }

  // Section 2 : Caissier
  const matricule   = $id('caissier-matricule');
  const nomCaissier = $id('caissier-nom');
  if (!matricule || !matricule.value.trim()) {
    erreurs.push('Matricule du caissier obligatoire (Section 2).');
    if (matricule) matricule.classList.add('error');
  }
  if (!nomCaissier.value.trim()) {
    erreurs.push('Nom et PrÃ©nom du caissier obligatoires (Section 2).');
    nomCaissier.classList.add('error');
  }
  if (!document.querySelector('input[name="fonction"]:checked')) {
    erreurs.push('Fonction exercÃ©e non sÃ©lectionnÃ©e (Section 2).');
  }

  // Section 3 : Ã‰cart
  const dateJ = $id('date-jour');
  const dateM = $id('date-mois');
  const dateA = $id('date-annee');
  if (!dateJ.value || !dateM.value || !dateA.value) {
    erreurs.push('Date du constat incomplÃ¨te (Section 3).');
    [dateJ, dateM, dateA].forEach(el => { if (!el.value) el.style.borderColor = 'var(--red)'; });
  } else {
    // Validation stricte : utiliser Date object pour dÃ©tecter les dates invalides (ex: 31 fÃ©vrier)
    const j = parseInt(dateJ.value, 10), m = parseInt(dateM.value, 10), a = parseInt(dateA.value, 10);
    const testDate = new Date(a, m - 1, j);
    const aujourdhui = new Date(); aujourdhui.setHours(23, 59, 59, 999);
    if (
      isNaN(testDate.getTime()) ||
      testDate.getDate() !== j ||
      testDate.getMonth() !== m - 1 ||
      testDate.getFullYear() !== a ||
      a < 2000 || a > 2099
    ) {
      erreurs.push('Date du constat invalide (vÃ©rifier jour/mois/annÃ©e) â€” Section 3.');
      [dateJ, dateM, dateA].forEach(el => el.style.borderColor = 'var(--red)');
    } else if (testDate > aujourdhui) {
      erreurs.push('La date du constat ne peut pas Ãªtre dans le futur â€” Section 3.');
      [dateJ, dateM, dateA].forEach(el => el.style.borderColor = 'var(--red)');
    }
  }
  const heureHH = $id('heure-hh');
  const heureMM = $id('heure-mm');
  if (!heureHH.value || !heureMM.value) {
    erreurs.push('Heure du constat incomplÃ¨te (Section 3).');
  } else {
    const hh = parseInt(heureHH.value, 10), mm = parseInt(heureMM.value, 10);
    if (hh > 23 || mm > 59) erreurs.push("Heure du constat invalide (HH â‰¤ 23, MM â‰¤ 59) â€” Section 3.");
  }

  const montant = $id('montant-chiffres');
  const rawMnt  = montant ? montant.value.replace(/[^0-9]/g, '') : '';
  if (!rawMnt || parseInt(rawMnt) === 0) {
    erreurs.push('Montant de l\'Ã©cart obligatoire et doit Ãªtre > 0 (Section 3).');
    if (montant) montant.classList.add('error');
  }
  if (!document.querySelector('input[name="nature"]:checked')) {
    erreurs.push('Nature de l\'Ã©cart (Manquant / ExcÃ©dent) non sÃ©lectionnÃ©e (Section 3).');
  }
  if (!document.querySelector('input[name="type_caisse"]:checked')) {
    erreurs.push('Type de caisse non sÃ©lectionnÃ© (Section 3).');
  }

  // Section 4 : Circonstances
  const declCaissier = $id('declaration-caissier');
  const obsSup = $id('observations-superviseur');
  if (!declCaissier.value.trim()) {
    erreurs.push('DÃ©claration du caissier obligatoire (Section 4-A).');
    declCaissier.classList.add('error');
  }
  if (!obsSup.value.trim()) {
    erreurs.push('Observations du superviseur obligatoires (Section 4-B).');
    obsSup.classList.add('error');
  }
  if (!document.querySelector('input[name="cause"]:checked')) {
    erreurs.push('Au moins une cause probable doit Ãªtre cochÃ©e (Section 4).');
  }

  if (erreurs.length > 0) {
    showToast('âš  ' + erreurs.length + ' erreur(s) :\nâ€¢ ' + erreurs.slice(0,3).join('\nâ€¢ ') + (erreurs.length > 3 ? '\nâ€¢ ... et ' + (erreurs.length - 3) + ' autre(s).' : ''), 'error');
    const firstError = document.querySelector('.error');
    if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return false;
  }

  // â”€â”€â”€ ENREGISTREMENT LOCAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ref = $id('ref-declaration').textContent;
  const declaration = collecterDonnees(ref);
  enregistrerDeclaration(ref, declaration);

  // â”€â”€â”€ OUVRIR MODAL ENVOI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ouvrirModalEnvoi(ref, declaration);
  return true;
}

// â”€â”€â”€ COLLECTE DES DONNÃ‰ES DU FORMULAIRE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function collecterDonnees(ref) {
  const selCode = $id('sel-code');
  const agCode  = selCode ? selCode.value : '';
  const ag      = AGENCES.find(a => a.code === agCode) || {};

  return {
    ref,
    horodatage: new Date().toISOString(),
    agence:   { code: agCode, nom: ag.nom || '', region: $val('region-input') },
    caissier: {
      matricule: $val('caissier-matricule'), nom: $val('caissier-nom'),
      grade: $val('caissier-grade'), fonction: $radio('fonction'),
      fonctionAutre: $val('fonction-autre')
    },
    ecart: {
      dateJour: $val('date-jour'), dateMois: $val('date-mois'), dateAnnee: $val('date-annee'),
      heureHH: $val('heure-hh'), heureMM: $val('heure-mm'),
      arreteHH: $val('arrete-hh'), arreteMM: $val('arrete-mm'),
      montantDT: $val('montant-chiffres'), montantMM: $val('montant-millimes'),
      montantLettres: $val('montant-lettres'),
      nature: $radio('nature'), typeCaisse: $radio('type_caisse'), caisseAutre: $val('caisse-autre'),
    },
    niveau: $radio('niveau'),
    niveauCalcule: niveauCalcule > 0 ? String(niveauCalcule) : null,
    niveauModifie: (niveauCalcule > 0 && $radio('niveau') && parseInt($radio('niveau')) !== niveauCalcule),
    niveauJustification: $val('niveau-justification') || null,
    circonstances: {
      declarationCaissier: $val('declaration-caissier'),
      observationsSup: $val('observations-superviseur'),
      causes: $checks('cause')
    },
    mesures: { actions: $checks('mesure'), autres: $val('autres-mesures') },
    recidive: { oui: $radio('recidive') === 'OUI', nbEcarts: $val('nb-ecarts') },
    signatures: {
      caissier:    { nom: $val('sig-caissier-nom'), mat: $val('sig-caissier-mat'), date: $val('sig-caissier-date') },
      superviseur: { nom: $val('sig-sup-nom'),      mat: $val('sig-sup-mat'),      date: $val('sig-sup-date')      },
      directeur:   { nom: $val('sig-dir-nom'),      date: $val('sig-dir-date'),    delai: $radio('delai')          },
    },
    // FIX : inclure les champs CP Central (IDs ajoutÃ©s en v3)
    cpCentral: {
      recuLe:    $val('cp-recu-le'),
      traitePar: $val('cp-traite-par'),
      nDossier:  $val('cp-ndossier'),
      statut:    $val('cp-statut'),
    }
  };
}

// â”€â”€â”€ ENREGISTREMENT LOCAL (localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enregistrerDeclaration(ref, data) {
  try {
    const key = 'bq_declarations';
    const declarations = JSON.parse(localStorage.getItem(key) || '{}');
    declarations[ref] = data;
    localStorage.setItem(key, JSON.stringify(declarations));
    console.info('[BQ-CP] DÃ©claration enregistrÃ©e :', ref);
  } catch(e) {
    console.warn('[BQ-CP] Enregistrement localStorage impossible :', e);
  }
}

// â”€â”€â”€ OUVRIR MODAL ENVOI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ouvrirModalEnvoi(ref, data) {
  document.getElementById('modal-ref-num').textContent = ref;
  document.getElementById('modal-agence').textContent  = data.agence.code + ' â€” ' + (data.agence.nom || '');
  document.getElementById('modal-montant').textContent = (data.ecart.montantDT || '0') + ',' + (data.ecart.montantMM || '000') + ' DT';
  document.getElementById('modal-nature').textContent  = data.ecart.nature || 'â€”';
  document.getElementById('modal-niveau').textContent  = data.niveau ? 'Niveau ' + data.niveau : 'â€”';

  const date = data.ecart.dateJour + '/' + data.ecart.dateMois + '/' + data.ecart.dateAnnee;
  document.getElementById('mail-objet').value =
    '[BQ-CP] DÃ©claration DiffÃ©rence de Caisse â€” Agence ' + data.agence.code +
    ' ' + (data.agence.nom || '') + ' â€” ' + date + ' â€” RÃ©f. ' + ref;

  const status = document.getElementById('modal-send-status');
  status.className = 'modal-send-status';
  status.innerHTML = '';
  document.getElementById('btn-envoyer-mail').disabled = false;
  document.getElementById('btn-envoyer-mail').innerHTML = 'âœ‰ Envoyer par mail';

  document.getElementById('modal-envoi').classList.add('visible');
}

// â”€â”€â”€ ENVOI MAIL (mailto fallback â€” remplacer par API backend en production) â”€â”€
function envoyerMail() {
  const to     = document.getElementById('mail-to').value.trim();
  const objet  = document.getElementById('mail-objet').value.trim();
  const msg    = document.getElementById('mail-message').value.trim();
  const status = document.getElementById('modal-send-status');

  if (!to) {
    status.className = 'modal-send-status failed';
    status.innerHTML = 'âœ— Veuillez saisir l\'adresse du destinataire principal (ContrÃ´le Permanent).';
    return;
  }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(to)) {
    status.className = 'modal-send-status failed';
    status.innerHTML = 'âœ— Adresse email invalide.';
    return;
  }

  const ccInputs = document.querySelectorAll('#cc-list .cc-row input');
  const cc = Array.from(ccInputs).map(el => el.value.trim()).filter(v => v && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v));

  status.className = 'modal-send-status sending';
  status.innerHTML = '<div class="spinner"></div>&nbsp;Envoi en coursâ€¦';

  const ref  = document.getElementById('ref-declaration').textContent;
  const data = collecterDonnees(ref);
  const corps = buildCorpsMail(data);

  // Simulation dÃ©lai rÃ©seau (remplacer par fetch() en production)
  setTimeout(function() {
    try {
      const ccParam   = cc.length ? '&cc=' + encodeURIComponent(cc.join(',')) : '';
      const bodyTxt   = corps + (msg ? '\n\n---\n' + msg : '');
      const mailtoUrl = 'mailto:' + encodeURIComponent(to) + '?subject=' + encodeURIComponent(objet) + ccParam + '&body=' + encodeURIComponent(bodyTxt);
      window.open(mailtoUrl, '_self');

      status.className = 'modal-send-status sent';
      status.innerHTML = 'âœ“ Transmission initiÃ©e vers ' + to + (cc.length ? ' (+ ' + cc.length + ' CC)' : '') + '. VÃ©rifiez votre client mail.';
      document.getElementById('btn-envoyer-mail').disabled = true;
      document.getElementById('btn-envoyer-mail').innerHTML = 'âœ“ EnvoyÃ©';
    } catch(e) {
      status.className = 'modal-send-status failed';
      status.innerHTML = 'âœ— Erreur lors de l\'envoi. RÃ©essayez ou contactez le support.';
    }
  }, 1200);
}

// â”€â”€â”€ CONSTRUCTION DU CORPS DU MAIL â€” COMPLET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCorpsMail(data) {
  const date  = data.ecart.dateJour + '/' + data.ecart.dateMois + '/' + data.ecart.dateAnnee;
  const heure = data.ecart.heureHH + ':' + data.ecart.heureMM;
  return [
    'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
    'DÃ‰CLARATION DE DIFFÃ‰RENCE DE CAISSE â€”  v3',
    'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
    'RÃ©fÃ©rence       : ' + data.ref,
    'Date / Heure    : ' + date + ' Ã  ' + heure,
    "Niveau d'alerte : Niveau " + (data.niveau || 'â€”'),
    '',
    'â”€â”€ AGENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    'Code            : ' + (data.agence.code   || 'â€”'),
    'DÃ©signation     : ' + (data.agence.nom    || 'â€”'),
    'RÃ©gion          : ' + (data.agence.region || 'â€”'),
    '',
    'â”€â”€ CAISSIER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    'Matricule       : ' + (data.caissier.matricule || 'â€”'),
    'Nom & PrÃ©nom    : ' + (data.caissier.nom       || 'â€”'),
    'Fonction        : ' + (data.caissier.fonction  || 'â€”'),
    '',
    'â”€â”€ Ã‰CART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    'Montant         : ' + (data.ecart.montantDT || '0') + ',' + (data.ecart.montantMM || '000') + ' DT',
    'En lettres      : ' + (data.ecart.montantLettres || 'â€”'),
    'Nature          : ' + (data.ecart.nature      || 'â€”'),
    'Type de caisse  : ' + (data.ecart.typeCaisse  || 'â€”'),
    '',
    'â”€â”€ CIRCONSTANCES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    "DÃ©claration caissier :",
    data.circonstances.declarationCaissier || 'â€”',
    '',
    'Observations superviseur :',
    data.circonstances.observationsSup || 'â€”',
    '',
    'Cause(s) probable(s) : ' + (data.circonstances.causes.join(', ') || 'â€”'),
    '',
    'â”€â”€ MESURES IMMÃ‰DIATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    (data.mesures.actions.join(' | ') || 'â€”'),
    data.mesures.autres ? 'Autres : ' + data.mesures.autres : '',
    '',
    'â”€â”€ RÃ‰CIDIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    'AntÃ©cÃ©dents 30 jours : ' + (data.recidive.oui ? 'OUI (' + (data.recidive.nbEcarts || '?') + " Ã©cart(s))" : 'NON'),
    '',
    'â”€â”€ SIGNATURES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    'Caissier        : ' + (data.signatures.caissier.nom || 'â€”') + ' | Mat. ' + (data.signatures.caissier.mat || 'â€”') + ' | Date : ' + (data.signatures.caissier.date || 'â€”'),
    'Superviseur     : ' + (data.signatures.superviseur.nom || 'â€”') + ' | Mat. ' + (data.signatures.superviseur.mat || 'â€”') + ' | Date : ' + (data.signatures.superviseur.date || 'â€”'),
    'Directeur       : ' + (data.signatures.directeur.nom || 'â€”') + ' | Date : ' + (data.signatures.directeur.date || 'â€”') + ' | DÃ©lai respectÃ© : ' + (data.signatures.directeur.delai || 'â€”'),
    '',
    'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
    'Document gÃ©nÃ©rÃ© automatiquement â€” Usage interne confidentiel',
    'Direction du ContrÃ´le Permanent | Conservation rÃ©glementaire 10 ans',
    'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
  ].join('\n');
}

// â”€â”€â”€ RÃ‰INITIALISATION COMPLÃˆTE â€” FIX v3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetFormulaire() {
  if (!confirm('Confirmer la rÃ©initialisation complÃ¨te du formulaire ?')) return;

  // RÃ©initialiser TOUS les inputs, selects, textareas (sans exclusion du radio "delai")
  document.querySelectorAll('input, textarea, select').forEach(el => {
    if (el.type === 'radio' || el.type === 'checkbox') el.checked = false;
    else if (el.tagName === 'SELECT') el.selectedIndex = 0;
    else el.value = '';
    el.classList.remove('error', 'valid');
    el.style.borderColor = '';
  });

  // RÃ©initialiser les cards de niveau d'alerte
  document.querySelectorAll('.level-card').forEach(c => {
    c.style.transform = '';
    c.style.boxShadow = '';
    c.style.outline   = '';
    c.classList.remove('active', 'locked', 'locked-active');
  });

  // RÃ©initialiser le systÃ¨me de contrÃ´le du niveau
  niveauCalcule    = 0;
  niveauVerrouille = false;
  for (let i = 1; i <= 4; i++) {
    const tag  = $id('lv-auto-' + i);
    const lock = $id('lv-lock-' + i);
    const radio = $id('niveau' + i);
    if (tag)  tag.style.display  = 'none';
    if (lock) lock.style.display = 'none';
    if (radio) radio.disabled = false;
  }
  const downAlert   = $id('niveau-downgrade-alert');
  const upWarn      = $id('niveau-upgrade-warn');
  const justifBlock = $id('niveau-justif-block');
  if (downAlert)   downAlert.style.display   = 'none';
  if (upWarn)      upWarn.style.display      = 'none';
  if (justifBlock) justifBlock.style.display = 'none';
  updateNiveauStatusBar();

  // Cacher le badge agence (FIX v3)
  updateBadge(null);

  // Cacher le bloc de rÃ©cidive
  const rcBlock = $id('recidive-count-block');
  if (rcBlock) rcBlock.classList.remove('visible');

  // RÃ©initialiser les champs readonly de signature (Section 7)
  const sigNom = $id('sig-caissier-nom');
  const sigMat = $id('sig-caissier-mat');
  if (sigNom) sigNom.value = '';
  if (sigMat) sigMat.value = '';

  // RegÃ©nÃ©rer un nouveau NÂ° de dÃ©claration
  const newRef = genRefDeclaration();
  const refEl = $id('ref-declaration');
  if (refEl) refEl.textContent = newRef;

  // RÃ©initialiser la date du jour
  initDateJour();

  // RÃ©initialiser barre de progression
  updateProgressBar();

  // RÃ©initialiser indicateur autosave
  setAutosaveStatus('neutral');

  showToast('âœ“ Formulaire rÃ©initialisÃ© avec succÃ¨s.', 'success');
}

// â”€â”€â”€ PRÃ‰-REMPLISSAGE DATE DU JOUR â€” utilise pad() centralisÃ© â”€
function initDateJour() {
  const now = new Date();
  const el = {
    j: $id('date-jour'),
    m: $id('date-mois'),
    a: $id('date-annee')
  };
  const heure = {
    h: $id('heure-hh'),
    m: $id('heure-mm')
  };
  if (el.j) el.j.value = pad(now.getDate());
  if (el.m) el.m.value = pad(now.getMonth() + 1);
  if (el.a) el.a.value = now.getFullYear();
  if (heure.h) heure.h.value = pad(now.getHours());
  if (heure.m) heure.m.value = pad(now.getMinutes());
}

// â”€â”€â”€ GÃ‰NÃ‰RATION NÂ° DÃ‰CLARATION â€” avec suffixe alÃ©atoire anti-collision â”€â”€
function genRefDeclaration() {
  const now = new Date();
  const yy = now.getFullYear();
  const mm = pad(now.getMonth() + 1);
  const dd = pad(now.getDate());
  const hh = pad(now.getHours());
  const mi = pad(now.getMinutes());
  const ss = pad(now.getSeconds());
  // Suffixe alÃ©atoire 3 chars pour Ã©viter les collisions si 2 dÃ©clarations simultanÃ©es
  const sfx = Math.random().toString(36).slice(2, 5).toUpperCase();
  return 'DC-' + yy + mm + dd + '-' + hh + mi + ss + '-' + sfx;
}

// â”€â”€â”€ NAVIGATION AUTO ENTRE CHAMPS DATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupDateNavigation() {
  document.querySelectorAll('.date-part input, .time-row .date-part input').forEach(inp => {
    inp.addEventListener('input', function() {
      // Filtrer uniquement les chiffres
      this.value = this.value.replace(/[^0-9]/g, '');
      // Avancer vers le champ suivant quand rempli
      if (this.value.length >= parseInt(this.maxLength)) {
        // Chercher le prochain input dans le mÃªme groupe date/time
        const allInputs = Array.from(this.closest('.date-row, .time-row').querySelectorAll('input'));
        const idx = allInputs.indexOf(this);
        if (idx !== -1 && idx < allInputs.length - 1) {
          allInputs[idx + 1].focus();
          allInputs[idx + 1].select();
        }
      }
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BARRE DE PROGRESSION â€” calcul du taux de complÃ©tion
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateProgressBar() {
  const champs = [
    // Â§1 Agence
    () => !!($id('sel-code') && $id('sel-code').value),
    // Â§2 Caissier
    () => !!$val('caissier-matricule'),
    () => !!$val('caissier-nom'),
    () => !!document.querySelector('input[name="fonction"]:checked'),
    // Â§3 Ã‰cart
    () => !!($val('date-jour') && $val('date-mois') && $val('date-annee')),
    () => !!($val('heure-hh') && $val('heure-mm')),
    () => !!($val('montant-chiffres') && $val('montant-chiffres').replace(/[^0-9]/g,'') !== '0'),
    () => !!document.querySelector('input[name="nature"]:checked'),
    () => !!document.querySelector('input[name="type_caisse"]:checked'),
    // Â§4 Circonstances
    () => !!$val('declaration-caissier'),
    () => !!$val('observations-superviseur'),
    () => !!document.querySelector('input[name="cause"]:checked'),
    // Â§5 Mesures
    () => !!document.querySelector('input[name="mesure"]:checked'),
    // Â§6 RÃ©cidive
    () => !!document.querySelector('input[name="recidive"]:checked'),
    // Â§7 Signatures
    () => !!$val('sig-caissier-date'),
    () => !!$val('sig-sup-nom'),
    () => !!$val('sig-dir-nom'),
    // Niveau
    () => !!document.querySelector('input[name="niveau"]:checked'),
  ];
  const remplis = champs.filter(fn => { try { return fn(); } catch(e) { return false; } }).length;
  const pct = Math.round((remplis / champs.length) * 100);

  const fill  = $id('progress-fill');
  const label = $id('progress-label');
  if (fill)  fill.style.width = pct + '%';
  if (label) label.textContent = pct + ' %';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-SAVE BROUILLON (localStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _autoSaveTimer = null;

function setAutosaveStatus(state) {
  const dot   = $id('autosave-dot');
  const label = $id('autosave-label');
  if (!dot || !label) return;
  dot.className = 'autosave-dot' + (state === 'saving' ? ' saving' : state === 'saved' ? ' saved' : '');
  label.textContent = state === 'saving' ? 'Sauvegardeâ€¦' : state === 'saved' ? 'Brouillon sauvegardÃ©' : 'Brouillon non sauvegardÃ©';
}

function autoSaveBrouillon() {
  clearTimeout(_autoSaveTimer);
  setAutosaveStatus('saving');
  _autoSaveTimer = setTimeout(() => {
    try {
      const ref = $id('ref-declaration') ? $id('ref-declaration').textContent : 'brouillon';
      const data = collecterDonnees(ref);
      localStorage.setItem('bq_brouillon', JSON.stringify({ ts: Date.now(), data }));
      setAutosaveStatus('saved');
    } catch(e) {
      setAutosaveStatus('neutral');
    }
  }, 1200);
}

// â”€â”€â”€ INIT PRINCIPALE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', function() {

  // GÃ©nÃ©ration du NÂ° de dÃ©claration
  const ref = genRefDeclaration();
  const refEl = $id('ref-declaration');
  if (refEl) refEl.textContent = ref;

  // Date de crÃ©ation affichÃ©e
  const now = new Date();
  const refDate = $id('ref-date');
  if (refDate) refDate.textContent = pad(now.getDate()) + '/' + pad(now.getMonth()+1) + '/' + now.getFullYear() + ' â€” ' + pad(now.getHours()) + ':' + pad(now.getMinutes());

  // PrÃ©-remplissage date (utilise pad() centralisÃ©)
  initDateJour();

  // SÃ©lects agences
  populateSelects();

  // Navigation date/heure
  setupDateNavigation();

  // Millimes â€” addEventListener (suppression inline handler)
  const millimesInput = $id('montant-millimes');
  if (millimesInput) {
    millimesInput.addEventListener('input', function() { onMillimesInput(this); });
  }

  // Niveaux d'alerte â€” mise Ã  jour visuelle
  document.querySelectorAll('.level-card input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', () => { updateLevelCards(); updateProgressBar(); autoSaveBrouillon(); });
  });

  // Montant â€” formatage + auto-niveau
  const mntInput = $id('montant-chiffres');
  if (mntInput) {
    mntInput.addEventListener('input', function() {
      const v = this.value.replace(/[^0-9]/g, '');
      this.value = v ? parseInt(v).toLocaleString('fr-TN') : '';
      updateLettres();
      autoSaveBrouillon();
    });
  }

  // â”€â”€ Niveau d'alerte â€” listener sur chaque card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('input[name="niveau"]').forEach(radio => {
    radio.addEventListener('change', function() {
      if (!this.disabled) onNiveauManualChange(parseInt(this.value));
    });
  });

  // RÃ©cidive â€” afficher/masquer le compteur + verrouiller N4
  document.querySelectorAll('input[name="recidive"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const block = $id('recidive-count-block');
      if (block) block.classList.toggle('visible', this.value === 'OUI');
      verrouillerNiveau4Recidive(this.value === 'OUI');
      updateProgressBar();
      autoSaveBrouillon();
    });
  });

  // Auto-remplissage signature caissier (Section 2 â†’ Section 7)
  const caissierNom = $id('caissier-nom');
  const caissierMat = $id('caissier-matricule');
  const sigNom      = $id('sig-caissier-nom');
  const sigMat      = $id('sig-caissier-mat');

  if (caissierNom && sigNom) {
    caissierNom.addEventListener('input', () => { sigNom.value = caissierNom.value; autoSaveBrouillon(); });
  }
  if (caissierMat && sigMat) {
    caissierMat.addEventListener('input', () => { sigMat.value = caissierMat.value; autoSaveBrouillon(); });
  }

  // Champs readonly Section 7
  if (sigNom) {
    sigNom.readOnly = true;
    Object.assign(sigNom.style, { background: '#EBF3FB', color: 'var(--navy)', fontWeight: '600' });
    sigNom.title = 'Repris automatiquement de la Section 2';
  }
  if (sigMat) {
    sigMat.readOnly = true;
    Object.assign(sigMat.style, { background: '#EBF3FB', color: 'var(--navy)', fontWeight: '600', fontFamily: 'var(--mono)' });
    sigMat.title = 'Repris automatiquement de la Section 2';
  }

  // Auto-save sur tous les champs texte / select / checkbox (gÃ©nÃ©rique)
  document.querySelectorAll('input:not([type="radio"]):not([type="checkbox"]), textarea, select').forEach(el => {
    el.addEventListener('change', () => { updateProgressBar(); autoSaveBrouillon(); });
    el.addEventListener('input',  () => { updateProgressBar(); });
  });
  document.querySelectorAll('input[type="checkbox"]').forEach(el => {
    el.addEventListener('change', () => { updateProgressBar(); autoSaveBrouillon(); });
  });

  // Bouton RÃ©initialiser
  const btnReset = $id('btn-reset');
  if (btnReset) btnReset.addEventListener('click', resetFormulaire);

  // Bouton Valider â†’ enregistrement + modal envoi
  const btnValider = $id('btn-valider');
  if (btnValider) btnValider.addEventListener('click', validerFormulaire);

  // â”€â”€â”€ MODAL : boutons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const btnFermer = $id('btn-modal-fermer');
  if (btnFermer) btnFermer.addEventListener('click', function() {
    $id('modal-envoi').classList.remove('visible');
  });

  const modalEnvoi = $id('modal-envoi');
  if (modalEnvoi) modalEnvoi.addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('visible');
  });

  const btnEnvMail = $id('btn-envoyer-mail');
  if (btnEnvMail) btnEnvMail.addEventListener('click', envoyerMail);

  const btnAddCC = $id('btn-add-cc');
  if (btnAddCC) btnAddCC.addEventListener('click', function() {
    const list = $id('cc-list');
    const row  = document.createElement('div');
    row.className = 'cc-row';
    row.innerHTML = '<input type="email" placeholder="adresse@banque.tn"><button class="btn-del-cc" title="Supprimer" type="button">Ã—</button>';
    row.querySelector('.btn-del-cc').addEventListener('click', () => row.remove());
    list.appendChild(row);
    row.querySelector('input').focus();
  });

  // Initialiser barre de progression
  updateProgressBar();
});

</script>
</body>
</html>
