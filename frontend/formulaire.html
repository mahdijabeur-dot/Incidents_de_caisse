<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formulaire de Déclaration de Différence de Caisse — BQ-CP-CAI-001 v3</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=IBM+Plex+Mono:wght@400;500&display=swap');

  :root {
    --navy:        #1F3864;
    --blue:        #2E75B6;
    --blue-light:  #EBF3FB;
    --blue-mid:    #D0E4F5;
    --red:         #C62828;
    --red-light:   #FFF5F5;
    --red-mid:     #FFCDD2;
    --green:       #1B5E20;
    --green-light: #F1F8E9;
    --green-mid:   #C8E6C9;
    --orange:      #E65100;
    --orange-light:#FFF8F0;
    --orange-mid:  #FFE0B2;
    --yellow:      #F57F17;
    --yellow-light:#FFFDE7;
    --gray-900:    #1A1A2E;
    --gray-700:    #374151;
    --gray-500:    #6B7280;
    --gray-300:    #D1D5DB;
    --gray-100:    #F9FAFB;
    --gray-50:     #FCFDFE;
    --white:       #FFFFFF;
    --font: 'IBM Plex Sans', sans-serif;
    --mono: 'IBM Plex Mono', monospace;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font);
    background: #F0F4F8;
    color: var(--gray-700);
    min-height: 100vh;
    padding: 20px;
    print-color-adjust: exact;
    -webkit-print-color-adjust: exact;
  }

  .page-wrapper { max-width: 900px; margin: 0 auto; }

  /* ─── EN-TÊTE ─────────────────────────────────────────────── */
  .form-header {
    background: var(--navy);
    border-radius: 12px 12px 0 0;
    padding: 0;
    overflow: hidden;
    position: relative;
  }
  .form-header::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 6px; height: 100%;
    background: linear-gradient(180deg, #4FC3F7 0%, #2E75B6 50%, #1A3A6B 100%);
  }
  .header-inner {
    padding: 24px 28px 20px 36px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
  }
  .form-title {
    font-size: 22px; font-weight: 700;
    color: var(--white); letter-spacing: -0.3px; line-height: 1.1;
  }
  .form-subtitle {
    font-size: 13px; font-weight: 400;
    color: #90CAF9; margin-top: 5px; letter-spacing: 0.2px;
  }
  .form-meta { font-size: 11px; color: #78909C; margin-top: 8px; }
  .header-right {
    display: flex; flex-direction: column;
    align-items: flex-end; gap: 8px; flex-shrink: 0;
  }
  .form-ref {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 6px; padding: 6px 14px; text-align: center;
  }
  .form-ref-label {
    font-size: 9px; color: #90CAF9; text-transform: uppercase;
    letter-spacing: 1px; display: block;
  }
  .form-ref-code {
    font-family: var(--mono); font-size: 13px;
    font-weight: 500; color: var(--white); display: block;
  }
  .logo-badge {
    width: 48px; height: 48px; background: var(--blue);
    border-radius: 50%; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    border: 2px solid rgba(255,255,255,0.2);
  }
  .logo-badge span:first-child { font-size: 14px; font-weight: 700; color: var(--white); line-height: 1; }
  .logo-badge span:last-child  { font-size: 7px; color: #90CAF9; letter-spacing: 1.5px; }
  .header-stripe {
    height: 4px;
    background: linear-gradient(90deg, var(--blue) 0%, #4FC3F7 60%, var(--blue) 100%);
  }

  /* ─── BANDE N° DÉCLARATION ────────────────────────────────── */
  .ref-bar {
    background: #EBF3FB;
    border-bottom: 1px solid var(--blue-mid);
    padding: 8px 24px;
    display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
  }
  .ref-bar-label { font-size: 10px; font-weight: 700; color: var(--blue); text-transform: uppercase; letter-spacing: 0.5px; }
  .ref-bar-value { font-family: var(--mono); font-size: 13px; font-weight: 600; color: var(--navy); }

  /* ─── BANDE ALERTE NIVEAU ──────────────────────────────────── */
  .alert-band {
    background: var(--blue-light);
    border-left: 4px solid var(--blue);
    border-right: 1px solid var(--blue-mid);
    padding: 14px 20px;
  }
  .alert-band-title {
    font-size: 10px; font-weight: 700; color: var(--blue);
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;
  }
  .levels-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
  .level-card {
    border-radius: 8px; padding: 10px 12px;
    display: flex; align-items: flex-start; gap: 9px;
    border: 1.5px solid transparent; cursor: pointer;
    transition: all 0.15s ease;
  }
  .level-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .level-card.lv1 { background: var(--green-light); border-color: var(--green-mid); }
  .level-card.lv2 { background: var(--yellow-light); border-color: #FFE082; }
  .level-card.lv3 { background: var(--orange-light); border-color: var(--orange-mid); }
  .level-card.lv4 { background: var(--red-light); border-color: var(--red-mid); }
  /* État actif (sélectionné) */
  .level-card.lv1.active { box-shadow: 0 0 0 2px var(--green); transform: translateY(-2px); }
  .level-card.lv2.active { box-shadow: 0 0 0 2px var(--yellow); transform: translateY(-2px); }
  .level-card.lv3.active { box-shadow: 0 0 0 2px var(--orange); transform: translateY(-2px); }
  .level-card.lv4.active { box-shadow: 0 0 0 2px var(--red); transform: translateY(-2px); }
  .level-card input[type="radio"] { display: none; }
  .level-check {
    width: 16px; height: 16px; border-radius: 50%; border: 2px solid;
    flex-shrink: 0; margin-top: 2px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; cursor: pointer;
  }
  .lv1 .level-check { border-color: var(--green); }
  .lv2 .level-check { border-color: var(--yellow); }
  .lv3 .level-check { border-color: var(--orange); }
  .lv4 .level-check { border-color: var(--red); }
  .level-card input[type="radio"]:checked + .level-check::after {
    content: ''; width: 8px; height: 8px; border-radius: 50%; display: block;
  }
  .lv1 input[type="radio"]:checked + .level-check::after { background: var(--green); }
  .lv2 input[type="radio"]:checked + .level-check::after { background: var(--yellow); }
  .lv3 input[type="radio"]:checked + .level-check::after { background: var(--orange); }
  .lv4 input[type="radio"]:checked + .level-check::after { background: var(--red); }
  .level-name { font-size: 11px; font-weight: 700; line-height: 1.2; }
  .lv1 .level-name { color: var(--green); }
  .lv2 .level-name { color: var(--yellow); }
  .lv3 .level-name { color: var(--orange); }
  .lv4 .level-name { color: var(--red); }
  .level-seuil { font-size: 10px; margin-top: 2px; color: var(--gray-500); font-family: var(--mono); }
  .level-desc  { font-size: 10px; color: var(--gray-500); margin-top: 2px; line-height: 1.3; }

  /* ─── CORPS DU FORMULAIRE ──────────────────────────────────── */
  .form-body { background: var(--white); padding: 0 0 28px; }

  /* ─── SECTION ─────────────────────────────────────────────── */
  .section { margin: 0 24px; padding-top: 24px; }
  .section + .section { border-top: 1px solid var(--gray-100); }
  .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 18px; }
  .section-num {
    width: 26px; height: 26px; background: var(--navy);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; color: var(--white); flex-shrink: 0;
  }
  .section-title {
    font-size: 12px; font-weight: 700; color: var(--navy);
    text-transform: uppercase; letter-spacing: 0.8px;
  }

  /* ─── GRID / CHAMPS ───────────────────────────────────────── */
  .row { display: flex; gap: 14px; margin-bottom: 14px; flex-wrap: wrap; }
  .field { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 0; }
  .field.fixed-sm { flex: 0 0 90px; }
  .field.fixed-md { flex: 0 0 160px; }
  .field.fixed-lg { flex: 0 0 220px; }
  .field.full { flex: 0 0 100%; }
  .field.f2 { flex: 2; }
  .field.f3 { flex: 3; }

  .field-label {
    font-size: 10.5px; font-weight: 600; color: var(--gray-500);
    text-transform: uppercase; letter-spacing: 0.5px;
    display: flex; align-items: center; gap: 4px;
  }
  .required { color: var(--red); font-weight: 700; font-size: 12px; }
  .field-hint { font-size: 10px; color: var(--gray-300); font-style: italic; font-weight: 400; text-transform: none; letter-spacing: 0; }

  .field-input {
    height: 38px;
    border: 1.5px solid var(--gray-300);
    border-radius: 7px;
    padding: 0 12px;
    font-family: var(--font);
    font-size: 13px;
    color: var(--gray-900);
    background: var(--gray-50);
    outline: none;
    transition: all 0.15s ease;
    width: 100%;
  }
  .field-input:focus {
    border-color: var(--blue);
    background: var(--blue-light);
    box-shadow: 0 0 0 3px rgba(46,117,182,0.12);
  }
  .field-input.error { border-color: var(--red) !important; background: var(--red-light) !important; }
  .field-input::placeholder { color: var(--gray-300); font-size: 12px; }
  .field-input.mono { font-family: var(--mono); letter-spacing: 0.5px; }
  textarea.field-input { height: auto; min-height: 72px; padding: 10px 12px; resize: vertical; line-height: 1.6; }

  /* ─── DATE PICKER CUSTOM ──────────────────────────────────── */
  .date-row  { display: flex; gap: 6px; align-items: center; }
  .date-part { display: flex; flex-direction: column; align-items: center; gap: 3px; }
  .date-part input {
    width: 54px; height: 38px; text-align: center;
    border: 1.5px solid var(--gray-300); border-radius: 7px;
    font-family: var(--mono); font-size: 14px; font-weight: 500;
    color: var(--gray-900); background: var(--gray-50); outline: none;
  }
  .date-part input:focus { border-color: var(--blue); background: var(--blue-light); }
  .date-part input.year { width: 72px; }
  .date-sep { font-size: 18px; font-weight: 300; color: var(--gray-300); margin-top: -14px; }
  .date-sublabel { font-size: 9px; color: var(--gray-300); text-transform: uppercase; letter-spacing: 0.5px; }
  .time-row { display: flex; gap: 6px; align-items: center; }
  .time-sep { font-size: 20px; font-weight: 700; color: var(--gray-500); margin-top: -16px; }

  /* ─── MONTANT ─────────────────────────────────────────────── */
  .montant-block {
    background: var(--blue-light); border: 2px solid var(--blue);
    border-radius: 10px; padding: 14px 16px;
  }
  .montant-block .field-label { color: var(--blue); }
  .montant-row { display: flex; gap: 10px; align-items: flex-end; margin-top: 8px; }
  .montant-input-wrap { position: relative; flex: 1; }
  .montant-input-wrap input {
    height: 46px; font-family: var(--mono); font-size: 20px; font-weight: 700;
    letter-spacing: 1px; color: var(--navy); background: var(--white);
    border: 2px solid var(--blue); border-radius: 8px;
    padding: 0 50px 0 14px; width: 100%; outline: none;
  }
  .montant-input-wrap input:focus { box-shadow: 0 0 0 3px rgba(46,117,182,0.2); }
  .montant-currency {
    position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
    font-size: 13px; font-weight: 700; color: var(--blue);
  }
  .montant-millimes { display: flex; flex-direction: column; gap: 3px; flex-shrink: 0; }
  .montant-millimes input {
    width: 80px; height: 46px; text-align: center; font-family: var(--mono);
    font-size: 16px; font-weight: 600; color: var(--gray-700);
    border: 1.5px solid var(--gray-300); border-radius: 8px;
    background: var(--white); outline: none; padding: 0 8px;
  }
  .montant-millimes input:focus { border-color: var(--blue); background: var(--blue-light); }
  .montant-lettres-row { margin-top: 10px; }
  .montant-lettres-label {
    font-size: 9.5px; color: var(--blue); font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px;
    margin-bottom: 3px; display: block;
  }
  #montant-lettres {
    font-style: italic; color: var(--navy); font-weight: 500;
    height: 36px; width: 100%;
    border: 1.5px solid var(--blue-mid); border-radius: 7px;
    padding: 0 12px; font-family: var(--font); font-size: 12px;
    background: #f0f4ff; outline: none; cursor: default;
  }
  #montant-lettres::placeholder { font-style: italic; color: var(--gray-300); font-weight: 400; }
  #montant-lettres:focus { border-color: var(--blue); background: var(--blue-light); }

  /* ─── NATURE ÉCART ────────────────────────────────────────── */
  .nature-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .nature-card {
    border-radius: 10px; padding: 14px 16px;
    display: flex; align-items: center; gap: 12px;
    border: 2px solid transparent; cursor: pointer;
    transition: all 0.15s ease;
  }
  .nature-card.manquant { background: var(--red-light); border-color: var(--red-mid); }
  .nature-card.excedent { background: var(--green-light); border-color: var(--green-mid); }
  .nature-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
  .nature-card input { display: none; }
  .nature-radio {
    width: 20px; height: 20px; border-radius: 50%; border: 2px solid;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.15s;
  }
  .nature-card.manquant .nature-radio { border-color: var(--red); }
  .nature-card.excedent .nature-radio { border-color: var(--green); }
  .nature-card input:checked + .nature-radio::after {
    content: ''; width: 10px; height: 10px; border-radius: 50%; display: block;
  }
  .nature-card.manquant input:checked + .nature-radio::after { background: var(--red); }
  .nature-card.excedent input:checked + .nature-radio::after { background: var(--green); }
  .nature-main { font-size: 13px; font-weight: 700; }
  .nature-card.manquant .nature-main { color: var(--red); }
  .nature-card.excedent .nature-main { color: var(--green); }
  .nature-sub { font-size: 11px; color: var(--gray-500); margin-top: 2px; }

  /* ─── CHECKBOXES ──────────────────────────────────────────── */
  .check-group { display: flex; flex-wrap: wrap; gap: 8px 16px; }
  .check-item {
    display: flex; align-items: center; gap: 7px; cursor: pointer;
    padding: 6px 10px; border-radius: 6px;
    border: 1.5px solid var(--gray-100); background: var(--gray-50);
    transition: all 0.12s; user-select: none;
  }
  .check-item:hover { border-color: var(--blue); background: var(--blue-light); }
  .check-item input { display: none; }
  .check-box {
    width: 16px; height: 16px; border-radius: 4px; border: 2px solid var(--gray-300);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.12s;
  }
  .check-item input:checked ~ .check-label { color: var(--navy); font-weight: 600; }
  .check-item input:checked + .check-box { background: var(--navy); border-color: var(--navy); }
  .check-item input:checked + .check-box::after {
    content: ''; width: 8px; height: 5px;
    border: 2px solid var(--white); border-top: none; border-right: none;
    transform: rotate(-45deg) translateY(-1px); display: block;
  }
  .check-label { font-size: 12px; color: var(--gray-700); }

  /* ─── CAUSES ──────────────────────────────────────────────── */
  .cause-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .cause-item {
    display: flex; align-items: center; gap: 7px; cursor: pointer;
    padding: 9px 11px; border-radius: 7px; border: 1.5px solid var(--gray-100);
    background: var(--gray-50); transition: all 0.12s; user-select: none;
  }
  .cause-item:hover { border-color: var(--blue); background: var(--blue-light); }
  .cause-item input { display: none; }
  .cause-item input:checked ~ .cause-text { color: var(--navy); font-weight: 600; }
  .cause-item input:checked + .check-box { background: var(--navy); border-color: var(--navy); }
  .cause-text { font-size: 11.5px; color: var(--gray-700); line-height: 1.3; }

  /* ─── MESURES ─────────────────────────────────────────────── */
  .mesures-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

  /* ─── RÉCIDIVE ────────────────────────────────────────────── */
  .recidive-block {
    background: var(--red-light);
    border: 1.5px solid var(--red-mid);
    border-left: 4px solid var(--red);
    border-radius: 8px; padding: 16px 18px; margin: 0 24px;
  }
  .recidive-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
  .recidive-num {
    width: 24px; height: 24px; background: var(--red);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: var(--white);
  }
  .recidive-title { font-size: 11px; font-weight: 700; color: var(--red); text-transform: uppercase; letter-spacing: 0.8px; }
  .recidive-content { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
  .recidive-question { font-size: 13px; color: var(--gray-700); flex: 1; }
  .radio-group { display: flex; gap: 12px; }
  .radio-item {
    display: flex; align-items: center; gap: 6px; cursor: pointer;
    padding: 7px 14px; border-radius: 6px; border: 1.5px solid var(--gray-300);
    background: var(--white); transition: all 0.12s; user-select: none;
  }
  .radio-item:hover { border-color: var(--red); }
  .radio-item input { display: none; }
  .radio-dot {
    width: 14px; height: 14px; border-radius: 50%;
    border: 2px solid var(--gray-300);
    display: flex; align-items: center; justify-content: center;
  }
  .radio-item input:checked + .radio-dot { border-color: var(--red); }
  .radio-item input:checked + .radio-dot::after {
    content: ''; width: 6px; height: 6px; border-radius: 50%; background: var(--red); display: block;
  }
  .radio-item input:checked ~ .radio-label { color: var(--red); font-weight: 600; }
  .radio-label { font-size: 13px; color: var(--gray-700); }
  .recidive-count { display: flex; align-items: center; gap: 8px; }
  .recidive-count label { font-size: 12px; color: var(--gray-500); white-space: nowrap; }
  .recidive-count input {
    width: 60px; height: 34px; text-align: center;
    border: 1.5px solid var(--gray-300); border-radius: 7px;
    font-family: var(--mono); font-size: 14px; font-weight: 600;
    background: var(--white); outline: none;
  }
  .recidive-count input:focus { border-color: var(--red); background: var(--red-light); }
  /* Masquer le compteur récidive par défaut */
  #recidive-count-block { display: none; }
  #recidive-count-block.visible { display: flex; }

  /* ─── SIGNATURES ──────────────────────────────────────────── */
  .signatures-section { margin: 0 24px; padding-top: 24px; border-top: 1px solid var(--gray-100); }
  .sig-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 14px; }
  .sig-card { border: 1.5px solid var(--gray-300); border-radius: 10px; overflow: hidden; }
  .sig-header { background: var(--navy); padding: 10px 14px; text-align: center; }
  .sig-header.green-bg { background: #1B5E20; }
  .sig-title { font-size: 10px; font-weight: 700; color: var(--white); text-transform: uppercase; letter-spacing: 0.5px; }
  .sig-subtitle { font-size: 9px; color: #90CAF9; margin-top: 2px; }
  .sig-body { padding: 12px 14px; background: var(--gray-50); }
  .sig-field { margin-bottom: 10px; }
  .sig-field label { font-size: 10px; color: var(--gray-500); text-transform: uppercase; font-weight: 600; letter-spacing: 0.4px; display: block; margin-bottom: 4px; }
  .sig-field input {
    width: 100%; height: 32px; border: 1px solid var(--gray-300); border-radius: 6px;
    padding: 0 9px; font-family: var(--font); font-size: 12px;
    background: var(--white); outline: none; color: var(--gray-900);
  }
  .sig-field input:focus { border-color: var(--blue); background: var(--blue-light); }
  .sig-zone {
    border-top: 1px dashed var(--gray-300); margin-top: 6px; padding-top: 10px;
    min-height: 52px; display: flex; align-items: flex-end;
  }
  .sig-zone-label { font-size: 9px; color: var(--gray-300); text-transform: uppercase; letter-spacing: 0.5px; }

  /* ─── BLOC CP CENTRAL ─────────────────────────────────────── */
  .cp-block {
    background: var(--blue-light); border: 1.5px solid var(--blue-mid);
    border-left: 4px solid var(--blue); border-radius: 8px;
    padding: 14px 18px; margin: 0 24px; margin-top: 14px;
  }
  .cp-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
  .cp-badge {
    background: var(--blue); color: var(--white); font-size: 9px; font-weight: 700;
    padding: 3px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .cp-title { font-size: 11px; font-weight: 600; color: var(--blue); }
  .cp-grid { display: flex; gap: 12px; flex-wrap: wrap; }
  .cp-field { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 100px; }
  .cp-field label { font-size: 10px; color: var(--blue); font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px; }
  .cp-field input {
    height: 32px; border: 1px solid var(--blue-mid); border-radius: 6px;
    padding: 0 9px; font-family: var(--font); font-size: 12px;
    background: var(--white); outline: none;
  }
  .cp-field input:focus { border-color: var(--blue); }

  /* ─── PIED DE PAGE ────────────────────────────────────────── */
  .form-footer {
    background: var(--gray-900); border-radius: 0 0 12px 12px;
    padding: 14px 28px; display: flex; justify-content: space-between;
    align-items: center; gap: 20px; flex-wrap: wrap;
  }
  .footer-ref { font-size: 11px; color: #90CAF9; font-family: var(--mono); margin-bottom: 4px; }
  .footer-note { font-size: 10.5px; color: #78909C; line-height: 1.5; }
  .footer-right { text-align: right; }
  .footer-required { display: flex; align-items: center; gap: 5px; justify-content: flex-end; margin-bottom: 5px; }
  .footer-required .required { font-size: 14px; }
  .footer-required span { font-size: 11px; color: #90CAF9; }
  .footer-urgence { font-size: 10.5px; color: #78909C; }

  /* ─── BOUTONS D'ACTION ────────────────────────────────────── */
  .action-bar { display: flex; justify-content: flex-end; gap: 10px; padding: 16px 0 0; }
  .btn {
    padding: 10px 22px; border-radius: 8px; border: none;
    font-family: var(--font); font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
  }
  .btn-secondary { background: var(--gray-100); color: var(--gray-700); border: 1.5px solid var(--gray-300); }
  .btn-secondary:hover { background: var(--gray-300); }
  .btn-primary { background: var(--navy); color: var(--white); box-shadow: 0 2px 8px rgba(31,56,100,0.3); }
  .btn-primary:hover { background: var(--blue); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(31,56,100,0.35); }
  .btn-print { background: transparent; color: var(--navy); border: 1.5px solid var(--navy); }
  .btn-print:hover { background: var(--blue-light); }

  /* ─── MODAL ENVOI MAIL ────────────────────────────────────── */
  .modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 1000;
    background: rgba(10,20,50,0.55); backdrop-filter: blur(3px);
    align-items: center; justify-content: center;
  }
  .modal-overlay.visible { display: flex; }
  .modal-box {
    background: var(--white); border-radius: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    width: 100%; max-width: 500px; overflow: hidden;
    animation: modalIn 0.25s ease;
  }
  @keyframes modalIn { from { opacity:0; transform: scale(0.93) translateY(10px); } to { opacity:1; transform: none; } }
  .modal-header {
    background: var(--navy); padding: 18px 22px;
    display: flex; align-items: center; gap: 12px;
  }
  .modal-icon {
    width: 38px; height: 38px; background: var(--blue); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
  }
  .modal-header-text {}
  .modal-title { font-size: 15px; font-weight: 700; color: var(--white); }
  .modal-subtitle { font-size: 11px; color: #90CAF9; margin-top: 2px; }
  .modal-body { padding: 22px 24px; }
  .modal-saved-badge {
    background: var(--green-light); border: 1px solid var(--green-mid);
    border-radius: 8px; padding: 10px 14px; margin-bottom: 18px;
    font-size: 12px; color: var(--green); font-weight: 600;
    display: flex; align-items: center; gap: 8px;
  }
  .modal-ref-line {
    background: var(--blue-light); border: 1px solid var(--blue-mid);
    border-radius: 8px; padding: 10px 14px; margin-bottom: 18px;
    font-size: 11px; color: var(--gray-700);
    display: flex; flex-wrap: wrap; gap: 14px;
  }
  .modal-ref-line span { color: var(--gray-500); }
  .modal-ref-line strong { font-family: var(--mono); color: var(--navy); font-size: 13px; }
  .modal-field { margin-bottom: 14px; }
  .modal-field label {
    display: block; font-size: 10.5px; font-weight: 700; color: var(--gray-500);
    text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;
  }
  .modal-field input, .modal-field textarea {
    width: 100%; border: 1.5px solid var(--gray-300); border-radius: 7px;
    padding: 0 12px; height: 38px; font-family: var(--font); font-size: 13px;
    color: var(--gray-900); background: var(--gray-50); outline: none; transition: all 0.15s;
  }
  .modal-field textarea { height: 70px; padding: 9px 12px; resize: vertical; line-height: 1.5; }
  .modal-field input:focus, .modal-field textarea:focus {
    border-color: var(--blue); background: var(--blue-light);
    box-shadow: 0 0 0 3px rgba(46,117,182,0.12);
  }
  .modal-field input.auto-filled { background: #EBF3FB; color: var(--navy); font-style: italic; }
  .cc-list { display: flex; flex-direction: column; gap: 6px; }
  .cc-row { display: flex; gap: 6px; }
  .cc-row input { flex: 1; }
  .btn-del-cc {
    width: 38px; height: 38px; border-radius: 7px;
    border: 1.5px solid var(--red-mid); background: var(--red-light);
    color: var(--red); font-size: 18px; cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; transition: all 0.12s;
  }
  .btn-del-cc:hover { background: var(--red-mid); }
  .btn-add-cc {
    margin-top: 5px; padding: 6px 14px; border-radius: 6px;
    border: 1.5px dashed var(--blue-mid); background: transparent;
    color: var(--blue); font-size: 11px; font-weight: 600;
    cursor: pointer; font-family: var(--font); transition: all 0.12s;
  }
  .btn-add-cc:hover { background: var(--blue-light); }
  .modal-send-status {
    padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: 600;
    margin-top: 12px; display: none; line-height: 1.5;
  }
  .modal-send-status.sending { background: var(--blue-light); color: var(--blue); border: 1px solid var(--blue-mid); display: flex; align-items: center; gap: 8px; }
  .modal-send-status.sent    { background: var(--green-light); color: var(--green); border: 1px solid var(--green-mid); display: flex; align-items: center; gap: 8px; }
  .modal-send-status.failed  { background: var(--red-light); color: var(--red); border: 1px solid var(--red-mid); display: flex; align-items: center; gap: 8px; }
  .spinner {
    width: 16px; height: 16px; border: 2.5px solid currentColor; border-top-color: transparent;
    border-radius: 50%; animation: spin 0.7s linear infinite; flex-shrink: 0;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .modal-footer {
    border-top: 1px solid var(--gray-100); padding: 14px 24px;
    display: flex; justify-content: flex-end; gap: 10px;
  }

  /* ─── TOAST VALIDATION ────────────────────────────────────── */
  .toast {
    display: none; position: fixed; bottom: 30px; right: 30px; z-index: 9999;
    background: var(--red); color: var(--white); border-radius: 10px;
    padding: 14px 20px; font-size: 13px; font-weight: 500;
    box-shadow: 0 6px 24px rgba(0,0,0,0.2); max-width: 360px; line-height: 1.5;
  }
  .toast.success { background: var(--green); }
  .toast.visible { display: block; animation: slideIn 0.3s ease; }
  @keyframes slideIn { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

  /* ─── SEPARATEUR SECTION ──────────────────────────────────── */
  .section-divider { height: 1px; background: var(--gray-100); margin: 0 24px; }

  /* ─── BARRE DE PROGRESSION ────────────────────────────────── */
  .progress-bar-wrap {
    background: var(--gray-100); height: 5px; position: sticky; top: 0; z-index: 100;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }
  .progress-bar-fill {
    height: 100%; background: linear-gradient(90deg, var(--blue) 0%, #4FC3F7 100%);
    transition: width 0.4s ease; width: 0%;
  }
  .progress-label {
    position: absolute; right: 10px; top: -18px;
    font-size: 10px; font-weight: 700; color: var(--blue);
    font-family: var(--mono); opacity: 0.8;
  }

  /* ─── AUTOSAVE INDICATOR ──────────────────────────────────── */
  .autosave-dot {
    display: inline-block; width: 7px; height: 7px; border-radius: 50%;
    background: var(--gray-300); margin-left: 8px; vertical-align: middle;
    transition: background 0.3s;
  }
  .autosave-dot.saving { background: var(--yellow); animation: pulse 0.6s ease infinite alternate; }
  .autosave-dot.saved  { background: var(--green); }
  @keyframes pulse { from { opacity:1; } to { opacity:0.4; } }

  /* ─── VALIDATION TEMPS RÉEL ───────────────────────────────── */
  .field-input.valid { border-color: var(--green) !important; }
  .field-error-msg { font-size: 10px; color: var(--red); margin-top: 3px; display: none; }
  .field-input.error ~ .field-error-msg { display: block; }

  /* ─── AGENCE BADGE ────────────────────────────────────────── */
  .select-wrap { position: relative; }
  .select-wrap .select-arrow {
    position: absolute; right: 11px; top: 50%; transform: translateY(-50%);
    color: var(--blue); font-size: 11px; pointer-events: none;
  }
  .field-select {
    appearance: none; -webkit-appearance: none;
    cursor: pointer; padding-right: 30px;
    background: var(--gray-50); color: var(--gray-900);
  }
  .field-select:focus { border-color: var(--blue); background: var(--blue-light); box-shadow: 0 0 0 3px rgba(46,117,182,0.12); }
  .field-select option { font-family: var(--font); font-size: 13px; }
  .agence-badge {
    display: inline-flex; align-items: center; gap: 7px;
    background: var(--navy); color: white;
    padding: 4px 12px 4px 8px; border-radius: 20px;
    font-size: 11px; font-weight: 600; margin: 6px 0 0 0;
    opacity: 0; transition: all 0.25s; transform: translateY(5px);
  }
  .agence-badge.visible { opacity: 1; transform: translateY(0); }
  .agence-badge .badge-code { font-family: var(--mono); background: rgba(255,255,255,0.2); padding: 1px 7px; border-radius: 10px; margin-right: 2px; }

  /* ─── PRINT ───────────────────────────────────────────────── */
  @media print {
    body { background: white; padding: 0; }
    .page-wrapper { max-width: 100%; }
    .action-bar, .toast { display: none; }
    .form-header, .form-footer { border-radius: 0; }
  }
</style>
</head>
<body>

<div class="page-wrapper">

  <!-- EN-TÊTE -->
  <div class="form-header">
    <div class="header-inner">
      <div class="header-left">
        <div class="form-title">FORMULAIRE DE DÉCLARATION</div>
        <div class="form-subtitle">Différence de Caisse — Réseau Agences</div>
        <div class="form-meta">Direction du Contrôle Permanent &nbsp;|&nbsp; Usage Interne — Confidentiel</div>
      </div>
      <div class="header-right">
        <div class="logo-badge">
          <span>BQ</span>
          <span>BANQUE</span>
        </div>
        <div class="form-ref">
          <span class="form-ref-label">N° Formulaire</span>
          <span class="form-ref-code">BQ-CP-CAI-001</span>
        </div>
      </div>
    </div>
    <div class="header-stripe"></div>
  </div>

  <!-- BARRE DE PROGRESSION -->
  <div class="progress-bar-wrap" title="Complétion du formulaire">
    <div class="progress-bar-fill" id="progress-fill"></div>
    <span class="progress-label" id="progress-label">0 %</span>
  </div>

  <!-- BARRE N° DÉCLARATION AUTO-GÉNÉRÉ -->
  <div class="ref-bar">
    <span class="ref-bar-label">N° Déclaration</span>
    <span class="ref-bar-value" id="ref-declaration">— en attente —</span>
    <span class="ref-bar-label" style="margin-left:24px;">Date de création</span>
    <span class="ref-bar-value" id="ref-date">—</span>
    <span class="autosave-dot" id="autosave-dot" title="Sauvegarde automatique"></span>
    <span style="font-size:10px; color:var(--gray-500); margin-left:2px;" id="autosave-label">Brouillon non sauvegardé</span>
  </div>

  <!-- BANDE NIVEAU D'ALERTE -->
  <div class="alert-band">
    <div class="alert-band-title">⚠ Niveau d'alerte — Sélection automatique selon le montant ou à cocher manuellement</div>
    <div class="levels-grid">
      <label class="level-card lv1" id="lv-card-1">
        <input type="radio" name="niveau" value="1" id="niveau1">
        <div class="level-check"></div>
        <div class="level-info">
          <div class="level-name">NIVEAU 1</div>
          <div class="level-seuil">&lt; 20 DT</div>
          <div class="level-desc">Déclaration interne agence</div>
        </div>
      </label>
      <label class="level-card lv2" id="lv-card-2">
        <input type="radio" name="niveau" value="2" id="niveau2">
        <div class="level-check"></div>
        <div class="level-info">
          <div class="level-name">NIVEAU 2</div>
          <div class="level-seuil">20 — 200 DT</div>
          <div class="level-desc">Transmission CP Central</div>
        </div>
      </label>
      <label class="level-card lv3" id="lv-card-3">
        <input type="radio" name="niveau" value="3" id="niveau3">
        <div class="level-check"></div>
        <div class="level-info">
          <div class="level-name">NIVEAU 3</div>
          <div class="level-seuil">200 — 1 000 DT</div>
          <div class="level-desc">Alerte CP — Enquête systématique</div>
        </div>
      </label>
      <label class="level-card lv4" id="lv-card-4">
        <input type="radio" name="niveau" value="4" id="niveau4">
        <div class="level-check"></div>
        <div class="level-info">
          <div class="level-name">NIVEAU 4</div>
          <div class="level-seuil">&gt; 1 000 DT / Récidive</div>
          <div class="level-desc">Alerte DG — Inspection</div>
        </div>
      </label>
    </div>
  </div>

  <div class="form-body">

    <!-- SECTION 1 : IDENTIFICATION AGENCE -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">1</div>
        <div class="section-title">Identification de l'Agence</div>
      </div>
      <div class="row">
        <div class="field fixed-md">
          <label class="field-label">Code Agence <span class="required">*</span></label>
          <div class="select-wrap">
            <select class="field-input field-select mono" id="sel-code" onchange="syncAgence('code')">
              <option value="">— Code —</option>
            </select>
            <span class="select-arrow">&#9660;</span>
          </div>
        </div>
        <div class="field f3">
          <label class="field-label">Désignation de l'Agence <span class="required">*</span></label>
          <div class="select-wrap">
            <select class="field-input field-select" id="sel-nom" onchange="syncAgence('nom')">
              <option value="">— Sélectionner l'agence —</option>
            </select>
            <span class="select-arrow">&#9660;</span>
          </div>
        </div>
        <div class="field f2">
          <label class="field-label">Région / Direction Réseau</label>
          <input class="field-input" id="region-input" type="text" placeholder="Ex : Grand Tunis, Sfax...">
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- SECTION 2 : IDENTIFICATION CAISSIER -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">2</div>
        <div class="section-title">Identification du Caissier Déclarant</div>
      </div>
      <div class="row">
        <div class="field fixed-md">
          <label class="field-label">Matricule <span class="required">*</span></label>
          <input class="field-input mono" id="caissier-matricule" type="text" placeholder="MAT-0000" maxlength="12">
        </div>
        <div class="field f3">
          <label class="field-label">Nom et Prénom complets <span class="required">*</span></label>
          <input class="field-input" id="caissier-nom" type="text" placeholder="Nom de famille, Prénom(s)">
        </div>
        <div class="field f2">
          <label class="field-label">Catégorie / Grade</label>
          <input class="field-input" id="caissier-grade" type="text" placeholder="Ex : Rédacteur, Cadre...">
        </div>
      </div>
      <div class="row">
        <div class="field full">
          <label class="field-label">Fonction exercée <span class="required">*</span></label>
          <div class="check-group">
            <label class="check-item">
              <input type="radio" name="fonction" value="Caissier Principal"><div class="check-box"></div>
              <span class="check-label">Caissier Principal</span>
            </label>
            <label class="check-item">
              <input type="radio" name="fonction" value="Caissier Adjoint"><div class="check-box"></div>
              <span class="check-label">Caissier Adjoint</span>
            </label>
            <label class="check-item">
              <input type="radio" name="fonction" value="Stagiaire Caissier"><div class="check-box"></div>
              <span class="check-label">Stagiaire Caissier</span>
            </label>
            <label class="check-item">
              <input type="radio" name="fonction" value="Autre"><div class="check-box"></div>
              <span class="check-label">Autre (préciser)</span>
            </label>
            <input class="field-input" id="fonction-autre" style="flex:1; min-width:160px; height:36px;" type="text" placeholder="Préciser si Autre...">
          </div>
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- SECTION 3 : DÉTAILS DE L'ÉCART -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">3</div>
        <div class="section-title">Détails de l'Écart Constaté</div>
      </div>

      <!-- Date / Heures -->
      <div class="row">
        <div class="field">
          <label class="field-label">Date du Constat <span class="required">*</span></label>
          <div class="date-row">
            <div class="date-part">
              <input type="text" id="date-jour" placeholder="JJ" maxlength="2">
              <span class="date-sublabel">Jour</span>
            </div>
            <span class="date-sep">/</span>
            <div class="date-part">
              <input type="text" id="date-mois" placeholder="MM" maxlength="2">
              <span class="date-sublabel">Mois</span>
            </div>
            <span class="date-sep">/</span>
            <div class="date-part">
              <input type="text" id="date-annee" class="year" placeholder="AAAA" maxlength="4">
              <span class="date-sublabel">Année</span>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="field-label">Heure du Constat <span class="required">*</span></label>
          <div class="time-row">
            <div class="date-part">
              <input type="text" id="heure-hh" placeholder="HH" maxlength="2">
              <span class="date-sublabel">Heures</span>
            </div>
            <span class="time-sep">:</span>
            <div class="date-part">
              <input type="text" id="heure-mm" placeholder="MM" maxlength="2">
              <span class="date-sublabel">Minutes</span>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="field-label">Heure Arrêté de Caisse</label>
          <div class="time-row">
            <div class="date-part">
              <input type="text" id="arrete-hh" placeholder="HH" maxlength="2">
              <span class="date-sublabel">Heures</span>
            </div>
            <span class="time-sep">:</span>
            <div class="date-part">
              <input type="text" id="arrete-mm" placeholder="MM" maxlength="2">
              <span class="date-sublabel">Minutes</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Montant + Nature -->
      <div class="row" style="align-items: flex-start;">
        <div class="field f2">
          <div class="montant-block">
            <label class="field-label">Montant de l'Écart <span class="required">*</span></label>
            <div class="montant-row">
              <div class="montant-input-wrap">
                <input type="text" class="mono" placeholder="0" id="montant-chiffres">
                <span class="montant-currency">DT</span>
              </div>
              <div class="montant-millimes">
                <input type="text" class="mono" placeholder="000" maxlength="3" id="montant-millimes" title="Millimes">
                <span class="date-sublabel" style="text-align:center">Millimes</span>
              </div>
            </div>
            <div class="montant-lettres-row">
              <span class="montant-lettres-label">En toutes lettres</span>
              <input type="text" id="montant-lettres" placeholder="Montant en toutes lettres (dinars tunisiens)..." readonly>
            </div>
          </div>
        </div>
        <div class="field f2">
          <label class="field-label">Nature de l'Écart <span class="required">*</span></label>
          <div class="nature-grid">
            <label class="nature-card manquant">
              <input type="radio" name="nature" value="MANQUANT">
              <div class="nature-radio"></div>
              <div class="nature-label">
                <div class="nature-main">▼ MANQUANT</div>
                <div class="nature-sub">Déficit — Solde physique inférieur</div>
              </div>
            </label>
            <label class="nature-card excedent">
              <input type="radio" name="nature" value="EXCÉDENT">
              <div class="nature-radio"></div>
              <div class="nature-label">
                <div class="nature-main">▲ EXCÉDENT</div>
                <div class="nature-sub">Surplus — Solde physique supérieur</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Type de caisse -->
      <div class="row">
        <div class="field full">
          <label class="field-label">Type de Caisse Concernée <span class="required">*</span></label>
          <div class="check-group">
            <label class="check-item">
              <input type="radio" name="type_caisse" value="Caisse DT Principale"><div class="check-box"></div>
              <span class="check-label">Caisse DT Principale</span>
            </label>
            <label class="check-item">
              <input type="radio" name="type_caisse" value="Caisse Devises"><div class="check-box"></div>
              <span class="check-label">Caisse Devises</span>
            </label>
            <label class="check-item">
              <input type="radio" name="type_caisse" value="Caisse GAB/DAB"><div class="check-box"></div>
              <span class="check-label">Caisse GAB / DAB</span>
            </label>
            <label class="check-item">
              <input type="radio" name="type_caisse" value="Caisse Secondaire"><div class="check-box"></div>
              <span class="check-label">Caisse Secondaire</span>
            </label>
            <label class="check-item">
              <input type="radio" name="type_caisse" value="Autre"><div class="check-box"></div>
              <span class="check-label">Autre</span>
            </label>
            <input class="field-input" id="caisse-autre" style="flex:1; min-width:160px; height:36px;" type="text" placeholder="Préciser le type si Autre...">
          </div>
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- SECTION 4 : CIRCONSTANCES -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">4</div>
        <div class="section-title">Circonstances et Explications</div>
      </div>
      <div class="row">
        <div class="field full">
          <label class="field-label">A. Déclaration du Caissier <span class="required">*</span> <span class="field-hint">— Description circonstanciée des faits</span></label>
          <textarea class="field-input" id="declaration-caissier" rows="4" placeholder="Décrire avec précision les circonstances ayant pu causer l'écart : opérations effectuées, incidents survenus, observations particulières sur le déroulement de la journée..."></textarea>
        </div>
      </div>
      <div class="row">
        <div class="field full">
          <label class="field-label">B. Observations du Superviseur de Caisse <span class="required">*</span></label>
          <textarea class="field-input" id="observations-superviseur" rows="3" placeholder="Observations et commentaires du superviseur : résultat du contre-comptage, cohérence des explications du caissier, anomalies constatées..."></textarea>
        </div>
      </div>
      <div class="row">
        <div class="field full">
          <label class="field-label">Cause Probable Retenue <span class="required">*</span></label>
          <div class="cause-grid">
            <label class="cause-item">
              <input type="checkbox" name="cause" value="Erreur de comptage"><div class="check-box"></div>
              <span class="cause-text">Erreur de comptage</span>
            </label>
            <label class="cause-item">
              <input type="checkbox" name="cause" value="Erreur de rendu monnaie"><div class="check-box"></div>
              <span class="cause-text">Erreur de rendu monnaie</span>
            </label>
            <label class="cause-item">
              <input type="checkbox" name="cause" value="Oubli d'encaissement"><div class="check-box"></div>
              <span class="cause-text">Oubli d'encaissement</span>
            </label>
            <label class="cause-item">
              <input type="checkbox" name="cause" value="Défaillance système"><div class="check-box"></div>
              <span class="cause-text">Défaillance système / informatique</span>
            </label>
            <label class="cause-item">
              <input type="checkbox" name="cause" value="Suspicion de fraude interne"><div class="check-box"></div>
              <span class="cause-text">Suspicion de fraude interne</span>
            </label>
            <label class="cause-item">
              <input type="checkbox" name="cause" value="Autre / Cause indéterminée"><div class="check-box"></div>
              <span class="cause-text">Autre / Cause indéterminée</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- SECTION 5 : MESURES IMMÉDIATES -->
    <div class="section">
      <div class="section-header">
        <div class="section-num">5</div>
        <div class="section-title">Mesures Immédiates Prises</div>
      </div>
      <div class="row">
        <div class="field full">
          <label class="field-label">Actions conservatoires engagées après constat</label>
          <div class="mesures-grid">
            <label class="check-item">
              <input type="checkbox" name="mesure" value="Contre-comptage effectué"><div class="check-box"></div>
              <span class="check-label">Contre-comptage effectué</span>
            </label>
            <label class="check-item">
              <input type="checkbox" name="mesure" value="Isolement de la caisse"><div class="check-box"></div>
              <span class="check-label">Isolement de la caisse</span>
            </label>
            <label class="check-item">
              <input type="checkbox" name="mesure" value="Visionnage des caméras"><div class="check-box"></div>
              <span class="check-label">Visionnage des caméras</span>
            </label>
            <label class="check-item">
              <input type="checkbox" name="mesure" value="Entretien avec le caissier"><div class="check-box"></div>
              <span class="check-label">Entretien avec le caissier</span>
            </label>
            <label class="check-item">
              <input type="checkbox" name="mesure" value="Mise en suspens comptable"><div class="check-box"></div>
              <span class="check-label">Mise en suspens comptable</span>
            </label>
            <label class="check-item">
              <input type="checkbox" name="mesure" value="Information Contrôle Permanent"><div class="check-box"></div>
              <span class="check-label">Information Contrôle Permanent</span>
            </label>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="field full">
          <label class="field-label">Autres mesures / Précisions complémentaires</label>
          <input class="field-input" id="autres-mesures" type="text" placeholder="Décrire toute autre mesure prise...">
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- SECTION 6 : RÉCIDIVE (intégrée dans form-body) -->
    <div class="section" style="padding-bottom: 24px;">
      <div class="recidive-block">
        <div class="recidive-header">
          <div class="recidive-num">6</div>
          <div class="recidive-title">Antécédents et Récidive</div>
        </div>
        <div class="recidive-content">
          <div class="recidive-question">Ce caissier a-t-il fait l'objet d'écarts déclarés au cours des <strong>30 derniers jours</strong> ?</div>
          <div class="radio-group">
            <label class="radio-item">
              <input type="radio" name="recidive" value="OUI" id="recidive-oui"><div class="radio-dot"></div>
              <span class="radio-label">OUI</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="recidive" value="NON" id="recidive-non"><div class="radio-dot"></div>
              <span class="radio-label">NON</span>
            </label>
          </div>
          <div class="recidive-count" id="recidive-count-block">
            <label for="nb-ecarts">Si OUI, nombre d'écarts :</label>
            <input type="number" id="nb-ecarts" min="1" max="99" placeholder="—">
          </div>
        </div>
      </div>
    </div>

  </div><!-- fin form-body -->

  <!-- SECTION 7 : SIGNATURES -->
  <div class="signatures-section" style="background: var(--white);">
    <div class="section-header">
      <div class="section-num">7</div>
      <div class="section-title">Signatures et Validations Obligatoires</div>
    </div>
    <div class="sig-grid">
      <div class="sig-card">
        <div class="sig-header">
          <div class="sig-title">Caissier Déclarant</div>
          <div class="sig-subtitle">Signature obligatoire</div>
        </div>
        <div class="sig-body">
          <div class="sig-field">
            <label>Nom & Prénom <span style="font-size:9px;color:#90CAF9;font-weight:400;text-transform:none;">(repris §2)</span></label>
            <input type="text" id="sig-caissier-nom" placeholder="Automatique — saisir §2">
          </div>
          <div class="sig-field">
            <label>Matricule <span style="font-size:9px;color:#90CAF9;font-weight:400;text-transform:none;">(repris §2)</span></label>
            <input type="text" id="sig-caissier-mat" placeholder="Automatique — saisir §2">
          </div>
          <div class="sig-field">
            <label>Date</label>
            <input type="text" id="sig-caissier-date" placeholder="JJ / MM / AAAA">
          </div>
          <div class="sig-zone">
            <span class="sig-zone-label">Signature</span>
          </div>
        </div>
      </div>
      <div class="sig-card">
        <div class="sig-header">
          <div class="sig-title">Superviseur de Caisse</div>
          <div class="sig-subtitle">Validation hiérarchique N+1</div>
        </div>
        <div class="sig-body">
          <div class="sig-field">
            <label>Nom & Prénom</label>
            <input type="text" id="sig-sup-nom" placeholder="Nom Prénom">
          </div>
          <div class="sig-field">
            <label>Matricule</label>
            <input type="text" id="sig-sup-mat" placeholder="MAT-0000" style="font-family: var(--mono);">
          </div>
          <div class="sig-field">
            <label>Date</label>
            <input type="text" id="sig-sup-date" placeholder="JJ / MM / AAAA">
          </div>
          <div class="sig-zone">
            <span class="sig-zone-label">Signature</span>
          </div>
        </div>
      </div>
      <div class="sig-card">
        <div class="sig-header green-bg">
          <div class="sig-title">Directeur d'Agence</div>
          <div class="sig-subtitle">Validation finale + Cachet</div>
        </div>
        <div class="sig-body">
          <div class="sig-field">
            <label>Nom & Prénom</label>
            <input type="text" id="sig-dir-nom" placeholder="Nom Prénom">
          </div>
          <div class="sig-field">
            <label>Date & Heure de réception</label>
            <input type="text" id="sig-dir-date" placeholder="JJ/MM/AAAA — HH:MM">
          </div>
          <div class="sig-field">
            <label>Délai de transmission respecté ?</label>
            <div class="radio-group" style="margin-top:2px;">
              <label class="radio-item" style="padding: 5px 10px;">
                <input type="radio" name="delai" value="Oui"><div class="radio-dot"></div>
                <span class="radio-label" style="font-size:11px;">Oui (&lt;1h)</span>
              </label>
              <label class="radio-item" style="padding: 5px 10px;">
                <input type="radio" name="delai" value="Non"><div class="radio-dot"></div>
                <span class="radio-label" style="font-size:11px;">Non (motif)</span>
              </label>
            </div>
          </div>
          <div class="sig-zone">
            <span class="sig-zone-label">Signature & Cachet</span>
          </div>
        </div>
      </div>
    </div>

    <!-- CP CENTRAL -->
    <div class="cp-block">
      <div class="cp-header">
        <span class="cp-badge">Réservé CP</span>
        <span class="cp-title">Contrôle Permanent Central — Réception et Traitement</span>
      </div>
      <div class="cp-grid">
        <div class="cp-field">
          <label for="cp-recu-le">Reçu le</label>
          <input type="text" id="cp-recu-le" placeholder="JJ/MM/AAAA — HH:MM">
        </div>
        <div class="cp-field" style="flex:2;">
          <label for="cp-traite-par">Traité par</label>
          <input type="text" id="cp-traite-par" placeholder="Nom du responsable CP">
        </div>
        <div class="cp-field">
          <label for="cp-ndossier">N° Dossier CP</label>
          <input type="text" id="cp-ndossier" placeholder="CP-2025-000" style="font-family: var(--mono);">
        </div>
        <div class="cp-field">
          <label for="cp-statut">Statut</label>
          <input type="text" id="cp-statut" placeholder="En cours / Clôturé">
        </div>
      </div>
    </div>

    <!-- ACTION BAR -->
    <div class="action-bar">
      <button class="btn btn-secondary" id="btn-reset">↺ Réinitialiser</button>
      <button class="btn btn-print" onclick="window.print()">🖨 Imprimer</button>
      <button class="btn btn-primary" id="btn-valider">✓ Valider et Transmettre</button>
    </div>
  </div>

  <!-- PIED DE PAGE -->
  <div class="form-footer">
    <div class="footer-left">
      <div class="footer-ref">BQ-CP-CAI-001  |  Rév. 03 — 2025</div>
      <div class="footer-note">
        3 exemplaires obligatoires : Agence (1)  ·  Contrôle Permanent (1)  ·  Caissier (1)<br>
        Conservation réglementaire : 10 ans  |  Direction du Contrôle Permanent
      </div>
    </div>
    <div class="footer-right">
      <div class="footer-required">
        <span class="required">*</span>
        <span>Champs obligatoires</span>
      </div>
      <div class="footer-urgence">Transmission au Directeur d'Agence dans l'heure</div>
    </div>
  </div>

</div><!-- fin page-wrapper -->

<!-- MODAL ENREGISTREMENT + ENVOI MAIL -->
<div class="modal-overlay" id="modal-envoi">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-icon">📧</div>
      <div class="modal-header-text">
        <div class="modal-title">Enregistrement &amp; Transmission</div>
        <div class="modal-subtitle">Déclaration de Différence de Caisse — Contrôle Permanent</div>
      </div>
    </div>
    <div class="modal-body">
      <!-- Confirmation enregistrement -->
      <div class="modal-saved-badge" id="modal-save-status">
        <span>✓</span> Déclaration enregistrée localement — Référence : <strong id="modal-ref-num" style="font-family:var(--mono); margin-left:4px;"></strong>
      </div>
      <!-- Récapitulatif -->
      <div class="modal-ref-line" id="modal-recap">
        <div><span>Agence :</span> <strong id="modal-agence">—</strong></div>
        <div><span>Montant :</span> <strong id="modal-montant">—</strong></div>
        <div><span>Nature :</span> <strong id="modal-nature">—</strong></div>
        <div><span>Niveau :</span> <strong id="modal-niveau">—</strong></div>
      </div>
      <!-- Destinataires -->
      <div class="modal-field">
        <label>Destinataire principal <span style="color:var(--red);">*</span> — Contrôle Permanent</label>
        <input type="email" id="mail-to" placeholder="cp.central@banque.tn" class="auto-filled">
      </div>
      <div class="modal-field">
        <label>Copie à (CC) <span style="font-weight:400; text-transform:none; color:var(--gray-300);">— Directeur d'agence, superviseur…</span></label>
        <div class="cc-list" id="cc-list">
          <div class="cc-row">
            <input type="email" placeholder="directeur.agence@banque.tn">
          </div>
        </div>
        <button class="btn-add-cc" id="btn-add-cc" type="button">+ Ajouter un destinataire CC</button>
      </div>
      <!-- Objet auto -->
      <div class="modal-field">
        <label>Objet du mail</label>
        <input type="text" id="mail-objet" class="auto-filled" readonly>
      </div>
      <!-- Message complémentaire -->
      <div class="modal-field">
        <label>Message complémentaire <span style="font-weight:400; text-transform:none; color:var(--gray-300);">— optionnel</span></label>
        <textarea id="mail-message" placeholder="Observations complémentaires à joindre au mail..."></textarea>
      </div>
      <!-- Statut envoi -->
      <div class="modal-send-status" id="modal-send-status"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="btn-modal-fermer">Fermer</button>
      <button class="btn btn-print" onclick="window.print()" type="button">🖨 Imprimer</button>
      <button class="btn btn-primary" id="btn-envoyer-mail">✉ Envoyer par mail</button>
    </div>
  </div>
</div>

<!-- TOAST NOTIFICATION -->
<div class="toast" id="toast"></div>

<script>
'use strict';

// ═══════════════════════════════════════════════════════════
// UTILITAIRES COMMUNS
// ═══════════════════════════════════════════════════════════

/** Pad un nombre sur 2 chiffres — fonction centralisée (une seule définition) */
const pad = n => String(n).padStart(2, '0');

/** Accès sécurisé à un élément par ID */
const $id = id => document.getElementById(id);

/** Accès sécurisé à la valeur d'un élément */
const $val = id => { const el = $id(id); return el ? el.value.trim() : ''; };

/** Récupérer la valeur d'un groupe radio */
const $radio = name => { const el = document.querySelector('input[name="' + name + '"]:checked'); return el ? el.value : ''; };

/** Récupérer les valeurs de checkboxes cochées */
const $checks = name => Array.from(document.querySelectorAll('input[name="' + name + '"]:checked')).map(el => el.value);

// ═══════════════════════════════════════════════════════════
// CONVERSION MONTANT EN LETTRES — DINARS TUNISIENS
// ═══════════════════════════════════════════════════════════

const UNITES  = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf',
  'dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
const DIZAINES = ['', '', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante',
  'soixante', 'quatre-vingt', 'quatre-vingt'];

function dizerUnites(n) {
  if (n < 20) return UNITES[n];
  const d = Math.floor(n / 10), u = n % 10;
  if (d === 7) return u === 1 ? 'soixante et onze' : 'soixante-' + UNITES[10 + u];
  if (d === 9) return 'quatre-vingt-' + UNITES[10 + u];
  if (d === 8) return u === 0 ? 'quatre-vingts' : 'quatre-vingt-' + UNITES[u];
  if (u === 0) return DIZAINES[d];
  if (u === 1 && d !== 8) return DIZAINES[d] + ' et un';
  return DIZAINES[d] + '-' + UNITES[u];
}

function centaines(n) {
  if (n === 0) return '';
  const c = Math.floor(n / 100), r = n % 100;
  let s = '';
  if (c === 1) { s = 'cent'; }
  else if (c > 1) { s = UNITES[c] + ' cent'; if (r === 0) s += 's'; }
  if (r > 0) { if (c > 0) s += ' '; s += dizerUnites(r); }
  return s;
}

function nombreEnLettres(n) {
  if (n === 0) return 'zéro';
  if (n < 0)  return 'moins ' + nombreEnLettres(-n);
  let res = '';
  const milliards = Math.floor(n / 1e9); n %= 1e9;
  if (milliards > 0) res += centaines(milliards) + ' milliard' + (milliards > 1 ? 's' : '') + ' ';
  const millions = Math.floor(n / 1e6); n %= 1e6;
  if (millions > 0) res += centaines(millions) + ' million' + (millions > 1 ? 's' : '') + ' ';
  const milliers = Math.floor(n / 1000); n %= 1000;
  if (milliers > 0) res += (milliers === 1 ? 'mille' : centaines(milliers) + ' mille') + ' ';
  if (n > 0) res += centaines(n);
  return res.trim();
}

function updateLettres() {
  const chiffresInput = $id('montant-chiffres');
  const millimesInput = $id('montant-millimes');
  const lettresInput  = $id('montant-lettres');
  if (!lettresInput) return;

  const rawDT = chiffresInput ? chiffresInput.value.replace(/[^0-9]/g, '') : '';
  const rawMM = millimesInput ? millimesInput.value.replace(/[^0-9]/g, '').padEnd(3,'0').slice(0,3) : '';
  const dt = parseInt(rawDT) || 0;
  const mm = parseInt(rawMM) || 0;

  if (dt === 0 && mm === 0) { lettresInput.value = ''; return; }

  let lettres = '';
  if (dt > 0) lettres += nombreEnLettres(dt) + ' dinar' + (dt > 1 ? 's' : '');
  if (mm > 0) {
    if (dt > 0) lettres += ' et ';
    lettres += nombreEnLettres(mm) + ' millime' + (mm > 1 ? 's' : '');
  }
  lettresInput.value = lettres.charAt(0).toUpperCase() + lettres.slice(1);

  // Auto-sélection niveau d'alerte selon montant DT
  autoSelectNiveau(dt);
  updateProgressBar();
}

// ─── FIX : millimes — suppression de l'inline handler ────
function onMillimesInput(el) {
  el.value = el.value.replace(/[^0-9]/g, '').slice(0, 3);
  updateLettres();
}

// ═══════════════════════════════════════════════════════════
// AUTO-SÉLECTION NIVEAU D'ALERTE
// Seuils BCT / Contrôle Permanent standard :
//   Niveau 1 : < 20 DT
//   Niveau 2 : 20 ≤ x < 200 DT
//   Niveau 3 : 200 ≤ x ≤ 1 000 DT
//   Niveau 4 : > 1 000 DT  |  Récidive
// ═══════════════════════════════════════════════════════════
function autoSelectNiveau(montantDT) {
  let niv = 0;
  if (montantDT > 0    && montantDT < 20)    niv = 1;
  else if (montantDT >= 20  && montantDT < 200)   niv = 2;
  else if (montantDT >= 200 && montantDT <= 1000)  niv = 3;
  else if (montantDT > 1000)                       niv = 4;

  if (niv === 0) return;
  const radio = $id('niveau' + niv);
  if (radio && !radio.checked) {
    radio.checked = true;
    updateLevelCards();
  }
}

function updateLevelCards() {
  for (let i = 1; i <= 4; i++) {
    const card  = $id('lv-card-' + i);
    const radio = $id('niveau' + i);
    if (card && radio) card.classList.toggle('active', radio.checked);
  }
}

// ═══════════════════════════════════════════════════════════
// LISTE DES AGENCES (données de référence)
// ═══════════════════════════════════════════════════════════
const AGENCES = [
  { code: "000", nom: "AV.H.THAMEUR TUNIS" },
  { code: "001", nom: "R.AL JAZIRA TUNIS" },
  { code: "002", nom: "SOUSSE" },
  { code: "003", nom: "MAHDIA" },
  { code: "004", nom: "AV.H.CHAKER SFAX" },
  { code: "005", nom: "TUNIS PORT" },
  { code: "006", nom: "DAR CHAABANE ELFEHRI" },
  { code: "007", nom: "GABES" },
  { code: "008", nom: "BEJA" },
  { code: "009", nom: "KAIROUAN" },
  { code: "010", nom: "LE KEF" },
  { code: "011", nom: "BIZERTE" },
  { code: "012", nom: "TEBOURBA" },
  { code: "013", nom: "GROMBALIA" },
  { code: "014", nom: "RADES" },
  { code: "015", nom: "MENZEL BOURGUIBA" },
  { code: "016", nom: "JENDOUBA" },
  { code: "017", nom: "MONASTIR" },
  { code: "018", nom: "MOKNINE" },
  { code: "019", nom: "KSAR HELLAL" },
  { code: "020", nom: "ZARZIS" },
  { code: "021", nom: "GAFSA" },
  { code: "022", nom: "MANAR III" },
  { code: "023", nom: "KASSERINE" },
  { code: "025", nom: "JERBA" },
  { code: "026", nom: "HAJEB EL AYOUN" },
  { code: "027", nom: "EL OUARDANINE" },
  { code: "028", nom: "MEDENINE" },
  { code: "029", nom: "HAMMAMET" },
  { code: "030", nom: "BEN GARDANE" },
  { code: "031", nom: "NABEUL" },
  { code: "032", nom: "KORBA" },
  { code: "033", nom: "KELIBIA" },
  { code: "034", nom: "BAB SOUIKA" },
  { code: "035", nom: "R.K.PACHA TUNIS" },
  { code: "036", nom: "MEDINA TUNIS" },
  { code: "037", nom: "CITE MAHRAJ.MENZAH" },
  { code: "038", nom: "SFAX ZITOUNA" },
  { code: "039", nom: "SFAX HACHED" },
  { code: "040", nom: "M SAKEN" },
  { code: "041", nom: "EL-JEM" },
  { code: "042", nom: "JEMMAL" },
  { code: "043", nom: "PL.VICTOIRE TUNIS" },
  { code: "044", nom: "SIDI BOUZID" },
  { code: "045", nom: "AV.DE FRANCE TUNIS" },
  { code: "046", nom: "LE KEF II" },
  { code: "047", nom: "SFAX MENZEL CHAKER" },
  { code: "048", nom: "TATAOUINE" },
  { code: "049", nom: "MENZEL TEMIME" },
  { code: "050", nom: "METLAOUI" },
  { code: "051", nom: "KALAA KEBIRA" },
  { code: "052", nom: "CITE EZZOUHOUR" },
  { code: "053", nom: "CHEBBA" },
  { code: "054", nom: "ZAGHOUAN" },
  { code: "055", nom: "EL FAHS" },
  { code: "056", nom: "ARIANA" },
  { code: "057", nom: "CITE OLYMPIQUE" },
  { code: "058", nom: "HOUMET SOUK JERBA" },
  { code: "059", nom: "AV.J.JAURES TUNIS" },
  { code: "060", nom: "GARE TUNIS" },
  { code: "061", nom: "SILIANA" },
  { code: "062", nom: "R.PALESTINE TUNIS" },
  { code: "063", nom: "JEBENIANA" },
  { code: "064", nom: "SOUSSE EL KANTAOUI" },
  { code: "065", nom: "SOLIMAN" },
  { code: "066", nom: "KHAZNADAR" },
  { code: "067", nom: "AIN-DRAHAM" },
  { code: "068", nom: "SKHIRA" },
  { code: "069", nom: "SEDJENANE" },
  { code: "070", nom: "RAS JEBEL" },
  { code: "071", nom: "TABARKA" },
  { code: "072", nom: "BIZERTE MEDINA" },
  { code: "073", nom: "FERIANA" },
  { code: "074", nom: "MATEUR" },
  { code: "075", nom: "SAKIET SIDI YOUSSEF" },
  { code: "076", nom: "KALAAT SENANE" },
  { code: "077", nom: "EL MANAR" },
  { code: "078", nom: "MONASTIR II" },
  { code: "079", nom: "TROCADERO (SOUSSE NR)" },
  { code: "080", nom: "ENFIDHA" },
  { code: "081", nom: "CITE ETTADHAMEN" },
  { code: "082", nom: "FOUCHANA" },
  { code: "083", nom: "JELMA" },
  { code: "084", nom: "BOUSALEM" },
  { code: "085", nom: "HAOUARIA" },
  { code: "086", nom: "KSIBET EL MEDIOUNI" },
  { code: "087", nom: "BEN AROUS" },
  { code: "088", nom: "SFAX MOULINVILLE" },
  { code: "089", nom: "SOUSSE REPUBLIQUE" },
  { code: "100", nom: "AGENCE CENTRALE A. MATHARI" },
  { code: "101", nom: "KEBILI" },
  { code: "102", nom: "JERBA MIDOUN" },
  { code: "103", nom: "MARETH" },
  { code: "104", nom: "SFAX PORT" },
  { code: "105", nom: "NABEUL II" },
  { code: "106", nom: "AKOUDA" },
  { code: "107", nom: "LA CHARGUIA" },
  { code: "108", nom: "LE BELVEDERE" },
  { code: "109", nom: "BENI KHALLED" },
  { code: "110", nom: "AEROPORT TUNIS-CARTH" },
  { code: "112", nom: "HAMMAM SOUSSE" },
  { code: "113", nom: "HAMMAMET ETTAHRIR" },
  { code: "114", nom: "SFAX JEDIDA" },
  { code: "115", nom: "GABES-CENTER" },
  { code: "116", nom: "AFRICA" },
  { code: "118", nom: "EL MOUANSA ZARZIS" },
  { code: "119", nom: "EL MOUROUJ" },
  { code: "120", nom: "DOUZ" },
  { code: "121", nom: "OUED ELLIL" },
  { code: "122", nom: "NEFZA" },
  { code: "123", nom: "MSAKEN II" },
  { code: "124", nom: "CITE DES SCIENCES" },
  { code: "125", nom: "AV. MOHAMED V" },
  { code: "126", nom: "EL HRAIRIA" },
  { code: "127", nom: "HAMMAMET SUD" },
  { code: "128", nom: "MENZEL KAMEL MOUNAS" },
  { code: "129", nom: "LA MARSA" },
  { code: "130", nom: "KERKENNAH" },
  { code: "131", nom: "LAOUINA" },
  { code: "132", nom: "SIDI ALOUENE" },
  { code: "133", nom: "AGENCE SOUSSE INES" },
  { code: "134", nom: "AGENCE MOKTHAR ATTIA" },
  { code: "135", nom: "AGENCE LAC II" },
  { code: "136", nom: "HAMMAMET MEDINA" },
  { code: "137", nom: "SFAX TYNA" },
  { code: "138", nom: "SFAX CHIHIA" },
  { code: "139", nom: "EZZAHRA" },
  { code: "140", nom: "GAFSA II" },
  { code: "141", nom: "SOUKRA" },
  { code: "142", nom: "ENNASR" },
  { code: "143", nom: "SFAX EL AFRAN" },
  { code: "144", nom: "CHENINI GABES" },
  { code: "145", nom: "BENI KHEDACHE" },
  { code: "146", nom: "REDAYEF" },
  { code: "147", nom: "BIZERTE CORNICHE" },
  { code: "148", nom: "JERBA EL MAY" },
  { code: "149", nom: "MREZGUA" },
  { code: "150", nom: "JENDOUBA NORD" },
  { code: "151", nom: "TEBOULBA" },
  { code: "152", nom: "SOUSSE ERRIADH" },
  { code: "153", nom: "RIADH EL ANDALOUS" },
  { code: "154", nom: "AGENCE KALAA EL KEBIRA" },
  { code: "155", nom: "SAKIET EDDAIER" },
  { code: "156", nom: "SBEITLA" },
  { code: "157", nom: "TESTOUR" },
  { code: "158", nom: "MANOUBA" },
  { code: "159", nom: "MGHIRA" },
  { code: "160", nom: "JERBA HOUMET SOUK 2" },
  { code: "161", nom: "SFAX POUDRIERE" },
  { code: "162", nom: "EL HAMMA" },
  { code: "163", nom: "MNIHLA" },
  { code: "164", nom: "JARDINS DE CARTHAGE" },
];

// ─── RÉGIONS (doublons corrigés — chaque agence dans une seule région) ─────
const REGIONS = {
  "Grand Tunis":        ["000","001","005","034","035","036","037","043","045","052","056","057","059","060","062","066","077","081","082","087","107","108","110","116","119","121","124","125","126","129","131","135","139","141","142","153","158","159","163","164"],
  "Nabeul / Cap Bon":   ["006","013","029","031","032","033","049","065","085","105","109","113","127","136","149"],
  "Sousse":             ["002","017","018","019","040","051","053","064","079","086","089","106","112","123","133","152","154"],
  "Sfax":               ["004","038","039","047","063","088","104","114","130","137","138","143","155","161"],
  "Gabès":              ["007","068","103","115","144","162"],
  "Mahdia":             ["003","041","151"],
  "Monastir":           ["027","042","078","128"],
  "Bizerte":            ["011","015","069","070","071","072","074","084","122","147"],
  "Kairouan":           ["009","026","083"],
  "Gafsa":              ["021","050","073","140","146"],
  "Kasserine / Le Kef": ["010","023","044","046","076","156"],
  "Médenine / Jerba":   ["020","025","028","030","048","058","101","102","118","120","145","148","160"],
  "Jendouba / Béja":    ["008","016","067","075","150","157"],
  "Siliana / Zaghouan": ["054","055","061"],
};

// Index inversé pour lookup O(1)
const AGENCE_REGION_MAP = {};
Object.entries(REGIONS).forEach(([region, codes]) => {
  codes.forEach(code => { AGENCE_REGION_MAP[code] = region; });
});

function getRegionForCode(code) {
  return AGENCE_REGION_MAP[code] || '';
}

// ─── POPULATION DES SELECTS ──────────────────────────────
function populateSelects() {
  const selCode = $id('sel-code');
  const selNom  = $id('sel-nom');
  if (!selCode || !selNom) return;

  const sortedByCode = [...AGENCES].sort((a, b) => a.code.localeCompare(b.code));
  const sortedByNom  = [...AGENCES].sort((a, b) => a.nom.localeCompare(b.nom, 'fr'));

  const fragCode = document.createDocumentFragment();
  sortedByCode.forEach(ag => {
    const opt = document.createElement('option');
    opt.value = ag.code;
    opt.textContent = ag.code + ' \u2014 ' + ag.nom;
    fragCode.appendChild(opt);
  });
  selCode.appendChild(fragCode);

  const fragNom = document.createDocumentFragment();
  sortedByNom.forEach(ag => {
    const opt = document.createElement('option');
    opt.value = ag.code;
    opt.textContent = ag.nom;
    fragNom.appendChild(opt);
  });
  selNom.appendChild(fragNom);
}

function syncAgence(source) {
  const selCode = $id('sel-code');
  const selNom  = $id('sel-nom');
  if (!selCode || !selNom) return;
  const val = source === 'code' ? selCode.value : selNom.value;

  if (!val) {
    selCode.value = '';
    selNom.value  = '';
    updateBadge(null);
    return;
  }
  const ag = AGENCES.find(a => a.code === val);
  if (!ag) return;

  selCode.value = ag.code;
  selNom.value  = ag.code;
  updateBadge(ag);

  // Auto-remplir région
  const regionInput = $id('region-input');
  if (regionInput) regionInput.value = getRegionForCode(ag.code);

  // Enrichir le N° déclaration avec le code agence
  updateRefWithAgence(ag.code);
  updateProgressBar();
}

function updateBadge(ag) {
  let badge = $id('agence-badge');
  if (!badge) {
    badge = document.createElement('div');
    badge.id = 'agence-badge';
    badge.className = 'agence-badge';
    $id('sel-nom').closest('.row').insertAdjacentElement('afterend', badge);
  }
  if (!ag) { badge.classList.remove('visible'); return; }
  badge.innerHTML = '<span class="badge-code">' + ag.code + '</span> ' + ag.nom +
    ' <span style="opacity:0.5;margin-left:6px;font-weight:400;">&#10003; Sélectionnée</span>';
  badge.classList.add('visible');
}

// Enrichir le N° déclaration avec le code agence pour garantir l'unicité
function updateRefWithAgence(codeAgence) {
  const refEl = $id('ref-declaration');
  if (!refEl) return;
  const current = refEl.textContent;
  if (!current || current.includes('en attente')) return;
  const parts = current.split('-AG');
  refEl.textContent = parts[0] + '-AG' + codeAgence;
}

// ─── TOAST NOTIFICATION — FIX: innerHTML pour les sauts de ligne ──
function showToast(msg, type = 'error') {
  const toast = $id('toast');
  if (!toast) return;
  // Convertir \n en <br> pour l'affichage HTML
  toast.innerHTML = msg.replace(/\n/g, '<br>');
  toast.className = 'toast ' + (type === 'success' ? 'success' : '') + ' visible';
  clearTimeout(toast._hideTimer);
  toast._hideTimer = setTimeout(() => { toast.classList.remove('visible'); }, 5000);
}

// ─── VALIDATION COMPLÈTE ─────────────────────────────────
function validerFormulaire() {
  const erreurs = [];

  // Enlever les styles d'erreur précédents
  document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

  // Niveau d'alerte
  if (!document.querySelector('input[name="niveau"]:checked')) {
    erreurs.push('Niveau d\'alerte non sélectionné.');
  }

  // Section 1 : Agence
  const selCode = $id('sel-code');
  if (!selCode || !selCode.value) {
    erreurs.push('Code Agence obligatoire (Section 1).');
    if (selCode) selCode.classList.add('error');
  }

  // Section 2 : Caissier
  const matricule   = $id('caissier-matricule');
  const nomCaissier = $id('caissier-nom');
  if (!matricule || !matricule.value.trim()) {
    erreurs.push('Matricule du caissier obligatoire (Section 2).');
    if (matricule) matricule.classList.add('error');
  }
  if (!nomCaissier.value.trim()) {
    erreurs.push('Nom et Prénom du caissier obligatoires (Section 2).');
    nomCaissier.classList.add('error');
  }
  if (!document.querySelector('input[name="fonction"]:checked')) {
    erreurs.push('Fonction exercée non sélectionnée (Section 2).');
  }

  // Section 3 : Écart
  const dateJ = $id('date-jour');
  const dateM = $id('date-mois');
  const dateA = $id('date-annee');
  if (!dateJ.value || !dateM.value || !dateA.value) {
    erreurs.push('Date du constat incomplète (Section 3).');
    [dateJ, dateM, dateA].forEach(el => { if (!el.value) el.style.borderColor = 'var(--red)'; });
  } else {
    // Validation stricte : utiliser Date object pour détecter les dates invalides (ex: 31 février)
    const j = parseInt(dateJ.value, 10), m = parseInt(dateM.value, 10), a = parseInt(dateA.value, 10);
    const testDate = new Date(a, m - 1, j);
    const aujourdhui = new Date(); aujourdhui.setHours(23, 59, 59, 999);
    if (
      isNaN(testDate.getTime()) ||
      testDate.getDate() !== j ||
      testDate.getMonth() !== m - 1 ||
      testDate.getFullYear() !== a ||
      a < 2000 || a > 2099
    ) {
      erreurs.push('Date du constat invalide (vérifier jour/mois/année) — Section 3.');
      [dateJ, dateM, dateA].forEach(el => el.style.borderColor = 'var(--red)');
    } else if (testDate > aujourdhui) {
      erreurs.push('La date du constat ne peut pas être dans le futur — Section 3.');
      [dateJ, dateM, dateA].forEach(el => el.style.borderColor = 'var(--red)');
    }
  }
  const heureHH = $id('heure-hh');
  const heureMM = $id('heure-mm');
  if (!heureHH.value || !heureMM.value) {
    erreurs.push('Heure du constat incomplète (Section 3).');
  } else {
    const hh = parseInt(heureHH.value, 10), mm = parseInt(heureMM.value, 10);
    if (hh > 23 || mm > 59) erreurs.push("Heure du constat invalide (HH ≤ 23, MM ≤ 59) — Section 3.");
  }

  const montant = $id('montant-chiffres');
  const rawMnt  = montant ? montant.value.replace(/[^0-9]/g, '') : '';
  if (!rawMnt || parseInt(rawMnt) === 0) {
    erreurs.push('Montant de l\'écart obligatoire et doit être > 0 (Section 3).');
    if (montant) montant.classList.add('error');
  }
  if (!document.querySelector('input[name="nature"]:checked')) {
    erreurs.push('Nature de l\'écart (Manquant / Excédent) non sélectionnée (Section 3).');
  }
  if (!document.querySelector('input[name="type_caisse"]:checked')) {
    erreurs.push('Type de caisse non sélectionné (Section 3).');
  }

  // Section 4 : Circonstances
  const declCaissier = $id('declaration-caissier');
  const obsSup = $id('observations-superviseur');
  if (!declCaissier.value.trim()) {
    erreurs.push('Déclaration du caissier obligatoire (Section 4-A).');
    declCaissier.classList.add('error');
  }
  if (!obsSup.value.trim()) {
    erreurs.push('Observations du superviseur obligatoires (Section 4-B).');
    obsSup.classList.add('error');
  }
  if (!document.querySelector('input[name="cause"]:checked')) {
    erreurs.push('Au moins une cause probable doit être cochée (Section 4).');
  }

  if (erreurs.length > 0) {
    showToast('⚠ ' + erreurs.length + ' erreur(s) :\n• ' + erreurs.slice(0,3).join('\n• ') + (erreurs.length > 3 ? '\n• ... et ' + (erreurs.length - 3) + ' autre(s).' : ''), 'error');
    const firstError = document.querySelector('.error');
    if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return false;
  }

  // ─── ENREGISTREMENT LOCAL ─────────────────────────────────
  const ref = $id('ref-declaration').textContent;
  const declaration = collecterDonnees(ref);
  enregistrerDeclaration(ref, declaration);

  // ─── OUVRIR MODAL ENVOI ───────────────────────────────────
  ouvrirModalEnvoi(ref, declaration);
  return true;
}

// ─── COLLECTE DES DONNÉES DU FORMULAIRE ──────────────────
function collecterDonnees(ref) {
  const selCode = $id('sel-code');
  const agCode  = selCode ? selCode.value : '';
  const ag      = AGENCES.find(a => a.code === agCode) || {};

  return {
    ref,
    horodatage: new Date().toISOString(),
    agence:   { code: agCode, nom: ag.nom || '', region: $val('region-input') },
    caissier: {
      matricule: $val('caissier-matricule'), nom: $val('caissier-nom'),
      grade: $val('caissier-grade'), fonction: $radio('fonction'),
      fonctionAutre: $val('fonction-autre')
    },
    ecart: {
      dateJour: $val('date-jour'), dateMois: $val('date-mois'), dateAnnee: $val('date-annee'),
      heureHH: $val('heure-hh'), heureMM: $val('heure-mm'),
      arreteHH: $val('arrete-hh'), arreteMM: $val('arrete-mm'),
      montantDT: $val('montant-chiffres'), montantMM: $val('montant-millimes'),
      montantLettres: $val('montant-lettres'),
      nature: $radio('nature'), typeCaisse: $radio('type_caisse'), caisseAutre: $val('caisse-autre'),
    },
    niveau: $radio('niveau'),
    circonstances: {
      declarationCaissier: $val('declaration-caissier'),
      observationsSup: $val('observations-superviseur'),
      causes: $checks('cause')
    },
    mesures: { actions: $checks('mesure'), autres: $val('autres-mesures') },
    recidive: { oui: $radio('recidive') === 'OUI', nbEcarts: $val('nb-ecarts') },
    signatures: {
      caissier:    { nom: $val('sig-caissier-nom'), mat: $val('sig-caissier-mat'), date: $val('sig-caissier-date') },
      superviseur: { nom: $val('sig-sup-nom'),      mat: $val('sig-sup-mat'),      date: $val('sig-sup-date')      },
      directeur:   { nom: $val('sig-dir-nom'),      date: $val('sig-dir-date'),    delai: $radio('delai')          },
    },
    // FIX : inclure les champs CP Central (IDs ajoutés en v3)
    cpCentral: {
      recuLe:    $val('cp-recu-le'),
      traitePar: $val('cp-traite-par'),
      nDossier:  $val('cp-ndossier'),
      statut:    $val('cp-statut'),
    }
  };
}

// ─── ENREGISTREMENT LOCAL (localStorage) ─────────────────
function enregistrerDeclaration(ref, data) {
  try {
    const key = 'bq_declarations';
    const declarations = JSON.parse(localStorage.getItem(key) || '{}');
    declarations[ref] = data;
    localStorage.setItem(key, JSON.stringify(declarations));
    console.info('[BQ-CP] Déclaration enregistrée :', ref);
  } catch(e) {
    console.warn('[BQ-CP] Enregistrement localStorage impossible :', e);
  }
}

// ─── OUVRIR MODAL ENVOI ───────────────────────────────────
function ouvrirModalEnvoi(ref, data) {
  document.getElementById('modal-ref-num').textContent = ref;
  document.getElementById('modal-agence').textContent  = data.agence.code + ' — ' + (data.agence.nom || '');
  document.getElementById('modal-montant').textContent = (data.ecart.montantDT || '0') + ',' + (data.ecart.montantMM || '000') + ' DT';
  document.getElementById('modal-nature').textContent  = data.ecart.nature || '—';
  document.getElementById('modal-niveau').textContent  = data.niveau ? 'Niveau ' + data.niveau : '—';

  const date = data.ecart.dateJour + '/' + data.ecart.dateMois + '/' + data.ecart.dateAnnee;
  document.getElementById('mail-objet').value =
    '[BQ-CP] Déclaration Différence de Caisse — Agence ' + data.agence.code +
    ' ' + (data.agence.nom || '') + ' — ' + date + ' — Réf. ' + ref;

  const status = document.getElementById('modal-send-status');
  status.className = 'modal-send-status';
  status.innerHTML = '';
  document.getElementById('btn-envoyer-mail').disabled = false;
  document.getElementById('btn-envoyer-mail').innerHTML = '✉ Envoyer par mail';

  document.getElementById('modal-envoi').classList.add('visible');
}

// ─── ENVOI MAIL (mailto fallback — remplacer par API backend en production) ──
function envoyerMail() {
  const to     = document.getElementById('mail-to').value.trim();
  const objet  = document.getElementById('mail-objet').value.trim();
  const msg    = document.getElementById('mail-message').value.trim();
  const status = document.getElementById('modal-send-status');

  if (!to) {
    status.className = 'modal-send-status failed';
    status.innerHTML = '✗ Veuillez saisir l\'adresse du destinataire principal (Contrôle Permanent).';
    return;
  }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(to)) {
    status.className = 'modal-send-status failed';
    status.innerHTML = '✗ Adresse email invalide.';
    return;
  }

  const ccInputs = document.querySelectorAll('#cc-list .cc-row input');
  const cc = Array.from(ccInputs).map(el => el.value.trim()).filter(v => v && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v));

  status.className = 'modal-send-status sending';
  status.innerHTML = '<div class="spinner"></div>&nbsp;Envoi en cours…';

  const ref  = document.getElementById('ref-declaration').textContent;
  const data = collecterDonnees(ref);
  const corps = buildCorpsMail(data);

  // Simulation délai réseau (remplacer par fetch() en production)
  setTimeout(function() {
    try {
      const ccParam   = cc.length ? '&cc=' + encodeURIComponent(cc.join(',')) : '';
      const bodyTxt   = corps + (msg ? '\n\n---\n' + msg : '');
      const mailtoUrl = 'mailto:' + encodeURIComponent(to) + '?subject=' + encodeURIComponent(objet) + ccParam + '&body=' + encodeURIComponent(bodyTxt);
      window.open(mailtoUrl, '_self');

      status.className = 'modal-send-status sent';
      status.innerHTML = '✓ Transmission initiée vers ' + to + (cc.length ? ' (+ ' + cc.length + ' CC)' : '') + '. Vérifiez votre client mail.';
      document.getElementById('btn-envoyer-mail').disabled = true;
      document.getElementById('btn-envoyer-mail').innerHTML = '✓ Envoyé';
    } catch(e) {
      status.className = 'modal-send-status failed';
      status.innerHTML = '✗ Erreur lors de l\'envoi. Réessayez ou contactez le support.';
    }
  }, 1200);
}

// ─── CONSTRUCTION DU CORPS DU MAIL — COMPLET ─────────────
function buildCorpsMail(data) {
  const date  = data.ecart.dateJour + '/' + data.ecart.dateMois + '/' + data.ecart.dateAnnee;
  const heure = data.ecart.heureHH + ':' + data.ecart.heureMM;
  return [
    '═══════════════════════════════════════════════════════════',
    'DÉCLARATION DE DIFFÉRENCE DE CAISSE — BQ-CP-CAI-001 v3',
    '═══════════════════════════════════════════════════════════',
    'Référence       : ' + data.ref,
    'Date / Heure    : ' + date + ' à ' + heure,
    "Niveau d'alerte : Niveau " + (data.niveau || '—'),
    '',
    '── AGENCE ──────────────────────────────────────────────────',
    'Code            : ' + (data.agence.code   || '—'),
    'Désignation     : ' + (data.agence.nom    || '—'),
    'Région          : ' + (data.agence.region || '—'),
    '',
    '── CAISSIER ────────────────────────────────────────────────',
    'Matricule       : ' + (data.caissier.matricule || '—'),
    'Nom & Prénom    : ' + (data.caissier.nom       || '—'),
    'Fonction        : ' + (data.caissier.fonction  || '—'),
    '',
    '── ÉCART ───────────────────────────────────────────────────',
    'Montant         : ' + (data.ecart.montantDT || '0') + ',' + (data.ecart.montantMM || '000') + ' DT',
    'En lettres      : ' + (data.ecart.montantLettres || '—'),
    'Nature          : ' + (data.ecart.nature      || '—'),
    'Type de caisse  : ' + (data.ecart.typeCaisse  || '—'),
    '',
    '── CIRCONSTANCES ───────────────────────────────────────────',
    "Déclaration caissier :",
    data.circonstances.declarationCaissier || '—',
    '',
    'Observations superviseur :',
    data.circonstances.observationsSup || '—',
    '',
    'Cause(s) probable(s) : ' + (data.circonstances.causes.join(', ') || '—'),
    '',
    '── MESURES IMMÉDIATES ──────────────────────────────────────',
    (data.mesures.actions.join(' | ') || '—'),
    data.mesures.autres ? 'Autres : ' + data.mesures.autres : '',
    '',
    '── RÉCIDIVE ────────────────────────────────────────────────',
    'Antécédents 30 jours : ' + (data.recidive.oui ? 'OUI (' + (data.recidive.nbEcarts || '?') + " écart(s))" : 'NON'),
    '',
    '── SIGNATURES ──────────────────────────────────────────────',
    'Caissier        : ' + (data.signatures.caissier.nom || '—') + ' | Mat. ' + (data.signatures.caissier.mat || '—') + ' | Date : ' + (data.signatures.caissier.date || '—'),
    'Superviseur     : ' + (data.signatures.superviseur.nom || '—') + ' | Mat. ' + (data.signatures.superviseur.mat || '—') + ' | Date : ' + (data.signatures.superviseur.date || '—'),
    'Directeur       : ' + (data.signatures.directeur.nom || '—') + ' | Date : ' + (data.signatures.directeur.date || '—') + ' | Délai respecté : ' + (data.signatures.directeur.delai || '—'),
    '',
    '═══════════════════════════════════════════════════════════',
    'Document généré automatiquement — Usage interne confidentiel',
    'Direction du Contrôle Permanent | Conservation réglementaire 10 ans',
    '═══════════════════════════════════════════════════════════',
  ].join('\n');
}

// ─── RÉINITIALISATION COMPLÈTE — FIX v3 ──────────────────
function resetFormulaire() {
  if (!confirm('Confirmer la réinitialisation complète du formulaire ?')) return;

  // Réinitialiser TOUS les inputs, selects, textareas (sans exclusion du radio "delai")
  document.querySelectorAll('input, textarea, select').forEach(el => {
    if (el.type === 'radio' || el.type === 'checkbox') el.checked = false;
    else if (el.tagName === 'SELECT') el.selectedIndex = 0;
    else el.value = '';
    el.classList.remove('error', 'valid');
    el.style.borderColor = '';
  });

  // Réinitialiser les cards de niveau d'alerte
  document.querySelectorAll('.level-card').forEach(c => {
    c.style.transform = '';
    c.style.boxShadow = '';
    c.classList.remove('active');
  });

  // Cacher le badge agence (FIX v3)
  updateBadge(null);

  // Cacher le bloc de récidive
  const rcBlock = $id('recidive-count-block');
  if (rcBlock) rcBlock.classList.remove('visible');

  // Réinitialiser les champs readonly de signature (Section 7)
  const sigNom = $id('sig-caissier-nom');
  const sigMat = $id('sig-caissier-mat');
  if (sigNom) sigNom.value = '';
  if (sigMat) sigMat.value = '';

  // Regénérer un nouveau N° de déclaration
  const newRef = genRefDeclaration();
  const refEl = $id('ref-declaration');
  if (refEl) refEl.textContent = newRef;

  // Réinitialiser la date du jour
  initDateJour();

  // Réinitialiser barre de progression
  updateProgressBar();

  // Réinitialiser indicateur autosave
  setAutosaveStatus('neutral');

  showToast('✓ Formulaire réinitialisé avec succès.', 'success');
}

// ─── PRÉ-REMPLISSAGE DATE DU JOUR — utilise pad() centralisé ─
function initDateJour() {
  const now = new Date();
  const el = {
    j: $id('date-jour'),
    m: $id('date-mois'),
    a: $id('date-annee')
  };
  const heure = {
    h: $id('heure-hh'),
    m: $id('heure-mm')
  };
  if (el.j) el.j.value = pad(now.getDate());
  if (el.m) el.m.value = pad(now.getMonth() + 1);
  if (el.a) el.a.value = now.getFullYear();
  if (heure.h) heure.h.value = pad(now.getHours());
  if (heure.m) heure.m.value = pad(now.getMinutes());
}

// ─── GÉNÉRATION N° DÉCLARATION — avec suffixe aléatoire anti-collision ──
function genRefDeclaration() {
  const now = new Date();
  const yy = now.getFullYear();
  const mm = pad(now.getMonth() + 1);
  const dd = pad(now.getDate());
  const hh = pad(now.getHours());
  const mi = pad(now.getMinutes());
  const ss = pad(now.getSeconds());
  // Suffixe aléatoire 3 chars pour éviter les collisions si 2 déclarations simultanées
  const sfx = Math.random().toString(36).slice(2, 5).toUpperCase();
  return 'DC-' + yy + mm + dd + '-' + hh + mi + ss + '-' + sfx;
}

// ─── NAVIGATION AUTO ENTRE CHAMPS DATE ───────────────────
function setupDateNavigation() {
  document.querySelectorAll('.date-part input, .time-row .date-part input').forEach(inp => {
    inp.addEventListener('input', function() {
      // Filtrer uniquement les chiffres
      this.value = this.value.replace(/[^0-9]/g, '');
      // Avancer vers le champ suivant quand rempli
      if (this.value.length >= parseInt(this.maxLength)) {
        // Chercher le prochain input dans le même groupe date/time
        const allInputs = Array.from(this.closest('.date-row, .time-row').querySelectorAll('input'));
        const idx = allInputs.indexOf(this);
        if (idx !== -1 && idx < allInputs.length - 1) {
          allInputs[idx + 1].focus();
          allInputs[idx + 1].select();
        }
      }
    });
  });
}

// ═══════════════════════════════════════════════════════════
// BARRE DE PROGRESSION — calcul du taux de complétion
// ═══════════════════════════════════════════════════════════
function updateProgressBar() {
  const champs = [
    // §1 Agence
    () => !!($id('sel-code') && $id('sel-code').value),
    // §2 Caissier
    () => !!$val('caissier-matricule'),
    () => !!$val('caissier-nom'),
    () => !!document.querySelector('input[name="fonction"]:checked'),
    // §3 Écart
    () => !!($val('date-jour') && $val('date-mois') && $val('date-annee')),
    () => !!($val('heure-hh') && $val('heure-mm')),
    () => !!($val('montant-chiffres') && $val('montant-chiffres').replace(/[^0-9]/g,'') !== '0'),
    () => !!document.querySelector('input[name="nature"]:checked'),
    () => !!document.querySelector('input[name="type_caisse"]:checked'),
    // §4 Circonstances
    () => !!$val('declaration-caissier'),
    () => !!$val('observations-superviseur'),
    () => !!document.querySelector('input[name="cause"]:checked'),
    // §5 Mesures
    () => !!document.querySelector('input[name="mesure"]:checked'),
    // §6 Récidive
    () => !!document.querySelector('input[name="recidive"]:checked'),
    // §7 Signatures
    () => !!$val('sig-caissier-date'),
    () => !!$val('sig-sup-nom'),
    () => !!$val('sig-dir-nom'),
    // Niveau
    () => !!document.querySelector('input[name="niveau"]:checked'),
  ];
  const remplis = champs.filter(fn => { try { return fn(); } catch(e) { return false; } }).length;
  const pct = Math.round((remplis / champs.length) * 100);

  const fill  = $id('progress-fill');
  const label = $id('progress-label');
  if (fill)  fill.style.width = pct + '%';
  if (label) label.textContent = pct + ' %';
}

// ═══════════════════════════════════════════════════════════
// AUTO-SAVE BROUILLON (localStorage)
// ═══════════════════════════════════════════════════════════
let _autoSaveTimer = null;

function setAutosaveStatus(state) {
  const dot   = $id('autosave-dot');
  const label = $id('autosave-label');
  if (!dot || !label) return;
  dot.className = 'autosave-dot' + (state === 'saving' ? ' saving' : state === 'saved' ? ' saved' : '');
  label.textContent = state === 'saving' ? 'Sauvegarde…' : state === 'saved' ? 'Brouillon sauvegardé' : 'Brouillon non sauvegardé';
}

function autoSaveBrouillon() {
  clearTimeout(_autoSaveTimer);
  setAutosaveStatus('saving');
  _autoSaveTimer = setTimeout(() => {
    try {
      const ref = $id('ref-declaration') ? $id('ref-declaration').textContent : 'brouillon';
      const data = collecterDonnees(ref);
      localStorage.setItem('bq_brouillon', JSON.stringify({ ts: Date.now(), data }));
      setAutosaveStatus('saved');
    } catch(e) {
      setAutosaveStatus('neutral');
    }
  }, 1200);
}

// ─── INIT PRINCIPALE ─────────────────────────────────────
document.addEventListener('DOMContentLoaded', function() {

  // Génération du N° de déclaration
  const ref = genRefDeclaration();
  const refEl = $id('ref-declaration');
  if (refEl) refEl.textContent = ref;

  // Date de création affichée
  const now = new Date();
  const refDate = $id('ref-date');
  if (refDate) refDate.textContent = pad(now.getDate()) + '/' + pad(now.getMonth()+1) + '/' + now.getFullYear() + ' — ' + pad(now.getHours()) + ':' + pad(now.getMinutes());

  // Pré-remplissage date (utilise pad() centralisé)
  initDateJour();

  // Sélects agences
  populateSelects();

  // Navigation date/heure
  setupDateNavigation();

  // Millimes — addEventListener (suppression inline handler)
  const millimesInput = $id('montant-millimes');
  if (millimesInput) {
    millimesInput.addEventListener('input', function() { onMillimesInput(this); });
  }

  // Niveaux d'alerte — mise à jour visuelle
  document.querySelectorAll('.level-card input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', () => { updateLevelCards(); updateProgressBar(); autoSaveBrouillon(); });
  });

  // Montant — formatage + auto-niveau
  const mntInput = $id('montant-chiffres');
  if (mntInput) {
    mntInput.addEventListener('input', function() {
      const v = this.value.replace(/[^0-9]/g, '');
      this.value = v ? parseInt(v).toLocaleString('fr-TN') : '';
      updateLettres();
      autoSaveBrouillon();
    });
  }

  // Récidive — afficher/masquer le compteur + forcer N4
  document.querySelectorAll('input[name="recidive"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const block = $id('recidive-count-block');
      if (block) block.classList.toggle('visible', this.value === 'OUI');
      if (this.value === 'OUI') {
        const r4 = $id('niveau4');
        if (r4) { r4.checked = true; updateLevelCards(); }
      }
      updateProgressBar();
      autoSaveBrouillon();
    });
  });

  // Auto-remplissage signature caissier (Section 2 → Section 7)
  const caissierNom = $id('caissier-nom');
  const caissierMat = $id('caissier-matricule');
  const sigNom      = $id('sig-caissier-nom');
  const sigMat      = $id('sig-caissier-mat');

  if (caissierNom && sigNom) {
    caissierNom.addEventListener('input', () => { sigNom.value = caissierNom.value; autoSaveBrouillon(); });
  }
  if (caissierMat && sigMat) {
    caissierMat.addEventListener('input', () => { sigMat.value = caissierMat.value; autoSaveBrouillon(); });
  }

  // Champs readonly Section 7
  if (sigNom) {
    sigNom.readOnly = true;
    Object.assign(sigNom.style, { background: '#EBF3FB', color: 'var(--navy)', fontWeight: '600' });
    sigNom.title = 'Repris automatiquement de la Section 2';
  }
  if (sigMat) {
    sigMat.readOnly = true;
    Object.assign(sigMat.style, { background: '#EBF3FB', color: 'var(--navy)', fontWeight: '600', fontFamily: 'var(--mono)' });
    sigMat.title = 'Repris automatiquement de la Section 2';
  }

  // Auto-save sur tous les champs texte / select / checkbox (générique)
  document.querySelectorAll('input:not([type="radio"]):not([type="checkbox"]), textarea, select').forEach(el => {
    el.addEventListener('change', () => { updateProgressBar(); autoSaveBrouillon(); });
    el.addEventListener('input',  () => { updateProgressBar(); });
  });
  document.querySelectorAll('input[type="checkbox"]').forEach(el => {
    el.addEventListener('change', () => { updateProgressBar(); autoSaveBrouillon(); });
  });

  // Bouton Réinitialiser
  const btnReset = $id('btn-reset');
  if (btnReset) btnReset.addEventListener('click', resetFormulaire);

  // Bouton Valider → enregistrement + modal envoi
  const btnValider = $id('btn-valider');
  if (btnValider) btnValider.addEventListener('click', validerFormulaire);

  // ─── MODAL : boutons ──────────────────────────────────────
  const btnFermer = $id('btn-modal-fermer');
  if (btnFermer) btnFermer.addEventListener('click', function() {
    $id('modal-envoi').classList.remove('visible');
  });

  const modalEnvoi = $id('modal-envoi');
  if (modalEnvoi) modalEnvoi.addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('visible');
  });

  const btnEnvMail = $id('btn-envoyer-mail');
  if (btnEnvMail) btnEnvMail.addEventListener('click', envoyerMail);

  const btnAddCC = $id('btn-add-cc');
  if (btnAddCC) btnAddCC.addEventListener('click', function() {
    const list = $id('cc-list');
    const row  = document.createElement('div');
    row.className = 'cc-row';
    row.innerHTML = '<input type="email" placeholder="adresse@banque.tn"><button class="btn-del-cc" title="Supprimer" type="button">×</button>';
    row.querySelector('.btn-del-cc').addEventListener('click', () => row.remove());
    list.appendChild(row);
    row.querySelector('input').focus();
  });

  // Initialiser barre de progression
  updateProgressBar();
});

</script>
</body>
</html>
